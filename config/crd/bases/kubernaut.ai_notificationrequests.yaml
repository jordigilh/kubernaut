---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: notificationrequests.kubernaut.ai
spec:
  group: kubernaut.ai
  names:
    kind: NotificationRequest
    listKind: NotificationRequestList
    plural: notificationrequests
    shortNames:
    - notif
    - notifs
    singular: notificationrequest
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.type
      name: Type
      type: string
    - jsonPath: .spec.priority
      name: Priority
      type: string
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.totalAttempts
      name: Attempts
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: NotificationRequest is the Schema for the notificationrequests
          API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              NotificationRequestSpec defines the desired state of NotificationRequest

              DD-NOT-005: Spec Immutability
              ALL spec fields are immutable after CRD creation. Users cannot update
              notification content once created. To change a notification, delete
              and recreate the CRD.

              Rationale: Notifications are immutable events, not mutable resources.
              This prevents race conditions, simplifies controller logic, and provides
              perfect audit trail.

              Cancellation: Delete the NotificationRequest CRD to cancel delivery.
            properties:
              actionLinks:
                description: Action links to external services
                items:
                  description: ActionLink represents an external service action link
                  properties:
                    label:
                      description: Human-readable label for the link
                      type: string
                    service:
                      description: Service name (github, grafana, prometheus, kubernetes-dashboard,
                        etc.)
                      type: string
                    url:
                      description: Action link URL
                      type: string
                  required:
                  - label
                  - service
                  - url
                  type: object
                type: array
              body:
                description: Notification body content
                minLength: 1
                type: string
              channels:
                description: |-
                  Delivery channels to use.
                  Optional: If not specified, Notification Service routing rules (BR-NOT-065)
                  will determine channels based on CRD labels (type, severity, environment, namespace).
                  If specified, these channels are used in addition to routing rule matches.
                items:
                  enum:
                  - email
                  - slack
                  - teams
                  - sms
                  - webhook
                  - console
                  - file
                  - log
                  type: string
                type: array
              metadata:
                additionalProperties:
                  type: string
                description: |-
                  Metadata for context (key-value pairs)
                  Examples: remediationRequestName, cluster, namespace, severity, alertName
                type: object
              priority:
                default: medium
                description: Priority of notification (critical, high, medium, low)
                enum:
                - critical
                - high
                - medium
                - low
                type: string
              recipients:
                description: |-
                  List of recipients for this notification.
                  Optional: If not specified, Notification Service routing rules (BR-NOT-065)
                  will determine recipients based on CRD labels (type, severity, environment, namespace).
                  If specified, these recipients are used in addition to routing rule matches.
                items:
                  description: Recipient represents a notification recipient
                  properties:
                    email:
                      description: Email address (for email channel)
                      type: string
                    phone:
                      description: |-
                        Phone number (for SMS channel)
                        Format: E.164 (+1234567890)
                      type: string
                    slack:
                      description: |-
                        Slack channel or user (for Slack channel)
                        Format: #channel-name or @username
                      type: string
                    teams:
                      description: Teams channel or user (for Teams channel)
                      type: string
                    webhookURL:
                      description: Webhook URL (for webhook channel)
                      type: string
                  type: object
                type: array
              remediationRequestRef:
                description: |-
                  Reference to parent RemediationRequest (if applicable)
                  Used for audit correlation and lineage tracking (BR-NOT-064)
                  Optional: NotificationRequest can be standalone (e.g., system-generated alerts)
                properties:
                  apiVersion:
                    description: API version of the referent.
                    type: string
                  fieldPath:
                    description: |-
                      If referring to a piece of an object instead of an entire object, this string
                      should contain a valid JSON/Go field access statement, such as desiredState.manifest.containers[2].
                      For example, if the object reference is to a container within a pod, this would take on a value like:
                      "spec.containers{name}" (where "name" refers to the name of the container that triggered
                      the event) or if no container name is specified "spec.containers[2]" (container with
                      index 2 in this pod). This syntax is chosen only to have some well-defined way of
                      referencing a part of an object.
                    type: string
                  kind:
                    description: |-
                      Kind of the referent.
                      More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
                    type: string
                  name:
                    description: |-
                      Name of the referent.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                    type: string
                  namespace:
                    description: |-
                      Namespace of the referent.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/
                    type: string
                  resourceVersion:
                    description: |-
                      Specific resourceVersion to which this reference is made, if any.
                      More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#concurrency-control-and-consistency
                    type: string
                  uid:
                    description: |-
                      UID of the referent.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#uids
                    type: string
                type: object
                x-kubernetes-map-type: atomic
              retentionDays:
                default: 7
                description: Retention period in days after completion
                maximum: 90
                minimum: 1
                type: integer
              retryPolicy:
                description: Retry policy for delivery
                properties:
                  backoffMultiplier:
                    default: 2
                    description: Backoff multiplier (exponential backoff)
                    maximum: 10
                    minimum: 1
                    type: integer
                  initialBackoffSeconds:
                    default: 30
                    description: Initial backoff duration in seconds
                    maximum: 300
                    minimum: 1
                    type: integer
                  maxAttempts:
                    default: 5
                    description: Maximum number of delivery attempts
                    maximum: 10
                    minimum: 1
                    type: integer
                  maxBackoffSeconds:
                    default: 480
                    description: Maximum backoff duration in seconds
                    maximum: 3600
                    minimum: 60
                    type: integer
                type: object
              subject:
                description: Subject line for notification
                maxLength: 500
                minLength: 1
                type: string
              type:
                description: Type of notification (escalation, simple, status-update)
                enum:
                - escalation
                - simple
                - status-update
                - approval
                - manual-review
                type: string
            required:
            - body
            - priority
            - subject
            - type
            type: object
            x-kubernetes-validations:
            - message: spec is immutable after creation (DD-NOT-005)
              rule: self == oldSelf
          status:
            description: NotificationRequestStatus defines the observed state of NotificationRequest
            properties:
              completionTime:
                description: Time when all deliveries completed (success or failure)
                format: date-time
                type: string
              conditions:
                description: Conditions represent the latest available observations
                  of the notification's state
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              deliveryAttempts:
                description: List of all delivery attempts across all channels
                items:
                  description: DeliveryAttempt records a single delivery attempt to
                    a channel
                  properties:
                    attempt:
                      description: Attempt number (1-based)
                      type: integer
                    channel:
                      description: Channel name
                      type: string
                    durationSeconds:
                      description: Duration of delivery attempt in seconds
                      type: number
                    error:
                      description: Error message if failed
                      type: string
                    status:
                      description: Status of this attempt (success, failed, timeout,
                        invalid)
                      type: string
                    timestamp:
                      description: Timestamp of this attempt
                      format: date-time
                      type: string
                  required:
                  - attempt
                  - channel
                  - status
                  - timestamp
                  type: object
                type: array
              failedDeliveries:
                description: Number of failed deliveries
                type: integer
              message:
                description: Human-readable message about current state
                type: string
              observedGeneration:
                description: Observed generation from spec
                format: int64
                type: integer
              phase:
                description: Phase of notification lifecycle (Pending, Sending, Sent,
                  PartiallySent, Failed)
                enum:
                - Pending
                - Sending
                - Retrying
                - Sent
                - PartiallySent
                - Failed
                type: string
              processingStartedAt:
                description: Time when processing started
                format: date-time
                type: string
              queuedAt:
                description: Time when notification was queued for processing
                format: date-time
                type: string
              reason:
                description: Reason for current phase
                type: string
              successfulDeliveries:
                description: Number of successful deliveries
                type: integer
              totalAttempts:
                description: Total number of delivery attempts across all channels
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}

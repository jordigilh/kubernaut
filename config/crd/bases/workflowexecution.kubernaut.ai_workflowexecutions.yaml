---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: workflowexecutions.workflowexecution.kubernaut.ai
spec:
  group: workflowexecution.kubernaut.ai
  names:
    kind: WorkflowExecution
    listKind: WorkflowExecutionList
    plural: workflowexecutions
    shortNames:
    - wfe
    singular: workflowexecution
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .spec.workflowRef.workflowId
      name: WorkflowID
      type: string
    - jsonPath: .spec.targetResource
      name: Target
      type: string
    - jsonPath: .status.duration
      name: Duration
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          WorkflowExecution is the Schema for the workflowexecutions API
          Manages workflow execution lifecycle by delegating to Tekton PipelineRuns
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              WorkflowExecutionSpec defines the desired state of WorkflowExecution
              Simplified per ADR-044 - Tekton handles step orchestration
            properties:
              confidence:
                description: Confidence score from LLM (for audit trail)
                maximum: 1
                minimum: 0
                type: number
              executionConfig:
                description: ExecutionConfig contains minimal execution settings
                properties:
                  serviceAccountName:
                    description: |-
                      ServiceAccountName for the PipelineRun
                      Default: "kubernaut-workflow-runner"
                    type: string
                  timeout:
                    description: |-
                      Timeout for the entire workflow (Tekton PipelineRun timeout)
                      Default: use global timeout from RemediationRequest or 30m
                    type: string
                type: object
              parameters:
                additionalProperties:
                  type: string
                description: |-
                  Parameters from LLM selection (per DD-WORKFLOW-003)
                  Keys are UPPER_SNAKE_CASE for Tekton PipelineRun params
                type: object
              rationale:
                description: Rationale from LLM (for audit trail)
                type: string
              remediationRequestRef:
                description: RemediationRequestRef references the parent RemediationRequest
                  CRD
                properties:
                  apiVersion:
                    description: API version of the referent.
                    type: string
                  fieldPath:
                    description: |-
                      If referring to a piece of an object instead of an entire object, this string
                      should contain a valid JSON/Go field access statement, such as desiredState.manifest.containers[2].
                      For example, if the object reference is to a container within a pod, this would take on a value like:
                      "spec.containers{name}" (where "name" refers to the name of the container that triggered
                      the event) or if no container name is specified "spec.containers[2]" (container with
                      index 2 in this pod). This syntax is chosen only to have some well-defined way of
                      referencing a part of an object.
                    type: string
                  kind:
                    description: |-
                      Kind of the referent.
                      More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
                    type: string
                  name:
                    description: |-
                      Name of the referent.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                    type: string
                  namespace:
                    description: |-
                      Namespace of the referent.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/
                    type: string
                  resourceVersion:
                    description: |-
                      Specific resourceVersion to which this reference is made, if any.
                      More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#concurrency-control-and-consistency
                    type: string
                  uid:
                    description: |-
                      UID of the referent.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#uids
                    type: string
                type: object
                x-kubernetes-map-type: atomic
              targetResource:
                description: |-
                  TargetResource identifies the K8s resource being remediated
                  Used for resource locking (DD-WE-001) - prevents parallel workflows on same target
                  Format: "namespace/kind/name" for namespaced resources
                          "kind/name" for cluster-scoped resources
                  Example: "payment/deployment/payment-api", "node/worker-node-1"
                minLength: 3
                type: string
              workflowRef:
                description: |-
                  WorkflowRef contains the workflow catalog reference
                  Resolved from AIAnalysis.Status.SelectedWorkflow by RemediationOrchestrator
                properties:
                  containerDigest:
                    description: ContainerDigest for audit trail and reproducibility
                    type: string
                  containerImage:
                    description: |-
                      ContainerImage resolved from workflow catalog (Data Storage API)
                      OCI bundle reference for Tekton PipelineRun
                    type: string
                  version:
                    description: Version of the workflow
                    type: string
                  workflowId:
                    description: WorkflowID is the catalog lookup key
                    minLength: 1
                    type: string
                required:
                - containerImage
                - version
                - workflowId
                type: object
            required:
            - remediationRequestRef
            - targetResource
            - workflowRef
            type: object
          status:
            description: |-
              WorkflowExecutionStatus defines the observed state
              Simplified per ADR-044 - just tracks PipelineRun status
              Enhanced per DD-CONTRACT-001 v1.3 - rich failure details for recovery flow
              Enhanced per DD-CONTRACT-001 v1.4 - resource locking and Skipped phase
            properties:
              completionTime:
                description: CompletionTime when execution completed (success or failure)
                format: date-time
                type: string
              conditions:
                description: Conditions provide detailed status information
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              duration:
                description: Duration of the execution
                type: string
              failureDetails:
                description: |-
                  FailureDetails contains structured failure information
                  Populated when Phase=Failed
                  RO uses this to populate AIAnalysis.Spec.PreviousExecutions for recovery
                properties:
                  executionTimeBeforeFailure:
                    description: |-
                      ExecutionTimeBeforeFailure is how long the workflow ran before failing
                      Format: Go duration string (e.g., "2m30s")
                    type: string
                  exitCode:
                    description: |-
                      ExitCode from container (if applicable)
                      Useful for script-based tasks that return specific exit codes
                    format: int32
                    type: integer
                  failedAt:
                    description: FailedAt is the timestamp when the failure occurred
                    format: date-time
                    type: string
                  failedStepName:
                    description: |-
                      FailedStepName is the name of the failed step within the task (if available)
                      Tekton tasks can have multiple steps; this identifies the specific step
                    type: string
                  failedTaskIndex:
                    description: |-
                      FailedTaskIndex is 0-indexed position of failed task in pipeline
                      Used by RO to populate AIAnalysis.Spec.PreviousExecutions[].Failure.FailedStepIndex
                    type: integer
                  failedTaskName:
                    description: |-
                      FailedTaskName is the name of the failed Tekton Task
                      Used by RO to populate AIAnalysis.Spec.PreviousExecutions[].Failure.FailedStepName
                    type: string
                  message:
                    description: Message is human-readable error message (for logging/UI/notifications)
                    type: string
                  naturalLanguageSummary:
                    description: |-
                      NaturalLanguageSummary is a human/LLM-readable failure description
                      Generated by WE controller from structured data above
                      Used by:
                        - RO: Included in AIAnalysis.Spec.PreviousExecutions for LLM context
                        - Notification: Included in user-facing failure alerts
                    type: string
                  reason:
                    description: |-
                      Reason is a Kubernetes-style reason code
                      Used for deterministic recovery decisions by RO
                    enum:
                    - OOMKilled
                    - DeadlineExceeded
                    - Forbidden
                    - ResourceExhausted
                    - ConfigurationError
                    - ImagePullBackOff
                    - Unknown
                    type: string
                  wasExecutionFailure:
                    description: |-
                      WasExecutionFailure indicates whether the failure occurred during execution
                      true: Failure happened during PipelineRun execution (cluster state unknown)
                      false: Failure happened before execution started (e.g., RBAC, image pull)
                      Used by RO to decide if retry is safe
                    type: boolean
                required:
                - executionTimeBeforeFailure
                - failedAt
                - failedTaskIndex
                - failedTaskName
                - message
                - naturalLanguageSummary
                - reason
                - wasExecutionFailure
                type: object
              failureReason:
                description: |-
                  FailureReason explains why execution failed (if applicable)
                  DEPRECATED: Use FailureDetails for structured failure information
                type: string
              lockReleased:
                description: |-
                  LockReleased indicates the resource lock has been released after cooldown
                  Used to track when subsequent workflows can run on the same target
                type: boolean
              phase:
                description: |-
                  Phase tracks current execution stage
                  Skipped: Resource is busy (another workflow running) or recently remediated
                enum:
                - Pending
                - Running
                - Completed
                - Failed
                - Skipped
                type: string
              pipelineRunRef:
                description: PipelineRunRef references the created Tekton PipelineRun
                properties:
                  name:
                    default: ""
                    description: |-
                      Name of the referent.
                      This field is effectively required, but due to backwards compatibility is
                      allowed to be empty. Instances of this type with an empty value here are
                      almost certainly wrong.
                      More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                    type: string
                type: object
                x-kubernetes-map-type: atomic
              pipelineRunStatus:
                description: PipelineRunStatus mirrors key PipelineRun status fields
                properties:
                  completedTasks:
                    description: CompletedTasks count
                    type: integer
                  message:
                    description: Message from PipelineRun
                    type: string
                  reason:
                    description: Reason from PipelineRun (e.g., "Succeeded", "Failed",
                      "Running")
                    type: string
                  status:
                    description: Status from PipelineRun (Unknown, True, False)
                    type: string
                  totalTasks:
                    description: TotalTasks count (from pipeline spec)
                    type: integer
                type: object
              skipDetails:
                description: |-
                  SkipDetails contains information about why execution was skipped
                  Populated when Phase=Skipped
                  Enables RO to understand why workflow didn't execute
                properties:
                  conflictingWorkflow:
                    description: |-
                      ConflictingWorkflow contains details about the blocking workflow
                      Populated when Reason=ResourceBusy
                    properties:
                      name:
                        description: Name of the conflicting WorkflowExecution CRD
                        type: string
                      startedAt:
                        description: StartedAt when the conflicting workflow started
                        format: date-time
                        type: string
                      targetResource:
                        description: |-
                          TargetResource is the resource being remediated (for audit trail)
                          Format: "namespace/kind/name" or "kind/name" for cluster-scoped
                        type: string
                      workflowId:
                        description: WorkflowID of the conflicting workflow
                        type: string
                    required:
                    - name
                    - startedAt
                    - targetResource
                    - workflowId
                    type: object
                  message:
                    description: Message is a human-readable explanation
                    type: string
                  reason:
                    description: Reason explains why execution was skipped
                    enum:
                    - ResourceBusy
                    - RecentlyRemediated
                    type: string
                  recentRemediation:
                    description: |-
                      RecentRemediation contains details about the recent execution
                      Populated when Reason=RecentlyRemediated
                    properties:
                      completedAt:
                        description: CompletedAt when the workflow completed
                        format: date-time
                        type: string
                      cooldownRemaining:
                        description: |-
                          CooldownRemaining is how long until this target can be remediated again
                          Format: Go duration string (e.g., "4m30s")
                        type: string
                      name:
                        description: Name of the recent WorkflowExecution CRD
                        type: string
                      outcome:
                        description: Outcome of the recent execution (Completed/Failed)
                        type: string
                      targetResource:
                        description: |-
                          TargetResource is the resource that was remediated
                          Format: "namespace/kind/name" or "kind/name" for cluster-scoped
                        type: string
                      workflowId:
                        description: WorkflowID that was executed
                        type: string
                    required:
                    - completedAt
                    - name
                    - outcome
                    - targetResource
                    - workflowId
                    type: object
                  skippedAt:
                    description: SkippedAt is when the skip decision was made
                    format: date-time
                    type: string
                required:
                - message
                - reason
                - skippedAt
                type: object
              startTime:
                description: StartTime when execution started
                format: date-time
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}

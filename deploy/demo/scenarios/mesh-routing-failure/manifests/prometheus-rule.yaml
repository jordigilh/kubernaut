apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernaut-mesh-failure-rules
  namespace: demo-mesh-failure
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: kubernaut-mesh-failure
    rules:
    - alert: LinkerdHighErrorRate
      expr: |
        sum by (namespace)(rate(inbound_http_authz_deny_total{namespace="demo-mesh-failure"}[5m])) > 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: >
          Linkerd AuthorizationPolicy is denying inbound HTTP requests
          in namespace demo-mesh-failure.
        description: >
          The inbound_http_authz_deny_total metric is rising, indicating
          a Linkerd AuthorizationPolicy is blocking legitimate traffic.
          This is typically caused by a restrictive policy requiring an
          identity that no client possesses.
    - alert: LinkerdRequestsUnauthorized
      expr: |
        sum by (namespace)(rate(inbound_http_authz_deny_total{namespace="demo-mesh-failure"}[2m])) > 0.1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: >
          Sustained Linkerd authorization denials detected in
          namespace demo-mesh-failure.
        description: >
          A Linkerd AuthorizationPolicy is actively denying inbound traffic
          to workloads in namespace demo-mesh-failure, causing service
          unavailability for meshed clients.

# Simplified Dynamic Toolset Deployment for E2E Testing
# This is a minimal deployment focused on E2E test requirements
# Production deployment is in deploy/dynamic-toolset-deployment.yaml
# ADR-030 v2.0 COMPLIANT

apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubernaut-service-discovery
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: service-discovery

---
# RBAC Configuration for Service Discovery
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubernaut-service-discovery-__NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: service-discovery
rules:
# Service discovery permissions
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list"]
# Application discovery permissions
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch"]
# ConfigMap management
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "create", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubernaut-service-discovery-__NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: service-discovery
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubernaut-service-discovery-__NAMESPACE__
subjects:
- kind: ServiceAccount
  name: kubernaut-service-discovery
  namespace: __NAMESPACE__

---
# ConfigMap for Dynamic Toolset Configuration (E2E Test)
# ADR-030 v2.0 COMPLIANT: Business logic configuration ONLY
apiVersion: v1
kind: ConfigMap
metadata:
  name: kubernaut-dynamic-toolset-config
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: configuration
data:
  config.yaml: |
    # ADR-030 v2.0: Business logic configuration ONLY
    # Server configuration (port, timeouts) is in Deployment env vars
    service_discovery:
      discovery_interval: "5s"          # E2E: Faster discovery for parallel tests (was 10s)
      health_check_interval: "3s"       # E2E: Faster health checks (was 5s)
      namespaces: []                    # Empty = all namespaces (E2E tests use single namespace)

---
# Dynamic Toolset Deployment (E2E Test - Simplified)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubernaut-dynamic-toolsets
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: dynamic-toolsets
spec:
  replicas: 1  # Single replica for E2E tests
  selector:
    matchLabels:
      app.kubernetes.io/name: kubernaut
      app.kubernetes.io/component: dynamic-toolsets
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kubernaut
        app.kubernetes.io/component: dynamic-toolsets
    spec:
      serviceAccountName: kubernaut-service-discovery
      containers:
      - name: kubernaut
        image: localhost/kubernaut-dynamic-toolsets:e2e-test
        imagePullPolicy: Never  # Use local image
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: metrics
          containerPort: 9090
          protocol: TCP
        env:
        # ADR-030 v2.0: Deployment configuration via env vars
        - name: CONFIG_FILE
          value: "/etc/config/config.yaml"
        - name: SERVER_PORT
          value: "8080"
        - name: METRICS_PORT
          value: "9090"
        - name: SHUTDOWN_TIMEOUT
          value: "30s"
        volumeMounts:
        - name: config
          mountPath: /etc/config
          readOnly: true
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 5
          periodSeconds: 3
          timeoutSeconds: 2
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: config
        configMap:
          name: kubernaut-dynamic-toolset-config

---
# Service for Dynamic Toolset (E2E Test)
apiVersion: v1
kind: Service
metadata:
  name: kubernaut-dynamic-toolsets
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: dynamic-toolsets
spec:
  selector:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: dynamic-toolsets
  ports:
  - name: http
    port: 8080
    targetPort: http
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: metrics
    protocol: TCP
  type: ClusterIP

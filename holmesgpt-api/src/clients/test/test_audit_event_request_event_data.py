# coding: utf-8

"""
    Data Storage Service API

    Data Storage Service provides REST API access to audit trail persistence.  **Business Requirements**: - BR-STORAGE-001 to BR-STORAGE-020: Audit write API - BR-STORAGE-021: Incident query API (READ) - BR-STORAGE-024: RFC 7807 error responses - BR-AUDIT-006: Legal hold capability (SOC2 Gap #8)  **Design Decisions**: - ADR-031: OpenAPI 3.0+ specification for all stateless REST APIs - ADR-032: Data Access Layer Isolation (only Data Storage connects to PostgreSQL) - DD-009: Dead Letter Queue fallback on database errors - DD-AUTH-004: OAuth-proxy sidecar for authentication/authorization - DD-AUTH-005: Client authentication pattern (ServiceAccount tokens)  **Architecture**: This service is the **ONLY** service that directly accesses PostgreSQL. All other services (Context API, Effectiveness Monitor, etc.) access data through this REST API Gateway.  **Authentication & Authorization (Production/E2E)**: All requests to DataStorage are protected by an OAuth-proxy sidecar:  1. **Client Authentication**: Services authenticate with Kubernetes ServiceAccount tokens    - Token mounted at: `/var/run/secrets/kubernetes.io/serviceaccount/token`    - Clients inject: `Authorization: Bearer <token>` header    - See DD-AUTH-005 for client implementation patterns  2. **OAuth-Proxy Validation**: The sidecar validates requests    - Validates JWT token signature and expiration    - Performs Subject Access Review (SAR) to check RBAC permissions    - Injects `X-Auth-Request-User` header with authenticated user identity    - Returns HTTP 401 if token invalid, HTTP 403 if SAR fails  3. **Handler Enforcement**: DataStorage handlers extract user identity    - Legal hold operations REQUIRE `X-Auth-Request-User` header    - HTTP 401 returned if header missing (authentication failed)    - User identity stored in audit events for SOC2 compliance  **Routing Flow**: ``` Client → data-storage-service:8080 (Service)        ↓      oauth-proxy:8080 (validates token + SAR)        ↓      DataStorage:8081 (X-Auth-Request-User header) ```  **Integration Tests**: Integration tests run without oauth-proxy. Use `testutil.NewMockUserTransport()` to inject mock `X-Auth-Request-User` headers directly.  **SOC2 Compliance**: - All legal hold operations attributed to authenticated users - Audit trail captures placed_by/released_by from X-Auth-Request-User - Unauthorized access blocked at oauth-proxy layer (defense-in-depth) 

    The version of the OpenAPI document: 1.0.0
    Generated by OpenAPI Generator (https://openapi-generator.tech)

    Do not edit the class manually.
"""  # noqa: E501


import unittest

from datastorage.models.audit_event_request_event_data import AuditEventRequestEventData

class TestAuditEventRequestEventData(unittest.TestCase):
    """AuditEventRequestEventData unit test stubs"""

    def setUp(self):
        pass

    def tearDown(self):
        pass

    def make_instance(self, include_optional) -> AuditEventRequestEventData:
        """Test AuditEventRequestEventData
            include_optional is a boolean, when False only required
            params are included, when True both required and
            optional params are included """
        # uncomment below to create an instance of `AuditEventRequestEventData`
        """
        model = AuditEventRequestEventData()
        if include_optional:
            return AuditEventRequestEventData(
                event_type = '',
                original_payload = { },
                signal_labels = {
                    'key' : ''
                    },
                signal_annotations = {
                    'key' : ''
                    },
                signal_type = 'prometheus',
                alert_name = 'HighMemoryUsage',
                namespace = 'payment',
                fingerprint = 'abc123',
                severity = 'critical',
                resource_kind = 'Deployment',
                resource_name = 'payment-api',
                remediation_request = 'payment/restart-payment-api-2025-12-17-abc123',
                deduplication_status = 'new',
                occurrence_count = 56,
                error_details = datastorage.models.error_details.ErrorDetails(
                    message = 'Holmes API request timeout after 30s', 
                    code = 'ERR_UPSTREAM_TIMEOUT', 
                    component = 'gateway', 
                    retry_possible = True, 
                    stack_trace = ["/path/to/file.go:123 function.Name"], ),
                rr_name = 'restart-payment-api-2025-12-17-abc123',
                outcome = 'allow',
                duration_ms = 50,
                failure_phase = 'SignalProcessing',
                failure_reason = 'OOMKilled',
                from_phase = '',
                to_phase = '',
                transition_reason = '',
                phase = 'Investigating',
                signal = 'high-memory-payment-api-abc123',
                environment = 'production',
                environment_source = 'rego',
                priority = '',
                priority_source = 'rego',
                criticality = 'critical',
                sla_requirement = '5m',
                has_owner_chain = True,
                owner_chain_length = 56,
                degraded_mode = True,
                has_pdb = True,
                has_hpa = True,
                has_namespace = True,
                has_pod = True,
                has_deployment = True,
                business_unit = '',
                error = '',
                analysis_name = 'diagnose-payment-api-2025-12-17-abc123',
                approval_required = True,
                approval_reason = 'Production environment requires manual approval',
                warnings_count = 56,
                confidence = 0.95,
                workflow_id = '',
                target_in_owner_chain = True,
                reason = '',
                sub_reason = '',
                provider_response_summary = datastorage.models.provider_response_summary.ProviderResponseSummary(
                    incident_id = 'incident-payment-api-2025-12-17-abc123', 
                    analysis_preview = 'Root cause: Database connection pool exhausted...', 
                    selected_workflow_id = 'restart-payment-api-v1.2', 
                    needs_human_review = True, 
                    warnings_count = 2, ),
                workflow_version = 'v1.0.0',
                target_resource = 'payment/deployment/payment-api',
                container_image = 'ghcr.io/kubernaut/kubectl-actions:v1.28',
                execution_name = 'restart-payment-api-2025-12-17-abc123',
                started_at = datetime.datetime.strptime('2013-10-20 19:20:30.00', '%Y-%m-%d %H:%M:%S.%f'),
                completed_at = datetime.datetime.strptime('2013-10-20 19:20:30.00', '%Y-%m-%d %H:%M:%S.%f'),
                duration = '2m30s',
                failure_message = '',
                failed_task_name = '',
                pipelinerun_name = 'restart-payment-api-2025-12-17-abc123-run',
                notification_id = '',
                notification_name = '',
                type = '',
                notification_type = 'email',
                final_status = 'Pending',
                recipients = { },
                cancelled_by = '',
                user_uid = '',
                user_groups = [
                    ''
                    ],
                action = 'notification_cancelled',
                workflow_name = '',
                clear_reason = 'Manual approval by ops team',
                cleared_at = datetime.datetime.strptime('2013-10-20 19:20:30.00', '%Y-%m-%d %H:%M:%S.%f'),
                previous_state = 'Blocked',
                new_state = 'Running',
                request_name = 'approve-payment-api-2025-12-17-abc123',
                decision = 'requires_approval',
                decided_at = datetime.datetime.strptime('2013-10-20 19:20:30.00', '%Y-%m-%d %H:%M:%S.%f'),
                decision_message = '',
                ai_analysis_ref = '',
                query = datastorage.models.query_metadata.QueryMetadata(
                    top_k = 5, 
                    min_score = 0.7, 
                    filters = datastorage.models.workflow_search_filters.WorkflowSearchFilters(
                        signal_type = 'OOMKilled', 
                        severity = 'critical', 
                        component = 'pod', 
                        environment = 'production', 
                        priority = 'P0', 
                        custom_labels = {"team":["name=payments"],"constraint":["cost-constrained","stateful-safe"]}, 
                        detected_labels = datastorage.models.detected_labels.DetectedLabels(
                            failed_detections = ["pdbProtected","networkIsolated"], 
                            git_ops_managed = True, 
                            git_ops_tool = 'argocd', 
                            pdb_protected = True, 
                            hpa_enabled = True, 
                            stateful = True, 
                            helm_managed = True, 
                            network_isolated = True, 
                            service_mesh = 'istio', ), 
                        status = [
                            'active'
                            ], ), ),
                results = datastorage.models.results_metadata.ResultsMetadata(
                    total_found = 10, 
                    returned = 5, 
                    workflows = [
                        datastorage.models.workflow_result_audit.WorkflowResultAudit(
                            workflow_id = '550e8400-e29b-41d4-a716-446655440000', 
                            title = 'Restart OOMKilled Pod', 
                            rank = 1, 
                            scoring = datastorage.models.scoring_v1_audit.ScoringV1Audit(
                                confidence = 0.95, ), 
                            owner = 'platform-team', 
                            maintainer = 'alice@example.com', 
                            description = 'Restarts pods that were OOMKilled', 
                            labels = { }, )
                        ], ),
                search_metadata = datastorage.models.search_execution_metadata.SearchExecutionMetadata(
                    duration_ms = 150, 
                    embedding_dimensions = 768, 
                    embedding_model = 'text-embedding-3-small', ),
                version = '1.0.0',
                status = 'active',
                is_latest_version = True,
                execution_engine = 'argo',
                name = 'Restart OOMKilled Pod',
                description = 'Restarts pods that were terminated due to OOM',
                labels = { },
                updated_fields = {status=disabled, description=Updated description},
                old_phase = 'Investigating',
                new_phase = 'Analyzing',
                endpoint = '/api/v1/investigate',
                http_status_code = 200,
                auto_approved = False,
                degraded = False,
                error_message = 'HolmesGPT API timeout after 30s',
                channel = '',
                subject = '',
                body = '',
                metadata = {
                    'key' : ''
                    },
                error_type = '',
                event_id = '',
                incident_id = '',
                response_data = {incident_id=incident-payment-api-2025-12-17-abc123, analysis=Root cause analysis text..., root_cause_analysis={}, selected_workflow={}, confidence=0.85, needs_human_review=false, timestamp=2025-01-08T10:30:00Z},
                model = 'gpt-4',
                prompt_length = 0,
                prompt_preview = '',
                max_tokens = 0,
                toolsets_enabled = [
                    ''
                    ],
                mcp_servers = [
                    ''
                    ],
                has_analysis = True,
                analysis_length = 0,
                analysis_preview = '',
                tokens_used = 0,
                tool_call_count = 0,
                tool_call_index = 0,
                tool_name = 'search_workflow_catalog',
                tool_arguments = { },
                tool_result = datastorage.models.tool_result.tool_result(),
                tool_result_preview = '',
                attempt = 1,
                max_attempts = 1,
                is_valid = True,
                errors = [
                    ''
                    ],
                validation_errors = '',
                human_review_reason = '',
                is_final_attempt = True
            )
        else:
            return AuditEventRequestEventData(
                event_type = '',
                signal_type = 'prometheus',
                alert_name = 'HighMemoryUsage',
                namespace = 'payment',
                fingerprint = 'abc123',
                rr_name = 'restart-payment-api-2025-12-17-abc123',
                outcome = 'allow',
                duration_ms = 50,
                phase = 'Investigating',
                signal = 'high-memory-payment-api-abc123',
                environment = 'production',
                priority = '',
                degraded_mode = True,
                analysis_name = 'diagnose-payment-api-2025-12-17-abc123',
                approval_required = True,
                approval_reason = 'Production environment requires manual approval',
                warnings_count = 56,
                workflow_id = '',
                reason = '',
                workflow_version = 'v1.0.0',
                target_resource = 'payment/deployment/payment-api',
                container_image = 'ghcr.io/kubernaut/kubectl-actions:v1.28',
                execution_name = 'restart-payment-api-2025-12-17-abc123',
                notification_id = '',
                type = '',
                workflow_name = '',
                clear_reason = 'Manual approval by ops team',
                cleared_at = datetime.datetime.strptime('2013-10-20 19:20:30.00', '%Y-%m-%d %H:%M:%S.%f'),
                previous_state = 'Blocked',
                new_state = 'Running',
                request_name = 'approve-payment-api-2025-12-17-abc123',
                decision = 'requires_approval',
                decided_at = datetime.datetime.strptime('2013-10-20 19:20:30.00', '%Y-%m-%d %H:%M:%S.%f'),
                decision_message = '',
                ai_analysis_ref = '',
                query = datastorage.models.query_metadata.QueryMetadata(
                    top_k = 5, 
                    min_score = 0.7, 
                    filters = datastorage.models.workflow_search_filters.WorkflowSearchFilters(
                        signal_type = 'OOMKilled', 
                        severity = 'critical', 
                        component = 'pod', 
                        environment = 'production', 
                        priority = 'P0', 
                        custom_labels = {"team":["name=payments"],"constraint":["cost-constrained","stateful-safe"]}, 
                        detected_labels = datastorage.models.detected_labels.DetectedLabels(
                            failed_detections = ["pdbProtected","networkIsolated"], 
                            git_ops_managed = True, 
                            git_ops_tool = 'argocd', 
                            pdb_protected = True, 
                            hpa_enabled = True, 
                            stateful = True, 
                            helm_managed = True, 
                            network_isolated = True, 
                            service_mesh = 'istio', ), 
                        status = [
                            'active'
                            ], ), ),
                results = datastorage.models.results_metadata.ResultsMetadata(
                    total_found = 10, 
                    returned = 5, 
                    workflows = [
                        datastorage.models.workflow_result_audit.WorkflowResultAudit(
                            workflow_id = '550e8400-e29b-41d4-a716-446655440000', 
                            title = 'Restart OOMKilled Pod', 
                            rank = 1, 
                            scoring = datastorage.models.scoring_v1_audit.ScoringV1Audit(
                                confidence = 0.95, ), 
                            owner = 'platform-team', 
                            maintainer = 'alice@example.com', 
                            description = 'Restarts pods that were OOMKilled', 
                            labels = { }, )
                        ], ),
                search_metadata = datastorage.models.search_execution_metadata.SearchExecutionMetadata(
                    duration_ms = 150, 
                    embedding_dimensions = 768, 
                    embedding_model = 'text-embedding-3-small', ),
                version = '1.0.0',
                status = 'active',
                is_latest_version = True,
                execution_engine = 'argo',
                name = 'Restart OOMKilled Pod',
                updated_fields = {status=disabled, description=Updated description},
                old_phase = 'Investigating',
                new_phase = 'Analyzing',
                endpoint = '/api/v1/investigate',
                http_status_code = 200,
                auto_approved = False,
                degraded = False,
                error_message = 'HolmesGPT API timeout after 30s',
                channel = '',
                subject = '',
                body = '',
                error_type = '',
                event_id = '',
                incident_id = '',
                response_data = {incident_id=incident-payment-api-2025-12-17-abc123, analysis=Root cause analysis text..., root_cause_analysis={}, selected_workflow={}, confidence=0.85, needs_human_review=false, timestamp=2025-01-08T10:30:00Z},
                model = 'gpt-4',
                prompt_length = 0,
                prompt_preview = '',
                has_analysis = True,
                analysis_length = 0,
                analysis_preview = '',
                tool_call_index = 0,
                tool_name = 'search_workflow_catalog',
                tool_result = datastorage.models.tool_result.tool_result(),
                attempt = 1,
                max_attempts = 1,
                is_valid = True,
        )
        """

    def testAuditEventRequestEventData(self):
        """Test AuditEventRequestEventData"""
        # inst_req_only = self.make_instance(include_optional=False)
        # inst_req_and_optional = self.make_instance(include_optional=True)

if __name__ == '__main__':
    unittest.main()

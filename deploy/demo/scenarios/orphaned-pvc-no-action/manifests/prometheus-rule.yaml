apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: orphaned-pvc-rules
  namespace: demo-orphaned-pvc
  labels:
    release: prometheus
spec:
  groups:
  - name: orphaned-pvc
    rules:
    # Detect PVCs in namespace that are bound but owned by completed/failed Jobs.
    # "count by (namespace)" preserves the namespace label so AlertManager can
    # route the alert to the gateway-webhook receiver via match_re: demo-.*
    - alert: KubePersistentVolumeClaimOrphaned
      expr: |
        count by (namespace)(
          kube_persistentvolumeclaim_status_phase{
            namespace="demo-orphaned-pvc",
            phase="Bound"
          }
        ) > 3
      for: 2m
      labels:
        severity: warning
        deployment: data-processor
      annotations:
        summary: >
          Namespace {{ $labels.namespace }} has more than 3 bound PVCs, indicating
          possible orphaned storage from completed batch jobs.
        description: >
          The demo-orphaned-pvc namespace has accumulated multiple bound PVCs that
          may be from completed or failed batch jobs. These orphaned PVCs are dangling
          resources that should be cleaned up as part of regular housekeeping.

# HolmesGPT-API Client Generation

## Overview

The HolmesGPT-API (HAPI) client is generated from the OpenAPI specification using [`ogen`](https://github.com/ogen-go/ogen).

**Client Location**: `pkg/holmesgpt/client/`
**OpenAPI Spec**: `holmesgpt-api/api/openapi.json`
**Generator**: `ogen` (go-based OpenAPI code generator)

## Quick Start

### Regenerate HAPI Client

```bash
# Option 1: Using make (recommended)
make generate-holmesgpt-client

# Option 2: Using go generate directly
go generate ./pkg/holmesgpt/client/...

# Option 3: Part of full generate
make generate
```

## Prerequisites

### Install ogen

```bash
go install github.com/ogen-go/ogen/cmd/ogen@latest
```

Verify installation:
```bash
ogen --version
```

## Client Structure

```
pkg/holmesgpt/client/
├── generate.go                    # Generation directive (//go:generate)
├── holmesgpt.go                   # Custom wrapper around generated client
└── oas_*_gen.go                   # Generated files (DO NOT EDIT)
    ├── oas_client_gen.go          # Client implementation
    ├── oas_schemas_gen.go         # Type definitions
    ├── oas_json_gen.go            # JSON encoding/decoding
    ├── oas_handlers_gen.go        # Server handlers
    ├── oas_cfg_gen.go             # Client configuration
    ├── oas_validators_gen.go      # Request/response validation
    └── ... (more generated files)
```

## Generated vs. Custom Code

### Generated Code (DO NOT EDIT)
All files matching `oas_*_gen.go` are generated by `ogen`:
- Type-safe request/response structs
- JSON serialization/deserialization
- HTTP client implementation
- Validation logic

**These files are regenerated** when you run `make generate-holmesgpt-client`.

### Custom Code (SAFE TO EDIT)
- `holmesgpt.go`: Custom wrapper providing:
  - Convenience methods
  - AIAnalysis-specific error handling
  - Type conversions between generated types and CRD types

## Generation Process

### What Happens When You Run `make generate-holmesgpt-client`

1. **ogen reads** `holmesgpt-api/api/openapi.json`
2. **Generates Go code** in `pkg/holmesgpt/client/`
   - Client interface and implementation
   - Type-safe request/response structs
   - JSON marshalers/unmarshalers
   - Validators
3. **Preserves** `holmesgpt.go` (custom wrapper)
4. **Overwrites** all `oas_*_gen.go` files

### Generation Command Breakdown

From `pkg/holmesgpt/client/generate.go`:
```go
//go:generate ogen --target . --package client --clean ../../holmesgpt-api/api/openapi.json
```

**Flags**:
- `--target .`: Output to current directory
- `--package client`: Package name
- `--clean`: Remove old generated files before generating
- `../../holmesgpt-api/api/openapi.json`: Path to OpenAPI spec

## When to Regenerate

Regenerate the HAPI client when:

1. **holmesgpt-api OpenAPI spec changes**
   - New endpoints added
   - Request/response schemas updated
   - Field names or types changed

2. **After pulling holmesgpt-api updates**
   ```bash
   cd holmesgpt-api
   git pull origin main
   cd ..
   make generate-holmesgpt-client
   ```

3. **Before major releases** (to ensure sync with latest HAPI version)

## Verification

After regenerating, verify the client works:

```bash
# 1. Ensure code compiles
go build ./pkg/holmesgpt/client/...

# 2. Run unit tests
make test-unit-aianalysis

# 3. Run integration tests (requires HAPI running)
make test-integration-aianalysis
```

## Integration with AIAnalysis

### Handler Usage

AIAnalysis handlers import the generated client:

```go
import (
    hgptclient "github.com/jordigilh/kubernaut/pkg/holmesgpt/client"
)

// Use generated types
type InvestigatingHandler struct {
    hgClient HolmesGPTClientInterface  // Interface for testing
}

// Build type-safe requests
func (h *InvestigatingHandler) Handle(ctx context.Context, analysis *aianalysisv1.AIAnalysis) error {
    req := &hgptclient.IncidentRequest{
        IncidentID:    analysis.Spec.RemediationID,
        SignalType:    analysis.Spec.AnalysisRequest.SignalContext.SignalType,
        // ... more fields
    }

    resp, err := h.hgClient.Investigate(ctx, req)
    // ...
}
```

### Type Mappings

The generated client provides type-safe structs that map directly to HAPI API:

| HAPI API Endpoint | Generated Request Type | Generated Response Type |
|---|---|---|
| `POST /api/v1/incident/analyze` | `IncidentRequest` | `IncidentResponse` |
| `POST /api/v1/recovery/analyze` | `RecoveryRequest` | `RecoveryResponse` |
| `GET /health` | N/A | `HealthCheckResponse` |
| `GET /ready` | N/A | `ReadinessCheckResponse` |

## Troubleshooting

### Issue: "ogen: command not found"

**Solution**: Install ogen
```bash
go install github.com/ogen-go/ogen/cmd/ogen@latest
```

### Issue: "file not found: ../../holmesgpt-api/api/openapi.json"

**Solution**: Ensure holmesgpt-api subproject is cloned
```bash
# Check if subproject exists
ls -la holmesgpt-api/api/openapi.json

# If not, you may need to initialize the subproject
# (Consult project setup documentation)
```

### Issue: Generated types don't match HAPI responses

**Solution**:
1. Pull latest holmesgpt-api changes
2. Regenerate client
3. Update handler code to use new types

```bash
cd holmesgpt-api && git pull && cd ..
make generate-holmesgpt-client
```

### Issue: Compilation errors after regeneration

**Possible causes**:
1. **HAPI spec breaking changes**: Check `holmesgpt-api` changelog
2. **Custom wrapper needs updates**: Update `holmesgpt.go` to match new types
3. **Handler code needs updates**: Update AIAnalysis handlers to use new types

**Resolution steps**:
```bash
# 1. Check what changed in HAPI
cd holmesgpt-api && git log --oneline -10

# 2. Review generated type changes
git diff pkg/holmesgpt/client/oas_schemas_gen.go

# 3. Update handler code accordingly
# Edit: pkg/aianalysis/handlers/*.go
```

## Best Practices

### DO ✅
- Regenerate client after pulling holmesgpt-api updates
- Run tests after regeneration
- Use generated types directly (they're type-safe!)
- Keep `holmesgpt.go` wrapper simple (thin adapter layer)
- Commit generated files to git (ensures build consistency)

### DON'T ❌
- Edit `oas_*_gen.go` files (changes will be overwritten)
- Copy generated types to other packages (import them instead)
- Skip regeneration after HAPI updates (types will be out of sync)
- Ignore compilation errors after regeneration (fix them immediately)

## Related Documentation

- [HolmesGPT-API Repository](../../../holmesgpt-api/README.md)
- [AIAnalysis Controller Implementation](../services/crd-controllers/02-aianalysis/controller-implementation.md)
- [Testing Guidelines](TESTING_GUIDELINES.md)
- [ogen Documentation](https://ogen.dev/)

## History

- **2025-12-24**: Moved client from `pkg/aianalysis/client/generated/` to `pkg/holmesgpt/client/`
  - Added generation directive in `generate.go`
  - Added `make generate-holmesgpt-client` target
  - Integrated into main `make generate` target
  - Reason: HAPI client is shared infrastructure, not AIAnalysis-specific

---

**Last Updated**: 2025-12-24
**Maintainer**: Kubernaut Team










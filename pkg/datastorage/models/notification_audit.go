package models

import "time"

// NotificationAudit represents a notification audit record
// Authority: migrations/010_audit_write_api_phase1.sql
// Schema: docs/services/crd-controllers/06-notification/database-integration.md
// Specification: docs/services/crd-controllers/06-notification/audit-trace-specification.md
//
// This model maps directly to the notification_audit PostgreSQL table.
// All fields match the database schema for accurate persistence and retrieval.
//
// Business Requirements:
// - BR-NOTIFICATION-001: Track all notification delivery attempts for compliance
// - BR-NOTIFICATION-002: Record notification failures for debugging and retry logic
// - BR-NOTIFICATION-003: Capture escalation events for SLA tracking
// - BR-NOTIFICATION-004: Enable V2.0 Remediation Analysis Report (RAR) timeline reconstruction
type NotificationAudit struct {
	// ID is the unique identifier for the audit record (auto-generated by database)
	ID int64 `json:"id" db:"id"`

	// RemediationID links this notification to the parent RemediationRequest CRD
	// Maps to: notification_audit.remediation_id (VARCHAR(255) NOT NULL)
	RemediationID string `json:"remediation_id" db:"remediation_id" validate:"required,max=255"`

	// NotificationID is the unique identifier for the NotificationRequest CRD
	// Maps to: notification_audit.notification_id (VARCHAR(255) NOT NULL UNIQUE)
	NotificationID string `json:"notification_id" db:"notification_id" validate:"required,max=255"`

	// Recipient is the target recipient (e.g., email address, Slack user ID, PagerDuty service)
	// Maps to: notification_audit.recipient (VARCHAR(255) NOT NULL)
	Recipient string `json:"recipient" db:"recipient" validate:"required,max=255"`

	// Channel is the communication channel (e.g., "email", "slack", "pagerduty", "sms")
	// Maps to: notification_audit.channel (VARCHAR(50) NOT NULL)
	Channel string `json:"channel" db:"channel" validate:"required,oneof=email slack pagerduty sms"`

	// MessageSummary is a short summary of the notification content
	// Maps to: notification_audit.message_summary (TEXT NOT NULL)
	MessageSummary string `json:"message_summary" db:"message_summary" validate:"required"`

	// Status is the notification status (sent, failed, acknowledged, escalated)
	// Maps to: notification_audit.status (VARCHAR(50) NOT NULL CHECK (status IN ('sent', 'failed', 'acknowledged', 'escalated')))
	Status string `json:"status" db:"status" validate:"required,oneof=sent failed acknowledged escalated"`

	// SentAt is the timestamp when the notification was sent
	// Maps to: notification_audit.sent_at (TIMESTAMP WITH TIME ZONE NOT NULL)
	SentAt time.Time `json:"sent_at" db:"sent_at" validate:"required"`

	// DeliveryStatus is the detailed delivery status from the provider (e.g., "200 OK", "rate_limited")
	// Maps to: notification_audit.delivery_status (TEXT)
	DeliveryStatus string `json:"delivery_status,omitempty" db:"delivery_status"`

	// ErrorMessage contains error details if the notification failed
	// Maps to: notification_audit.error_message (TEXT)
	ErrorMessage string `json:"error_message,omitempty" db:"error_message"`

	// EscalationLevel is the escalation count (0 = initial, 1 = first escalation, etc.)
	// Maps to: notification_audit.escalation_level (INTEGER DEFAULT 0)
	EscalationLevel int `json:"escalation_level" db:"escalation_level" validate:"min=0"`

	// CreatedAt is the timestamp when the audit record was created
	// Maps to: notification_audit.created_at (TIMESTAMP WITH TIME ZONE DEFAULT NOW())
	CreatedAt time.Time `json:"created_at" db:"created_at"`

	// UpdatedAt is the timestamp when the audit record was last updated
	// Maps to: notification_audit.updated_at (TIMESTAMP WITH TIME ZONE DEFAULT NOW())
	UpdatedAt time.Time `json:"updated_at" db:"updated_at"`
}

// Validate performs business logic validation on the NotificationAudit struct
// This is called before persisting to the database to ensure data integrity
func (n *NotificationAudit) Validate() error {
	// Validation is handled by struct tags and the validator package
	// Additional business logic validation can be added here if needed
	return nil
}

// TableName returns the PostgreSQL table name for this model
// This is used by the database layer for query generation
func (n *NotificationAudit) TableName() string {
	return "notification_audit"
}

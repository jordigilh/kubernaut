-- +goose Up
-- +goose StatementBegin

-- ========================================
-- MIGRATION 019: UUID Primary Key for Workflow Catalog
-- ========================================
-- Authority: DD-WORKFLOW-002 v3.0 (UUID Primary Key)
-- Authority: DD-WORKFLOW-012 v2.0 (Workflow Immutability - UUID)
-- Business Requirement: BR-STORAGE-012 (Workflow Semantic Search)
-- ========================================
--
-- Purpose: Change workflow_id from VARCHAR to UUID (auto-generated)
--
-- Key Changes:
-- 1. workflow_id becomes UUID PRIMARY KEY (auto-generated)
-- 2. Add workflow_name column (human-readable identifier)
-- 3. UNIQUE constraint on (workflow_name, version) to prevent duplicates
-- 4. Update indexes for new schema
--
-- IMMUTABILITY (DD-WORKFLOW-012 v2.0):
-- - workflow_id (UUID) is the single immutable identifier
-- - workflow_name + version provides human-readable uniqueness
-- - Content fields remain immutable
--
-- ========================================

-- Enable uuid-ossp extension for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Step 1: Add new workflow_name column
ALTER TABLE remediation_workflow_catalog
    ADD COLUMN workflow_name VARCHAR(255);

-- Step 2: Copy existing workflow_id to workflow_name (for existing data)
UPDATE remediation_workflow_catalog
SET workflow_name = workflow_id;

-- Step 3: Make workflow_name NOT NULL
ALTER TABLE remediation_workflow_catalog
    ALTER COLUMN workflow_name SET NOT NULL;

-- Step 4: Drop existing primary key constraint
ALTER TABLE remediation_workflow_catalog
    DROP CONSTRAINT remediation_workflow_catalog_pkey;

-- Step 5: Drop existing indexes that reference workflow_id
DROP INDEX IF EXISTS idx_workflow_catalog_latest;

-- Step 6: Create temporary column for new UUID
ALTER TABLE remediation_workflow_catalog
    ADD COLUMN new_workflow_id UUID DEFAULT uuid_generate_v4();

-- Step 7: Generate UUIDs for existing rows
UPDATE remediation_workflow_catalog
SET new_workflow_id = uuid_generate_v4();

-- Step 8: Drop old workflow_id column
ALTER TABLE remediation_workflow_catalog
    DROP COLUMN workflow_id;

-- Step 9: Rename new_workflow_id to workflow_id
ALTER TABLE remediation_workflow_catalog
    RENAME COLUMN new_workflow_id TO workflow_id;

-- Step 10: Set workflow_id as NOT NULL
ALTER TABLE remediation_workflow_catalog
    ALTER COLUMN workflow_id SET NOT NULL;

-- Step 11: Remove default (UUIDs should be generated by application or trigger)
ALTER TABLE remediation_workflow_catalog
    ALTER COLUMN workflow_id SET DEFAULT uuid_generate_v4();

-- Step 12: Add new primary key on workflow_id (UUID)
ALTER TABLE remediation_workflow_catalog
    ADD PRIMARY KEY (workflow_id);

-- Step 13: Add unique constraint on (workflow_name, version)
ALTER TABLE remediation_workflow_catalog
    ADD CONSTRAINT uq_workflow_name_version UNIQUE (workflow_name, version);

-- ========================================
-- RECREATE INDEXES FOR NEW SCHEMA
-- ========================================

-- Index for latest version queries (by workflow_name)
CREATE INDEX idx_workflow_catalog_latest_by_name
    ON remediation_workflow_catalog(workflow_name, is_latest_version)
    WHERE is_latest_version = true;

-- Index for workflow_name lookups
CREATE INDEX idx_workflow_catalog_workflow_name
    ON remediation_workflow_catalog(workflow_name);

-- ========================================
-- UPDATE COMMENTS
-- ========================================
COMMENT ON COLUMN remediation_workflow_catalog.workflow_id IS 'UUID primary key (auto-generated, DD-WORKFLOW-002 v3.0)';
COMMENT ON COLUMN remediation_workflow_catalog.workflow_name IS 'Human-readable workflow identifier (e.g., "pod-oom-recovery")';

-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin

-- Reverse the migration (restore composite primary key)

-- Step 1: Drop new indexes
DROP INDEX IF EXISTS idx_workflow_catalog_latest_by_name;
DROP INDEX IF EXISTS idx_workflow_catalog_workflow_name;

-- Step 2: Drop unique constraint
ALTER TABLE remediation_workflow_catalog
    DROP CONSTRAINT IF EXISTS uq_workflow_name_version;

-- Step 3: Drop primary key
ALTER TABLE remediation_workflow_catalog
    DROP CONSTRAINT remediation_workflow_catalog_pkey;

-- Step 4: Create temporary column for old workflow_id
ALTER TABLE remediation_workflow_catalog
    ADD COLUMN old_workflow_id VARCHAR(255);

-- Step 5: Copy workflow_name to old_workflow_id
UPDATE remediation_workflow_catalog
SET old_workflow_id = workflow_name;

-- Step 6: Drop UUID workflow_id column
ALTER TABLE remediation_workflow_catalog
    DROP COLUMN workflow_id;

-- Step 7: Rename old_workflow_id to workflow_id
ALTER TABLE remediation_workflow_catalog
    RENAME COLUMN old_workflow_id TO workflow_id;

-- Step 8: Set workflow_id as NOT NULL
ALTER TABLE remediation_workflow_catalog
    ALTER COLUMN workflow_id SET NOT NULL;

-- Step 9: Drop workflow_name column
ALTER TABLE remediation_workflow_catalog
    DROP COLUMN workflow_name;

-- Step 10: Restore composite primary key
ALTER TABLE remediation_workflow_catalog
    ADD PRIMARY KEY (workflow_id, version);

-- Step 11: Restore original index
CREATE INDEX idx_workflow_catalog_latest
    ON remediation_workflow_catalog(workflow_id, is_latest_version)
    WHERE is_latest_version = true;

-- +goose StatementEnd


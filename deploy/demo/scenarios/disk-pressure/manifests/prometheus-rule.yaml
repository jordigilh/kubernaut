apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: disk-pressure-rules
  namespace: demo-disk
  labels:
    release: prometheus
spec:
  groups:
  - name: disk-pressure
    rules:
    # Detect PVCs in namespace that are bound but owned by completed/failed Jobs.
    # "count by (namespace)" preserves the namespace label so AlertManager can
    # route the alert to the gateway-webhook receiver via match_re: demo-.*
    - alert: KubePersistentVolumeClaimOrphaned
      expr: |
        count by (namespace)(
          kube_persistentvolumeclaim_status_phase{
            namespace="demo-disk",
            phase="Bound"
          }
        ) > 3
      for: 2m
      labels:
        severity: warning
        deployment: data-processor
      annotations:
        summary: >
          Namespace {{ $labels.namespace }} has more than 3 bound PVCs, indicating
          possible orphaned storage from completed batch jobs.
        description: >
          The demo-disk namespace has accumulated multiple bound PVCs that may be
          from completed or failed batch jobs. These orphaned PVCs consume storage
          and may contribute to node disk pressure. Cleanup of PVCs not attached
          to running pods is recommended.

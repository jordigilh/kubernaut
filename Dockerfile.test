FROM golang:1.23.9-alpine AS builder

# Install dependencies
RUN apk add --no-cache git curl bash

# Set working directory
WORKDIR /app

# Copy go mod and sum files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Build the test binary (optional, for caching)
RUN go test -c -tags=integration ./test/integration/... || true

FROM golang:1.23.9-alpine AS test-runner

# Install runtime dependencies
RUN apk add --no-cache curl bash jq

# Set up non-root user for security
RUN adduser -D -s /bin/bash testuser

# Set working directory
WORKDIR /app

# Copy from builder
COPY --from=builder /go/pkg/mod /go/pkg/mod
COPY --from=builder /root/.cache/go-build /root/.cache/go-build

# Copy source code
COPY . .

# Ensure proper permissions
RUN chown -R testuser:testuser /app

# Switch to non-root user
USER testuser

# Set environment variables
ENV CGO_ENABLED=0
ENV GOOS=linux
ENV GOARCH=amd64

# Default command
CMD ["go", "test", "-v", "-tags=integration", "./test/integration/...", "-timeout=30m"]
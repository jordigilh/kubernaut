openapi: 3.0.3
info:
  title: Data Storage Service API
  version: 1.0.0
  description: |
    Data Storage Service provides REST API access to audit trail persistence.

    **Business Requirements**:
    - BR-STORAGE-001 to BR-STORAGE-020: Audit write API
    - BR-STORAGE-021: Incident query API (READ)
    - BR-STORAGE-024: RFC 7807 error responses
    - BR-AUDIT-006: Legal hold capability (SOC2 Gap #8)

    **Design Decisions**:
    - ADR-031: OpenAPI 3.0+ specification for all stateless REST APIs
    - ADR-032: Data Access Layer Isolation (only Data Storage connects to PostgreSQL)
    - DD-009: Dead Letter Queue fallback on database errors
    - DD-AUTH-004: OAuth-proxy sidecar for authentication/authorization
    - DD-AUTH-005: Client authentication pattern (ServiceAccount tokens)

    **Architecture**:
    This service is the **ONLY** service that directly accesses PostgreSQL.
    All other services (Context API, Effectiveness Monitor, etc.) access data
    through this REST API Gateway.

    **Authentication & Authorization (Production/E2E)**:
    All requests to DataStorage are protected by an OAuth-proxy sidecar:

    1. **Client Authentication**: Services authenticate with Kubernetes ServiceAccount tokens
       - Token mounted at: `/var/run/secrets/kubernetes.io/serviceaccount/token`
       - Clients inject: `Authorization: Bearer <token>` header
       - See DD-AUTH-005 for client implementation patterns

    2. **OAuth-Proxy Validation**: The sidecar validates requests
       - Validates JWT token signature and expiration
       - Performs Subject Access Review (SAR) to check RBAC permissions
       - Injects `X-Auth-Request-User` header with authenticated user identity
       - Returns HTTP 401 if token invalid, HTTP 403 if SAR fails

    3. **Handler Enforcement**: DataStorage handlers extract user identity
       - Legal hold operations REQUIRE `X-Auth-Request-User` header
       - HTTP 401 returned if header missing (authentication failed)
       - User identity stored in audit events for SOC2 compliance

    **Routing Flow**:
    ```
    Client → data-storage-service:8080 (Service)
           ↓
         oauth-proxy:8080 (validates token + SAR)
           ↓
         DataStorage:8081 (X-Auth-Request-User header)
    ```

    **Integration Tests**:
    Integration tests run without oauth-proxy. Use `testutil.NewMockUserTransport()`
    to inject mock `X-Auth-Request-User` headers directly.

    **SOC2 Compliance**:
    - All legal hold operations attributed to authenticated users
    - Audit trail captures placed_by/released_by from X-Auth-Request-User
    - Unauthorized access blocked at oauth-proxy layer (defense-in-depth)
  contact:
    name: Kubernaut Platform Team
    url: https://github.com/jordigilh/kubernaut
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: http://data-storage-service.kubernaut.svc.cluster.local:8080
    description: Kubernetes cluster service

tags:
  - name: Audit Write API
    description: |
      Audit trail persistence for all Kubernaut services.
      Implements BR-STORAGE-001 to BR-STORAGE-020.
  - name: Incident Read API
    description: |
      Query API for incident data.
      Implements BR-STORAGE-021.
  - name: Workflow Catalog API
    description: |
      Workflow catalog management and label-based search.
      Implements BR-STORAGE-013, BR-STORAGE-014.
      V1.0: Label-only search (no embeddings/semantic search).
  - name: Health
    description: Health check endpoints (DD-007 graceful shutdown support)
  - name: Metrics
    description: Prometheus metrics endpoint (BR-STORAGE-019)

paths:
  /api/v1/workflows/search:
    post:
      tags:
        - Workflow Catalog API
      summary: Label-based workflow search
      description: |
        Search workflows using label-based matching with wildcard support and weighted scoring.

        **V1.0 Implementation**: Pure SQL label matching (no embeddings/semantic search)

        **Business Requirement**: BR-STORAGE-013 (Label-Based Workflow Search)
        **Design Decision**: DD-WORKFLOW-004 v1.5 (Label-Only Scoring with Wildcard Weighting)

        **Behavior**:
        - Mandatory filters: signal_type, severity, component, environment, priority
        - Optional filters: custom_labels, detected_labels
        - Wildcard support: "*" matches any non-null value
        - Weighted scoring: Exact matches > Wildcard matches
        - Returns top_k results sorted by confidence score (0.0-1.0)
      operationId: searchWorkflows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowSearchRequest'
      responses:
        '200':
          description: Workflow search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowSearchResponse'
        '400':
          description: Validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'

  /api/v1/workflows:
    post:
      tags:
        - Workflow Catalog API
      summary: Create workflow
      description: |
        Create a new workflow in the catalog.

        **Business Requirement**: BR-STORAGE-014 (Workflow Catalog Management)
        **Design Decision**: DD-WORKFLOW-005 v1.0 (Direct REST API workflow registration)
      operationId: createWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemediationWorkflow'
      responses:
        '201':
          description: Workflow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '400':
          description: Validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
    get:
      tags:
        - Workflow Catalog API
      summary: List workflows
      description: |
        List workflows with optional filters and pagination.

        **Business Requirement**: BR-STORAGE-014 (Workflow Catalog Management)
      operationId: listWorkflows
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, disabled, deprecated, archived]
        - name: environment
          in: query
          schema:
            type: string
        - name: priority
          in: query
          schema:
            type: string
        - name: component
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 1000
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Workflow list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowListResponse'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'

  /api/v1/workflows/{workflow_id}:
    get:
      tags:
        - Workflow Catalog API
      summary: Get workflow by UUID
      description: |
        Retrieve a specific workflow by its UUID.

        **Design Decision**: DD-WORKFLOW-002 v3.0 (UUID primary key)
      operationId: getWorkflowByID
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '404':
          description: Workflow not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
    patch:
      tags:
        - Workflow Catalog API
      summary: Update workflow mutable fields
      description: |
        Update mutable workflow fields (status, metrics).
        Immutable fields (description, content, labels) require creating a new version.

        **Design Decision**: DD-WORKFLOW-012 (Mutable vs Immutable Fields)
      operationId: updateWorkflow
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowUpdateRequest'
      responses:
        '200':
          description: Workflow updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '400':
          description: Validation error (attempted to update immutable field)
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '404':
          description: Workflow not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'

  /api/v1/workflows/{workflow_id}/disable:
    patch:
      tags:
        - Workflow Catalog API
      summary: Disable workflow
      description: |
        Convenience endpoint to disable a workflow (soft delete).
        Sets status to 'disabled' with timestamp and reason.

        **Design Decision**: DD-WORKFLOW-012 (Convenience endpoint for soft-delete)
      operationId: disableWorkflow
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowDisableRequest'
      responses:
        '200':
          description: Workflow disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '404':
          description: Workflow not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'

  /api/v1/audit/events:
    post:
      tags:
        - Audit Write API
      summary: Create unified audit event
      description: |
        Persists a unified audit event to the audit_events table (ADR-034).

        **Business Requirement**: BR-STORAGE-033 (Unified audit trail)

        **Behavior**:
        - Success: Returns 201 Created with event_id
        - Validation Error: Returns 400 Bad Request (RFC 7807)
        - Database Error: Returns 202 Accepted (DLQ fallback, DD-009)
      operationId: createAuditEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditEventRequest'
      responses:
        '201':
          description: Audit event created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEventResponse'
        '202':
          description: Database write failed, queued to DLQ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEventResponse'
        '400':
          description: Validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
    get:
      tags:
        - Audit Write API
      summary: Query audit events
      description: Query audit events with filters and pagination
      operationId: queryAuditEvents
      parameters:
        - name: event_type
          in: query
          description: Filter by event type (ADR-034)
          schema:
            type: string
          example: "notification.message.sent"
        - name: event_category
          in: query
          description: Filter by event category (ADR-034)
          schema:
            type: string
          example: "notification"
        - name: event_outcome
          in: query
          description: Filter by event outcome (ADR-034)
          schema:
            type: string
            enum: [success, failure, pending]
          example: "success"
        - name: severity
          in: query
          description: Filter by severity level
          schema:
            type: string
          example: "critical"
        - name: correlation_id
          in: query
          description: Filter by correlation ID
          schema:
            type: string
          example: "rr-2025-001"
        - name: since
          in: query
          description: Start time (relative like "24h" or absolute RFC3339)
          schema:
            type: string
          example: "24h"
        - name: until
          in: query
          description: End time (absolute RFC3339)
          schema:
            type: string
          example: "2025-12-18T23:59:59Z"
        - name: limit
          in: query
          description: Page size (1-1000, default 50)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 1000
        - name: offset
          in: query
          description: Page offset (default 0)
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEventsQueryResponse'

  /api/v1/audit/events/batch:
    post:
      tags:
        - Audit Write API
      summary: Create audit events batch
      description: Write multiple audit events in a single request
      operationId: createAuditEventsBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/AuditEventRequest'
      responses:
        '201':
          description: Batch created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchAuditEventResponse'

  /api/v1/audit/notifications:
    post:
      tags:
        - Audit Write API
      summary: Create notification audit record
      description: |
        Persists a notification delivery attempt audit record.

        **Business Requirement**: BR-STORAGE-001 (Notification audit persistence)

        **Behavior**:
        - Success: Returns 201 Created with created record
        - Validation Error: Returns 400 Bad Request (RFC 7807)
        - Duplicate: Returns 409 Conflict (RFC 7807)
        - Database Error: Returns 202 Accepted (DLQ fallback, DD-009)

        **Metrics Emitted** (GAP-10):
        - `datastorage_audit_traces_total{service="notification", status="success|failure|dlq_fallback"}`
        - `datastorage_audit_lag_seconds{service="notification"}`
        - `datastorage_write_duration_seconds{table="notification_audit"}`
        - `datastorage_validation_failures_total{field="...", reason="..."}`
      operationId: createNotificationAudit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationAudit'
            examples:
              successful_delivery:
                summary: Successful notification delivery
                value:
                  remediation_id: "remediation-123"
                  notification_id: "notification-456"
                  recipient: "ops-team@example.com"
                  channel: "email"
                  message_summary: "Incident alert: High CPU usage on pod xyz"
                  status: "sent"
                  sent_at: "2025-11-03T12:00:00Z"
                  delivery_status: "200 OK"
                  escalation_level: 0
              failed_delivery:
                summary: Failed notification delivery
                value:
                  remediation_id: "remediation-789"
                  notification_id: "notification-abc"
                  recipient: "ops-team@example.com"
                  channel: "slack"
                  message_summary: "Incident alert: Database connection lost"
                  status: "failed"
                  sent_at: "2025-11-03T12:05:00Z"
                  delivery_status: "500 Internal Server Error"
                  error_message: "Slack API timeout after 30 seconds"
                  escalation_level: 1
      responses:
        '201':
          description: |
            Audit record created successfully in PostgreSQL.
            Record is immediately available for queries.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationAuditResponse'
              example:
                id: 1
                remediation_id: "remediation-123"
                notification_id: "notification-456"
                recipient: "ops-team@example.com"
                channel: "email"
                message_summary: "Incident alert: High CPU usage on pod xyz"
                status: "sent"
                sent_at: "2025-11-03T12:00:00Z"
                delivery_status: "200 OK"
                escalation_level: 0
                created_at: "2025-11-03T12:00:01Z"
                updated_at: "2025-11-03T12:00:01Z"
        '202':
          description: |
            Database write failed, audit record queued to Dead Letter Queue (DD-009).
            Record will be processed asynchronously.

            **Reason**: PostgreSQL temporarily unavailable or under load.
            **Recovery**: DLQ consumer will retry write every 30 seconds.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [accepted]
                  message:
                    type: string
                required:
                  - status
                  - message
              example:
                status: "accepted"
                message: "audit record queued for processing"
        '400':
          description: |
            Validation error - request body failed validation.
            Returns RFC 7807 Problem Details format (BR-STORAGE-024).
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
              example:
                type: "https://kubernaut.io/problems/validation-error"
                title: "Validation Error"
                status: 400
                detail: "One or more required fields are missing or invalid"
                instance: "/api/v1/audit/notifications"
                field_errors:
                  remediation_id: "remediation_id is required"
                  notification_id: "notification_id is required"
        '409':
          description: |
            Conflict - duplicate notification_id.
            Notification audit records use notification_id as unique constraint.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
              example:
                type: "https://kubernaut.io/problems/conflict"
                title: "Resource Conflict"
                status: 409
                detail: "notification_audit already exists with notification_id 'notification-456'"
                instance: "/api/v1/audit/notifications"
        '500':
          description: |
            Internal server error - both database and DLQ unavailable.
            This indicates a critical system failure requiring immediate attention.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
              example:
                type: "https://kubernaut.io/problems/service-unavailable"
                title: "Service Unavailable"
                status: 500
                detail: "database and DLQ both unavailable - please retry"
                instance: "/api/v1/audit/notifications"

  /api/v1/audit/legal-hold:
    post:
      tags:
        - Audit Write API
      summary: Place legal hold on audit events
      description: |
        Places a legal hold on all audit events for a given correlation_id.
        Events with legal hold cannot be deleted (enforced by database trigger).

        **Business Requirement**: BR-AUDIT-006 (Legal Hold & Retention)
        **SOC2 Gap**: Gap #8 (Legal Hold enforcement for Sarbanes-Oxley, HIPAA)

        **Behavior**:
        - Success: Returns 200 OK with legal hold metadata
        - Validation Error: Returns 400 Bad Request (RFC 7807)
        - Not Found: Returns 404 Not Found if correlation_id doesn't exist
        - Unauthorized: Returns 401 if X-User-ID header missing

        **Authorization**: Requires X-User-ID header to track who placed the hold

        **Metrics Emitted**:
        - `datastorage_legal_hold_successes_total{operation="place"}`
        - `datastorage_legal_hold_failures_total{reason="missing_correlation_id|unauthorized|..."}`
      operationId: placeLegalHold
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - correlation_id
                - reason
              properties:
                correlation_id:
                  type: string
                  description: Correlation ID of events to place legal hold on
                  example: "remediation-123"
                reason:
                  type: string
                  description: Reason for legal hold (e.g., "litigation", "investigation")
                  example: "SEC investigation case #2025-001"
      responses:
        '200':
          description: Legal hold placed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  correlation_id:
                    type: string
                  events_affected:
                    type: integer
                  placed_by:
                    type: string
                  placed_at:
                    type: string
                    format: date-time
                  reason:
                    type: string
        '400':
          description: Validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '401':
          description: Unauthorized - X-User-ID header required
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '404':
          description: Not Found - correlation_id doesn't exist
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
    get:
      tags:
        - Audit Write API
      summary: List all active legal holds
      description: |
        Returns a list of all active legal holds across all audit events.

        **Business Requirement**: BR-AUDIT-006 (Legal Hold & Retention)
        **SOC2 Gap**: Gap #8 (Legal Hold enforcement)

        **Behavior**:
        - Success: Returns 200 OK with array of active legal holds
        - No holds: Returns empty array

        **Authorization**: No authentication required (read-only operation)

        **Metrics Emitted**:
        - `datastorage_legal_hold_successes_total{operation="list"}`
      operationId: listLegalHolds
      responses:
        '200':
          description: List of active legal holds
          content:
            application/json:
              schema:
                type: object
                properties:
                  holds:
                    type: array
                    items:
                      type: object
                      properties:
                        correlation_id:
                          type: string
                        events_affected:
                          type: integer
                        placed_by:
                          type: string
                        placed_at:
                          type: string
                          format: date-time
                        reason:
                          type: string
                  total:
                    type: integer

  /api/v1/audit/legal-hold/{correlation_id}:
    delete:
      tags:
        - Audit Write API
      summary: Release legal hold on audit events
      description: |
        Releases a legal hold on all audit events for a given correlation_id.
        Events can be deleted after legal hold is released.

        **Business Requirement**: BR-AUDIT-006 (Legal Hold & Retention)
        **SOC2 Gap**: Gap #8 (Legal Hold enforcement)

        **Behavior**:
        - Success: Returns 200 OK with release metadata
        - Validation Error: Returns 400 Bad Request (RFC 7807)
        - Not Found: Returns 404 Not Found if legal hold doesn't exist
        - Unauthorized: Returns 401 if X-User-ID header missing

        **Authorization**: Requires X-User-ID header to track who released the hold

        **Metrics Emitted**:
        - `datastorage_legal_hold_successes_total{operation="release"}`
        - `datastorage_legal_hold_failures_total{reason="unauthorized|not_found|..."}`
      operationId: releaseLegalHold
      parameters:
        - name: correlation_id
          in: path
          required: true
          schema:
            type: string
          description: Correlation ID of events to release legal hold from
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - release_reason
              properties:
                release_reason:
                  type: string
                  description: Reason for releasing legal hold
                  example: "Case closed"
      responses:
        '200':
          description: Legal hold released successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  correlation_id:
                    type: string
                  events_released:
                    type: integer
                  released_by:
                    type: string
                  released_at:
                    type: string
                    format: date-time
        '400':
          description: Validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '401':
          description: Unauthorized - X-User-ID header required
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'
        '404':
          description: Not Found - legal hold doesn't exist for correlation_id
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Problem'

  /health:
    get:
      tags:
        - Health
      summary: Overall health check
      description: |
        Returns 200 if service is healthy (database and Redis reachable).
        Used by Kubernetes liveness probe (DD-007).
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                example:
                  status: "healthy"
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [unhealthy]
                  error:
                    type: string
                example:
                  status: "unhealthy"
                  error: "database connection failed"

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: |
        Returns 200 if service is ready to accept traffic.
        Returns 503 during graceful shutdown (DD-007 4-step pattern).
        Used by Kubernetes readiness probe.
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
        '503':
          description: Service is shutting down (not ready for new requests)

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness check
      description: |
        Returns 200 if service process is alive.
        Does not check dependencies.
        Used by Kubernetes liveness probe.
      operationId: livenessCheck
      responses:
        '200':
          description: Service is alive

  /metrics:
    get:
      tags:
        - Metrics
      summary: Prometheus metrics
      description: |
        Exposes Prometheus metrics in text format.

        **Metrics Exposed** (BR-STORAGE-019, GAP-10):
        - `datastorage_audit_traces_total{service,status}` - Audit write operations
        - `datastorage_audit_lag_seconds{service}` - Time between event and audit write
        - `datastorage_write_duration_seconds{table}` - Database write latency
        - `datastorage_validation_failures_total{field,reason}` - Validation errors
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP datastorage_audit_traces_total Total number of audit traces written by service and status
                # TYPE datastorage_audit_traces_total counter
                datastorage_audit_traces_total{service="notification",status="success"} 42
                datastorage_audit_traces_total{service="notification",status="dlq_fallback"} 3

                # HELP datastorage_audit_lag_seconds Time lag between event occurrence and audit write in seconds
                # TYPE datastorage_audit_lag_seconds histogram
                datastorage_audit_lag_seconds_bucket{service="notification",le="0.1"} 10
                datastorage_audit_lag_seconds_bucket{service="notification",le="0.5"} 35
                datastorage_audit_lag_seconds_bucket{service="notification",le="1"} 42

components:
  schemas:
    NotificationAudit:
      type: object
      description: |
        Notification audit record for tracking delivery attempts.
        Maps to `notification_audit` PostgreSQL table.
      required:
        - remediation_id
        - notification_id
        - recipient
        - channel
        - message_summary
        - status
        - sent_at
      properties:
        remediation_id:
          type: string
          maxLength: 255
          description: |
            Kubernetes RemediationRequest CRD name.
            Links notification to originating remediation workflow.
          example: "remediation-123"
        notification_id:
          type: string
          maxLength: 255
          description: |
            Unique notification identifier from Notification Controller.
            Used as unique constraint to prevent duplicate audit records.
          example: "notification-456"
        recipient:
          type: string
          maxLength: 500
          description: |
            Notification recipient (email address, Slack channel, PagerDuty key, etc.).
            Format depends on channel type.
          example: "ops-team@example.com"
        channel:
          type: string
          maxLength: 50
          enum:
            - email
            - slack
            - pagerduty
            - webhook
          description: |
            Notification delivery channel.
            Determines recipient format and delivery mechanism.
          example: "email"
        message_summary:
          type: string
          maxLength: 1000
          description: |
            Human-readable summary of notification content.
            Truncated to 1000 characters for audit purposes.
          example: "Incident alert: High CPU usage on pod xyz"
        status:
          type: string
          maxLength: 50
          enum:
            - sent
            - failed
            - pending
          description: |
            Notification delivery status from Notification Controller.
          example: "sent"
        sent_at:
          type: string
          format: date-time
          description: |
            Timestamp when notification was sent (RFC 3339 format).
            Used to calculate audit lag (time between event and audit write).
          example: "2025-11-03T12:00:00Z"
        delivery_status:
          type: string
          maxLength: 255
          nullable: true
          description: |
            HTTP status code or delivery confirmation from notification channel.
            Optional - only present for sent notifications.
          example: "200 OK"
        error_message:
          type: string
          maxLength: 1000
          nullable: true
          description: |
            Error message from notification channel if delivery failed.
            Optional - only present for failed notifications.
          example: "Slack API timeout after 30 seconds"
        escalation_level:
          type: integer
          minimum: 0
          maximum: 5
          description: |
            Escalation level for notification (0 = first attempt, 1+ = escalated).
            Tracks how many times this incident has been escalated.
          example: 0

    NotificationAuditResponse:
      allOf:
        - $ref: '#/components/schemas/NotificationAudit'
        - type: object
          required:
            - id
            - created_at
            - updated_at
          properties:
            id:
              type: integer
              format: int64
              description: |
                Auto-generated primary key from PostgreSQL.
              example: 1
            created_at:
              type: string
              format: date-time
              description: |
                Timestamp when record was created in PostgreSQL.
              example: "2025-11-03T12:00:01Z"
            updated_at:
              type: string
              format: date-time
              description: |
                Timestamp when record was last updated in PostgreSQL.
              example: "2025-11-03T12:00:01Z"

    RFC7807Problem:
      type: object
      description: |
        RFC 7807 Problem Details for HTTP APIs.
        Standard error response format (BR-STORAGE-024).
        See: https://www.rfc-editor.org/rfc/rfc7807.html
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: |
            URI reference identifying the problem type.
            Dereferenceable URI when possible.
          example: "https://kubernaut.io/problems/validation-error"
        title:
          type: string
          description: |
            Short, human-readable summary of the problem type.
            Should not change from occurrence to occurrence.
          example: "Validation Error"
        status:
          type: integer
          format: int32
          description: |
            HTTP status code for this occurrence.
          example: 400
        detail:
          type: string
          description: |
            Human-readable explanation specific to this occurrence.
          example: "One or more required fields are missing or invalid"
        instance:
          type: string
          format: uri
          description: |
            URI reference identifying the specific occurrence.
          example: "/api/v1/audit/notifications"
        field_errors:
          type: object
          additionalProperties:
            type: string
          description: |
            Map of field names to error messages for validation errors.
            Only present for 400 Bad Request responses.
          example:
            remediation_id: "remediation_id is required"
            notification_id: "notification_id is required"

    AuditEventRequest:
      type: object
      required:
        - version
        - event_type
        - event_timestamp
        - event_category
        - event_action
        - event_outcome
        - correlation_id
        - event_data
      properties:
        version:
          type: string
          minLength: 1
          maxLength: 20
          description: Schema version (e.g., "1.0")
          example: "1.0"
        event_type:
          type: string
          minLength: 1
          maxLength: 100
          description: Event type identifier (e.g., gateway.signal.received)
          example: gateway.signal.received
        event_timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the event occurred
          example: "2025-12-13T02:00:00Z"
        event_category:
          type: string
          minLength: 1
          maxLength: 50
          enum: [gateway, notification, analysis, signalprocessing, workflow, execution, orchestration, webhook]
          description: |
            Service-level event category (ADR-034 v1.4).
            Per ADR-034 v1.2: event_category MUST match the service name that emits the event.
            Values:
            - gateway: Gateway Service
            - notification: Notification Service
            - analysis: AI Analysis Service
            - signalprocessing: Signal Processing Service
            - workflow: Workflow Catalog Service
            - execution: Remediation Execution Service
            - orchestration: Remediation Orchestrator Service
            - webhook: Authentication Webhook Service (SOC2 CC8.1 operator attribution)
          example: gateway
        event_action:
          type: string
          minLength: 1
          maxLength: 50
          description: Action performed (ADR-034)
          example: received
        event_outcome:
          type: string
          enum: [success, failure, pending]
          description: Result of the event
          example: success
        actor_type:
          type: string
          example: service
        actor_id:
          type: string
          example: gateway-service
        resource_type:
          type: string
          example: Signal
        resource_id:
          type: string
          example: fp-abc123
        correlation_id:
          type: string
          minLength: 1
          maxLength: 255
          description: Unique identifier for request correlation
          example: rr-2025-001
        parent_event_id:
          type: string
          format: uuid
          nullable: true
        namespace:
          type: string
          nullable: true
        cluster_name:
          type: string
          nullable: true
        severity:
          type: string
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        event_data:
          description: |
            Service-specific event data as structured Go type.
            Accepts any JSON-marshalable type (structs, maps, etc.).
            V1.0: Eliminates map[string]interface{} - use structured types directly.
            See DD-AUDIT-004 for structured type requirements.
          x-go-type: interface{}
          x-go-type-skip-optional-pointer: true

    AuditEventResponse:
      type: object
      required:
        - event_id
        - event_timestamp
        - message
      properties:
        event_id:
          type: string
          format: uuid
        event_timestamp:
          type: string
          format: date-time
        message:
          type: string

    BatchAuditEventResponse:
      type: object
      properties:
        event_ids:
          type: array
          items:
            type: string
            format: uuid
        message:
          type: string

    AuditEventsQueryResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AuditEvent'
        pagination:
          type: object
          properties:
            limit:
              type: integer
              description: Maximum number of events per page
            offset:
              type: integer
              description: Number of events to skip
            total:
              type: integer
              description: Total number of events matching the query
            has_more:
              type: boolean
              description: Whether more results are available beyond current page

    AuditEvent:
      allOf:
        - $ref: '#/components/schemas/AuditEventRequest'
        - type: object
          properties:
            event_id:
              type: string
              format: uuid
            event_date:
              type: string
              format: date
              nullable: true
              description: "Date of the event (YYYY-MM-DD). Nullable to handle format mismatches from DataStorage."

    # ========================================
    # WORKFLOW CATALOG SCHEMAS
    # ========================================
    # Authority: pkg/datastorage/models/workflow.go
    # V1.0: Label-only search (no embeddings/semantic search)

    WorkflowSearchRequest:
      type: object
      required:
        - filters
      properties:
        remediation_id:
          type: string
          description: Optional remediation ID for audit correlation
        filters:
          $ref: '#/components/schemas/WorkflowSearchFilters'
        top_k:
          type: integer
          default: 10
          minimum: 1
          maximum: 100
          description: Maximum number of results to return
        min_score:
          type: number
          format: float
          default: 0.0
          minimum: 0.0
          maximum: 1.0
          description: Minimum normalized score threshold (0.0-1.0)
        include_disabled:
          type: boolean
          default: false
          description: Include disabled workflows in results

    WorkflowSearchFilters:
      type: object
      required:
        - signal_type
        - severity
        - component
        - environment
        - priority
      properties:
        signal_type:
          type: string
          description: "Signal type (mandatory: OOMKilled, CrashLoopBackOff, etc.)"
          example: "OOMKilled"
        severity:
          type: string
          description: "Severity level (mandatory: critical, high, medium, low)"
          enum: [critical, high, medium, low]
          example: "critical"
        component:
          type: string
          description: "Component type (mandatory: pod, node, deployment, etc.)"
          example: "pod"
        environment:
          type: string
          description: "Environment (mandatory: production, staging, development)"
          example: "production"
        priority:
          type: string
          description: "Priority level (mandatory: P0, P1, P2, P3)"
          enum: [P0, P1, P2, P3]
          example: "P0"
        custom_labels:
          $ref: '#/components/schemas/CustomLabels'
        detected_labels:
          $ref: '#/components/schemas/DetectedLabels'
        status:
          type: array
          items:
            type: string
            enum: [active, disabled, deprecated, archived]
          description: "Workflow lifecycle status filter"

    MandatoryLabels:
      type: object
      description: "5 mandatory workflow labels (DD-WORKFLOW-001 v2.3)"
      required:
        - signal_type
        - severity
        - component
        - environment
        - priority
      properties:
        signal_type:
          type: string
          description: "Signal type this workflow handles (e.g., OOMKilled, CrashLoopBackOff)"
          example: "OOMKilled"
        severity:
          type: string
          description: "Severity level this workflow is designed for"
          enum: [critical, high, medium, low]
          example: "critical"
        component:
          type: string
          description: "Kubernetes resource type this workflow targets (e.g., pod, deployment, node)"
          example: "pod"
        environment:
          type: string
          description: "Target environment (production, staging, development, test, * for any)"
          example: "production"
        priority:
          type: string
          description: "Business priority level (P0, P1, P2, P3, * for any)"
          enum: [P0, P1, P2, P3, "*"]
          example: "P0"

    CustomLabels:
      type: object
      description: "Customer-defined labels (DD-WORKFLOW-001 v1.5) - subdomain-based format"
      additionalProperties:
        type: array
        items:
          type: string
      example:
        team: ["name=payments"]
        constraint: ["cost-constrained", "stateful-safe"]

    DetectedLabels:
      type: object
      description: "Auto-detected labels from Kubernetes resources (DD-WORKFLOW-001 v2.3) - V1.0 structured types"
      properties:
        failed_detections:
          type: array
          items:
            type: string
            enum: [gitOpsManaged, pdbProtected, hpaEnabled, stateful, helmManaged, networkIsolated, serviceMesh]
          description: "Fields where detection failed (RBAC, timeout, etc.) - consumer should ignore these fields"
          example: ["pdbProtected", "networkIsolated"]
        gitOpsManaged:
          type: boolean
          description: "Resource is managed by GitOps (ArgoCD/Flux)"
        gitOpsTool:
          type: string
          description: "GitOps tool: argocd, flux, or * (wildcard = any tool)"
          enum: [argocd, flux, "*"]
          example: "argocd"
        pdbProtected:
          type: boolean
          description: "PodDisruptionBudget protects this workload"
        hpaEnabled:
          type: boolean
          description: "HorizontalPodAutoscaler is configured"
        stateful:
          type: boolean
          description: "Workload uses persistent storage or is StatefulSet"
        helmManaged:
          type: boolean
          description: "Resource is managed by Helm"
        networkIsolated:
          type: boolean
          description: "NetworkPolicy restricts traffic"
        serviceMesh:
          type: string
          description: "Service mesh type: istio, linkerd, or * (wildcard = any mesh)"
          enum: [istio, linkerd, "*"]
          example: "istio"

    WorkflowSearchResponse:
      type: object
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowSearchResult'
        total_results:
          type: integer
          description: Total number of matching workflows
        filters:
          $ref: '#/components/schemas/WorkflowSearchFilters'

    WorkflowSearchResult:
      type: object
      description: "Flat response structure (DD-WORKFLOW-002 v3.0)"
      required:
        - workflow_id
        - title
        - description
        - signal_type
        - confidence
        - final_score
        - rank
      properties:
        workflow_id:
          type: string
          format: uuid
          description: "UUID primary key (DD-WORKFLOW-002 v3.0)"
        title:
          type: string
          description: "Human-readable workflow name"
        description:
          type: string
          description: "Workflow description"
        signal_type:
          type: string
          description: "Signal type this workflow handles"
        container_image:
          type: string
          description: "OCI image reference"
          example: "ghcr.io/kubernaut/workflows/oomkill:v1.0.0@sha256:abc123..."
        container_digest:
          type: string
          description: "OCI image digest"
          example: "sha256:abc123..."
        confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: "Normalized label score (0.0-1.0)"
        label_boost:
          type: number
          format: float
          minimum: 0.0
          maximum: 0.39
          description: "Boost from matching DetectedLabels"
        label_penalty:
          type: number
          format: float
          minimum: 0.0
          maximum: 0.20
          description: "Penalty from conflicting DetectedLabels"
        final_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: "Final normalized score (same as confidence)"
        rank:
          type: integer
          minimum: 1
          description: "Position in result set (1-based)"
        custom_labels:
          $ref: '#/components/schemas/CustomLabels'
        detected_labels:
          $ref: '#/components/schemas/DetectedLabels'

    RemediationWorkflow:
      type: object
      required:
        - workflow_name
        - version
        - name
        - description
        - content
        - content_hash
        - labels
        - execution_engine
        - status
      properties:
        workflow_id:
          type: string
          format: uuid
          description: "Unique workflow identifier (UUID, auto-generated)"
        workflow_name:
          type: string
          maxLength: 255
          description: "Workflow name (identifier for versions)"
        version:
          type: string
          maxLength: 50
          description: "Semantic version (e.g., v1.0.0)"
        name:
          type: string
          maxLength: 255
          description: "Human-readable workflow title"
        description:
          type: string
          description: "Workflow description"
        owner:
          type: string
          maxLength: 255
          description: "Workflow owner"
        maintainer:
          type: string
          maxLength: 255
          format: email
          description: "Workflow maintainer email"
        content:
          type: string
          description: "YAML workflow definition"
        content_hash:
          type: string
          minLength: 64
          maxLength: 64
          description: "SHA-256 hash of content"
        parameters:
          type: object
          description: "Workflow parameters (JSONB)"
        execution_engine:
          type: string
          description: "Execution engine (e.g., argo-workflows)"
        container_image:
          type: string
          description: "OCI image reference"
          example: "ghcr.io/kubernaut/workflows/oomkill:v1.0.0@sha256:abc123..."
        container_digest:
          type: string
          description: "OCI image digest"
          example: "sha256:abc123..."
        labels:
          $ref: '#/components/schemas/MandatoryLabels'
        custom_labels:
          $ref: '#/components/schemas/CustomLabels'
        detected_labels:
          $ref: '#/components/schemas/DetectedLabels'
        status:
          type: string
          enum: [active, disabled, deprecated, archived]
          description: "Workflow lifecycle status"
        disabled_at:
          type: string
          format: date-time
          description: "When workflow was disabled"
        disabled_by:
          type: string
          maxLength: 255
          description: "Who disabled the workflow"
        disabled_reason:
          type: string
          description: "Why workflow was disabled"
        is_latest_version:
          type: boolean
          description: "Is this the latest version?"
        previous_version:
          type: string
          maxLength: 50
          description: "Previous version identifier"
        deprecation_notice:
          type: string
          description: "Deprecation notice"
        version_notes:
          type: string
          description: "Version release notes"
        change_summary:
          type: string
          description: "Summary of changes in this version"
        approved_by:
          type: string
          maxLength: 255
          description: "Who approved this version"
        approved_at:
          type: string
          format: date-time
          description: "When this version was approved"
        expected_success_rate:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: "Expected success rate (0.0-1.0)"
        expected_duration_seconds:
          type: integer
          minimum: 0
          description: "Expected execution duration"
        actual_success_rate:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: "Actual success rate (0.0-1.0)"
        total_executions:
          type: integer
          minimum: 0
          description: "Total number of executions"
        successful_executions:
          type: integer
          minimum: 0
          description: "Number of successful executions"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string
          maxLength: 255
        updated_by:
          type: string
          maxLength: 255

    WorkflowListResponse:
      type: object
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/RemediationWorkflow'
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer

    WorkflowUpdateRequest:
      type: object
      description: "Update mutable workflow fields only (DD-WORKFLOW-012)"
      properties:
        status:
          type: string
          enum: [active, disabled, deprecated, archived]
          description: "Workflow status (mutable)"
        disabled_by:
          type: string
          description: "Who disabled the workflow"
        disabled_reason:
          type: string
          description: "Why the workflow was disabled"

    WorkflowDisableRequest:
      type: object
      description: "Convenience request to disable a workflow"
      properties:
        reason:
          type: string
          description: "Why the workflow is being disabled"
        updated_by:
          type: string
          description: "Who is disabling the workflow"

  securitySchemes:
    oauthProxyAuth:
      type: apiKey
      in: header
      name: X-Auth-Request-User
      description: |
        Authenticated user identity injected by OAuth-proxy sidecar.

        **Business Requirement**: BR-AUDIT-006 (Legal Hold & Retention)
        **SOC2 Gap**: Gap #8 (Audit trail for legal hold placement/release)
        **Design Decision**: DD-AUTH-004 (OAuth-proxy sidecar authentication)

        **How It Works**:
        1. Clients send requests with `Authorization: Bearer <ServiceAccount-token>`
        2. OAuth-proxy validates JWT token and checks RBAC (Subject Access Review)
        3. OAuth-proxy injects `X-Auth-Request-User` header with authenticated identity
        4. DataStorage handlers extract user identity for audit trail attribution

        **Production/E2E Behavior**:
        - OAuth-proxy automatically injects this header after successful authentication
        - Clients do NOT manually set this header
        - DataStorage handlers return HTTP 401 if header missing

        **Integration Test Behavior**:
        - Tests run without oauth-proxy sidecar
        - Tests use `testutil.NewMockUserTransport()` to inject mock header
        - Example: `X-Auth-Request-User: test-service@integration.test`

        **Header Value Format**:
        - ServiceAccount format: `system:serviceaccount:<namespace>:<name>`
        - Example: `system:serviceaccount:kubernaut-system:gateway-service`
        - Integration test format: `<service-name>@integration.test`

        **SOC2 Compliance**:
        This header enables attribution of legal hold operations to specific
        authenticated users, meeting SOC2 CC8.1 (tamper-evident logs) and
        AU-9 (protection of audit information) requirements.

        **See Also**:
        - DD-AUTH-005: Client authentication pattern documentation
        - deploy/data-storage/deployment.yaml: OAuth-proxy configuration
        - pkg/shared/auth/transport.go: Go client authentication
        - holmesgpt-api/src/clients/datastorage_auth_session.py: Python client


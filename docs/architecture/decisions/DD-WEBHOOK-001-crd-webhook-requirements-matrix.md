# DD-WEBHOOK-001: CRD Webhook Requirements Matrix

**Date**: December 20, 2025
**Status**: ‚úÖ **AUTHORITATIVE**
**Purpose**: Define WHEN and WHY CRDs require webhooks for authenticated user operations
**Authority**: Decision criteria for all CRD webhook implementations
**Scope**: All Kubernetes CRDs in Kubernaut requiring user authentication

---

## üéØ **DECISION**

**Not all CRDs require webhooks. Webhooks SHALL be implemented ONLY when CRD status updates require authenticated user identity for audit trail or operational decisions.**

**Decision Criteria**: A CRD requires a webhook if it meets ANY of these conditions:
1. **Manual Intervention**: Users manually modify status fields as operational decisions
2. **SOC2 Attribution**: Changes require capturing WHO made the decision (CC8.1)
3. **Approval Workflows**: Human operators approve/reject automated actions
4. **Override Actions**: Users override controller-determined state

---

## üìä **CRD Webhook Requirements Matrix**

### **CRDs Requiring Webhooks** ‚úÖ

| CRD | Use Case | Status Fields Requiring Auth | SOC2 Control | Implementation Owner | Priority | Target Version |
|-----|----------|------------------------------|--------------|----------------------|----------|----------------|
| **WorkflowExecution** | Block Clearance | `status.blockClearanceRequest` | CC8.1 (Attribution) | WE Team | P0 | v1.0 |
| **RemediationApprovalRequest** | Approval Decisions | `status.approvalRequest` | CC8.1 (Attribution) | RO Team | P0 | v1.0 |

### **CRDs NOT Requiring Webhooks** ‚ùå

| CRD | Why No Webhook | Status Update Pattern |
|-----|----------------|----------------------|
| **SignalProcessing** | Controller-only status | Controller manages K8s context enrichment |
| **AIAnalysis** | Controller-only status | Controller manages AI investigation results |
| **RemediationRequest** | Controller-only status | RO controller manages routing logic |
| **NotificationRequest** | Controller-only status | Controller manages notification delivery status |

**Note**: **KubernetesExecution** was deprecated 2025-10-19 (never implemented, replaced by Tekton Pipelines). See [DEPRECATED.md](../../services/crd-controllers/04-kubernetesexecutor/DEPRECATED.md)

---

## üîç **Decision Criteria - Detailed**

### **Criterion 1: Manual Intervention Required**

**When**: Human operators must manually modify CRD status as operational decisions.

**Examples**:
- ‚úÖ **WorkflowExecution**: Operator clears `PreviousExecutionFailed` block after manual investigation
- ‚úÖ **RemediationApprovalRequest**: Operator approves/rejects remediation after risk assessment
- ‚ùå **SignalProcessing**: Status updated automatically by controller (no manual intervention)

**Test**: Ask "Does a human operator need to manually patch this status field?"
- If YES ‚Üí Webhook required
- If NO ‚Üí No webhook needed

---

### **Criterion 2: SOC2 Attribution (CC8.1)**

**When**: Changes must capture authenticated user identity for compliance audits.

**SOC2 Control CC8.1**: "The entity identifies, captures, and retains sufficient, reliable information to achieve its service commitments and system requirements."

**Examples**:
- ‚úÖ **WorkflowExecution Block Clearance**: Must record WHO cleared the block (SOC2 CC8.1)
- ‚úÖ **RemediationApprovalRequest**: Must record WHO approved remediation (SOC2 CC8.1)
- ‚ùå **AIAnalysis Investigation Status**: No attribution needed (automated AI investigation)

**Test**: Ask "Does SOC2 auditor need to know WHO made this change?"
- If YES ‚Üí Webhook required
- If NO ‚Üí No webhook needed

---

### **Criterion 3: Approval Workflows**

**When**: Human operators approve/reject automated actions before execution.

**Examples**:
- ‚úÖ **RemediationApprovalRequest**: Operator approves high-risk remediations
- ‚ùå **RemediationRequest**: Auto-generated by system (no approval needed)

**Test**: Ask "Does this require human approval before proceeding?"
- If YES ‚Üí Webhook required
- If NO ‚Üí No webhook needed

---

### **Criterion 4: Override Actions**

**When**: Users override controller-determined state based on operational judgment.

**Examples**:
- ‚úÖ **WorkflowExecution**: Operator overrides failure block to retry execution
- ‚ùå **NotificationRequest**: No override capability (automated processing)

**Test**: Ask "Can operators override the controller's decision?"
- If YES ‚Üí Webhook required
- If NO ‚Üí No webhook needed

---

## üìã **Detailed Use Case Specifications**

### **Use Case 1: WorkflowExecution Block Clearance**

**Business Requirement**: [BR-WE-013](../../requirements/BR-WE-013-audit-tracked-block-clearing.md)

**Scenario**: Workflow execution failed (`wasExecutionFailure: true`), blocking future executions. Operator investigates, fixes root cause, and clears block.

**Why Webhook Required**:
1. ‚úÖ **Manual Intervention**: Operator manually patches `status.blockClearanceRequest`
2. ‚úÖ **SOC2 CC8.1**: Must record WHO cleared block for audit trail
3. ‚úÖ **Override Action**: Operator overrides controller's failure block
4. ‚úÖ **Operational Decision**: Clearance requires human judgment (not automated)

**Status Fields Requiring Authentication**:
- **Operator Input** (unauthenticated): `status.blockClearanceRequest`
  - `clearReason`: Operator's explanation
  - `requestedAt`: Request timestamp
- **Webhook Output** (authenticated): `status.blockClearance`
  - `clearedBy`: Authenticated user from K8s auth context
  - `clearedAt`: Server-side timestamp
  - `clearReason`: Copied from request
  - `clearMethod`: "KubernetesAdmissionWebhook"

**Controller-Managed Fields** (NO webhook):
- `phase`, `message`, `conditions`, `consecutiveFailures`, `nextAllowedExecution`

**Implementation Owner**: WE Team

**Timeline**: 3-4 days (including shared library development)

**Reference**: [ADR-051](./ADR-051-operator-sdk-webhook-scaffolding.md)

---

### **Use Case 2: RemediationApprovalRequest Approval Decisions**

**Business Requirement**: [ADR-040](./ADR-040-remediation-approval-request-architecture.md) (if exists)

**Scenario**: High-risk remediation requires human approval before execution. Operator reviews context, makes decision, approves/rejects.

**Why Webhook Required**:
1. ‚úÖ **Manual Intervention**: Operator manually patches `status.approvalRequest`
2. ‚úÖ **SOC2 CC8.1**: Must record WHO approved/rejected remediation
3. ‚úÖ **Approval Workflow**: Explicit human approval required for high-risk actions
4. ‚úÖ **Operational Decision**: Approval requires human risk assessment

**Status Fields Requiring Authentication**:
- **Operator Input** (unauthenticated): `status.approvalRequest`
  - `decision`: "Approved" | "Rejected"
  - `decisionMessage`: Operator's rationale
  - `requestedAt`: Request timestamp
- **Webhook Output** (authenticated):
  - `decision`: Copied from request
  - `decidedBy`: Authenticated user from K8s auth context
  - `decidedAt`: Server-side timestamp
  - `decisionMessage`: Copied from request

**Controller-Managed Fields** (NO webhook):
- `phase`, `conditions`, `remediationStatus`, etc.

**Implementation Owner**: RO Team

**Timeline**: 2-3 days (reuses shared library from WE implementation)

**Reference**: [ADR-051](./ADR-051-operator-sdk-webhook-scaffolding.md)

---

## üö´ **Anti-Patterns - When NOT to Use Webhooks**

### **‚ùå Anti-Pattern 1: Controller-Only Status Updates**

**Scenario**: CRD status fields are ONLY updated by the controller (no manual intervention).

**Example**: `SignalProcessing` status
- `phase`: Controller manages signal processing lifecycle
- `lastProcessedTime`: Controller records processing timestamp
- `conditions`: Controller reports validation status

**Why No Webhook**: No human operator interaction ‚Üí No authentication needed

**Correct Approach**: Controller updates status directly (no webhook)

---

### **‚ùå Anti-Pattern 2: Spec-Only CRDs (No Status Subresource)**

**Scenario**: CRD has no status subresource or status is managed entirely by controller.

**Example**: Configuration-only CRDs
- No user-modifiable status fields
- Only spec fields (configuration)
- Status (if present) is read-only and controller-managed

**Why No Webhook**: No manual status updates ‚Üí No authentication needed

**Correct Approach**: No webhook (status is controller-managed or absent)

---

### **‚ùå Anti-Pattern 3: System-Generated Fields**

**Scenario**: Status fields are system-generated (not user-provided).

**Example**: `AIAnalysis` investigation results
- `investigationSummary`: Auto-generated by HolmesGPT AI
- `rootCauseAnalysis`: AI-generated analysis
- `workflowRecommendation`: AI-selected workflow

**Why No Webhook**: No human input ‚Üí No authentication needed (automated AI investigation)

**Correct Approach**: Controller updates status directly (no webhook)

---

### **‚ùå Anti-Pattern 4: Using Webhooks for Validation Only**

**Scenario**: Webhook used ONLY for field validation (not authentication).

**Example**: Validating `clearReason` length without capturing user identity

**Why Wrong**: Use CRD OpenAPI validation or ValidatingWebhookConfiguration instead

**Correct Approach**:
- **Simple validation**: Use OpenAPI schema validation in CRD
- **Complex validation**: Use ValidatingWebhookConfiguration (no mutation)
- **Authentication**: Use MutatingWebhookConfiguration (our pattern)

---

## üîß **Implementation Decision Tree**

```
Does CRD have a status subresource?
    ‚Üì NO ‚Üí No webhook needed
    ‚Üì YES
    ‚Üì
Do human operators manually modify status fields?
    ‚Üì NO ‚Üí No webhook needed (controller-only)
    ‚Üì YES
    ‚Üì
Does change require capturing authenticated user identity?
    ‚Üì NO ‚Üí Consider annotations or spec fields instead
    ‚Üì YES
    ‚Üì
Is this for SOC2 compliance (CC8.1 Attribution)?
    ‚Üì YES ‚Üí Webhook REQUIRED ‚úÖ
    ‚Üì NO
    ‚Üì
Is this an approval workflow or override action?
    ‚Üì YES ‚Üí Webhook REQUIRED ‚úÖ
    ‚Üì NO
    ‚Üì
    ‚Üí Reconsider design - webhook may not be necessary
```

---

## üìö **Implementation Checklist for Teams**

### **Phase 1: Requirements Validation** (1 hour)

- [ ] Verify CRD meets at least ONE decision criterion
- [ ] Identify specific status fields requiring authentication
- [ ] Document business requirement (BR-XXX-XXX format)
- [ ] Map to SOC2 controls if applicable
- [ ] Review [DD-WEBHOOK-001](./DD-WEBHOOK-001-crd-webhook-requirements-matrix.md) (this document)

### **Phase 2: Shared Library Review** (1 hour)

- [ ] Review `pkg/authwebhook` library implementation
- [ ] Understand `Authenticator.ExtractUser()` interface
- [ ] Understand `ValidateReason()` and `ValidateTimestamp()` helpers
- [ ] Review [ADR-051](./ADR-051-operator-sdk-webhook-scaffolding.md)

### **Phase 3: CRD Schema Changes** (2 hours)

- [ ] Add operator input field (e.g., `status.approvalRequest`)
- [ ] Add webhook output fields (e.g., `decidedBy`, `decidedAt`)
- [ ] Regenerate CRD manifests (`make manifests`)
- [ ] Update API documentation

### **Phase 4: Webhook Implementation** (8 hours)

- [ ] Scaffold webhook using operator-sdk
  ```bash
  kubebuilder create webhook \
      --group <group> \
      --version v1alpha1 \
      --kind <Kind> \
      --defaulting \
      --programmatic-validation
  ```
- [ ] Implement `Default()` method (mutation + authentication)
- [ ] Implement `ValidateUpdate()` method (mutual exclusion validation)
- [ ] Implement `isControllerServiceAccount()` helper
- [ ] Add controller bypass logic (both methods)
- [ ] Add mutual exclusion validation
- [ ] Wire webhook in `main.go`

### **Phase 5: Testing** (8 hours)

- [ ] Write 18+ unit tests
  - Authentication extraction
  - Controller bypass (both methods)
  - Mutual exclusion (bidirectional)
  - Validation logic
- [ ] Write 3+ integration tests (envtest)
- [ ] Write 2+ E2E tests (Kind cluster)
- [ ] Verify audit events emitted

### **Phase 6: SOC2 Compliance Validation** (4 hours)

- [ ] Document SOC2 control mapping (CC8.1, CC7.3, CC7.4, CC4.2)
- [ ] Verify audit trail completeness
- [ ] Test unauthorized access rejection
- [ ] Document compliance evidence

### **Phase 7: Documentation** (2 hours)

- [ ] Update service BUSINESS_REQUIREMENTS.md
- [ ] Create implementation plan document
- [ ] Update operator runbooks
- [ ] Document troubleshooting steps

---

## üéØ **Team Responsibility Matrix**

| CRD | Webhook Needed? | Implementation Owner | Shared Library Owner | Timeline | Dependencies |
|-----|----------------|----------------------|---------------------|----------|--------------|
| **WorkflowExecution** | ‚úÖ YES | WE Team | WE Team (creates shared lib) | 3-4 days | None (first implementation) |
| **RemediationApprovalRequest** | ‚úÖ YES | RO Team | WE Team (reuses shared lib) | 2-3 days | WE webhook complete |
| **SignalProcessing** | ‚ùå NO | N/A | N/A | N/A | N/A (K8s enrichment automated) |
| **AIAnalysis** | ‚ùå NO | N/A | N/A | N/A | N/A (AI investigation automated) |
| **RemediationRequest** | ‚ùå NO | N/A | N/A | N/A | N/A (routing automated) |
| **NotificationRequest** | ‚ùå NO | N/A | N/A | N/A | N/A (delivery automated) |

**Shared Library Ownership**:
- **WE Team**: Implements `pkg/authwebhook` (Day 1 of WE webhook work)
- **All Teams**: Reuse shared library for consistency

---

## üìÖ **Implementation Timeline - V1.0**

### **Sprint 1: WE Webhook Implementation** (3-4 days)

**Day 1** (WE Team):
- Implement `pkg/authwebhook` shared library
- Write 18 unit tests for shared library
- **Deliverable**: Reusable authentication library ‚úÖ

**Day 2-3** (WE Team):
- Scaffold WE webhook using operator-sdk
- Implement `Default()` and `ValidateUpdate()` methods
- Implement controller bypass and mutual exclusion
- Write 18 unit tests for webhook
- Write 3 integration tests
- **Deliverable**: WE webhook implementation ‚úÖ

**Day 4** (WE Team):
- Write 2 E2E tests
- SOC2 compliance validation
- Documentation
- **Deliverable**: WE webhook complete and documented ‚úÖ

### **Sprint 2: RO Webhook Implementation** (2-3 days)

**Day 1** (RO Team):
- Review `pkg/authwebhook` shared library
- Update RAR CRD schema
- Scaffold RO webhook using operator-sdk
- **Deliverable**: RO webhook scaffolding ‚úÖ

**Day 2** (RO Team):
- Implement `Default()` and `ValidateUpdate()` methods
- Implement controller bypass and mutual exclusion
- Write 18 unit tests for webhook
- Write 3 integration tests
- **Deliverable**: RO webhook implementation ‚úÖ

**Day 3** (RO Team):
- Write 2 E2E tests
- SOC2 compliance validation
- Documentation
- **Deliverable**: RO webhook complete and documented ‚úÖ

---

## üîê **SOC2 Compliance Requirements**

### **For CRDs Requiring Webhooks**

All webhooks MUST satisfy these SOC2 controls:

| Control | Requirement | Implementation | Validation |
|---------|-------------|----------------|------------|
| **CC8.1** - Attribution | Capture authenticated user identity | `req.UserInfo.Username` + `req.UserInfo.UID` | Audit events show real user |
| **CC7.3** - Immutability | Preserve original records (no deletion) | Original failed CRD preserved | Records not deleted on clearance |
| **CC7.4** - Completeness | No gaps in audit trail | All auth events recorded | 100% audit event coverage |
| **CC4.2** - Change Tracking | Track WHO made changes | Authenticated actor in audit event | User identity in all events |
| **CC6.1** - Integrity | Prevent status field forgery | Mutual exclusion validation | Users cannot modify controller fields |

**Compliance Validation Checklist**:
- [ ] All authenticated fields populated from K8s auth context (not user input)
- [ ] Audit events emitted for every authenticated operation
- [ ] Original CRD records preserved (not deleted)
- [ ] Unauthorized users rejected via RBAC
- [ ] Mutual exclusion prevents field forgery

---

## üö® **Must Gather - Webhook Troubleshooting**

### **Diagnostic Information for Webhook Issues**

**When webhook authentication fails, collect**:

1. **Webhook Logs**:
   ```bash
   kubectl logs -n kubernaut-system deployment/workflowexecution-controller | grep "webhook"
   ```

2. **Admission Request Details**:
   ```bash
   kubectl get events -n <namespace> --field-selector involvedObject.name=<crd-name>
   ```

3. **User Authentication Context**:
   ```bash
   kubectl auth can-i update workflowexecutions/status --as=<username> -n <namespace>
   ```

4. **Webhook Configuration**:
   ```bash
   kubectl get mutatingwebhookconfigurations -o yaml | grep workflowexecution
   ```

5. **Certificate Validity**:
   ```bash
   kubectl get certificate -n kubernaut-system <webhook-cert-name> -o yaml
   ```

6. **ServiceAccount Bypass Check**:
   ```bash
   # Check if request is from controller SA
   kubectl get events -n <namespace> | grep "Bypassing webhook for controller ServiceAccount"
   ```

7. **Audit Events**:
   ```bash
   # Verify audit events recorded
   kubectl get auditevents -l event_type=workflowexecution.block.cleared
   ```

**Must Gather Script** (for support tickets):
```bash
#!/bin/bash
# must-gather-webhook.sh
NAMESPACE=${1:-kubernaut-system}
CRD_NAME=${2}

echo "=== Webhook Logs ==="
kubectl logs -n $NAMESPACE deployment/workflowexecution-controller --tail=100

echo "=== CRD Events ==="
kubectl get events -n $NAMESPACE --field-selector involvedObject.name=$CRD_NAME

echo "=== Webhook Config ==="
kubectl get mutatingwebhookconfigurations -o yaml | grep -A 20 workflowexecution

echo "=== Certificate Status ==="
kubectl get certificate -n $NAMESPACE -o wide

echo "=== Audit Events ==="
kubectl get auditevents -l event_type=workflowexecution.block.cleared --sort-by=.metadata.creationTimestamp | tail -10
```

---

## üìö **References**

### **Authoritative Documents**

1. **[ADR-051: Operator-SDK Webhook Scaffolding](./ADR-051-operator-sdk-webhook-scaffolding.md)** - HOW to implement webhooks
2. **[WEBHOOK_CONTROLLER_BYPASS_PATTERN_DEC_20_2025.md](../handoff/WEBHOOK_CONTROLLER_BYPASS_PATTERN_DEC_20_2025.md)** - Controller bypass pattern
3. **[BR-WE-013: Audit-Tracked Block Clearing](../requirements/BR-WE-013-audit-tracked-block-clearing.md)** - WE use case
4. **[INDEPENDENT_WEBHOOK_NOTIFICATION_TO_RO_TEAM_DEC_20_2025.md](../handoff/INDEPENDENT_WEBHOOK_NOTIFICATION_TO_RO_TEAM_DEC_20_2025.md)** - RO team notification

### **External References**

5. [SOC2 Trust Services Criteria](https://www.aicpa.org/interestareas/frc/assuranceadvisoryservices/socforserviceorganizations)
6. [Kubernetes Admission Webhooks](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/)

---

## ‚úÖ **Success Criteria**

This DD is successfully implemented when:

- ‚úÖ All teams understand WHEN webhooks are required (decision criteria)
- ‚úÖ All teams know HOW to implement webhooks (ADR-051 reference)
- ‚úÖ WE webhook implemented and SOC2 compliant
- ‚úÖ RO webhook implemented and SOC2 compliant
- ‚úÖ Shared library (`pkg/authwebhook`) reused across both webhooks
- ‚úÖ Must gather procedures documented and tested
- ‚úÖ No CRDs have unnecessary webhooks (anti-patterns avoided)

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0.2 | 2025-12-20 | **CRITICAL**: Removed KubernetesExecution CRD (deprecated 2025-10-19, never implemented, replaced by Tekton Pipelines). Verified all CRDs against authoritative BR documents. Added deprecation note referencing [DEPRECATED.md](../../services/crd-controllers/04-kubernetesexecutor/DEPRECATED.md). Updated examples with actual CRDs: SignalProcessing, AIAnalysis, RemediationRequest, NotificationRequest. |
| 1.0.1 | 2025-12-20 | Fixed CRD names to match actual kubernaut CRDs: KubernetesExecution (not KubernetesExecutor), SignalProcessing, AIAnalysis, NotificationRequest (removed invented CRDs: WorkflowDefinition, AlertForwarder, DataStorage). |
| 1.0 | 2025-12-20 | Initial DD: CRD webhook requirements matrix. Decision criteria for WHEN/WHY webhooks are needed. Team responsibility matrix. Implementation checklist. SOC2 compliance requirements. Must gather procedures. |

---

**Document Status**: ‚úÖ **AUTHORITATIVE**
**Version**: 1.0.2
**Authority**: Decision criteria for all CRD webhook implementations
**Next Review**: 2026-01-20 (1 month - after v1.0 release)


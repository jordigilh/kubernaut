# HolmesGPT API CI/CD Workflow
#
# Defense-in-Depth Testing Strategy for Python Service
# - Tier 1: Unit Tests (481 tests, <2 min)
# - Tier 2: Integration Tests (~5 min)
# - Tier 3: E2E Tests (deferred to V2.0)
#
# Authority: ADR-045 (OpenAPI Contract), docs/testing/APPROVED_CI_CD_STRATEGY.md
# Business Requirements: BR-HAPI-001 through BR-HAPI-200

name: HolmesGPT API CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'holmesgpt-api/**'
      - '.github/workflows/holmesgpt-api-ci.yml'
  push:
    branches: [main]
    paths:
      - 'holmesgpt-api/**'
      - '.github/workflows/holmesgpt-api-ci.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIR: holmesgpt-api

jobs:
  # ========================================
  # TIER 1: UNIT TESTS (< 2 minutes)
  # Coverage: 70%+ of BRs (481 tests)
  # ========================================
  unit-tests:
    name: Tier 1 - Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '${{ env.WORKING_DIR }}/requirements*.txt'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt 2>/dev/null || pip install pytest pytest-cov

      - name: Run unit tests (make test-unit)
        working-directory: ${{ env.WORKING_DIR }}
        run: make test-unit
        env:
          MOCK_LLM: 'true'

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: ${{ env.WORKING_DIR }}/htmlcov/
          retention-days: 7

  # ========================================
  # LINT & OPENAPI VALIDATION
  # ADR-045: Contract consistency check
  # ========================================
  lint-and-validate:
    name: Lint & OpenAPI Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '${{ env.WORKING_DIR }}/requirements*.txt'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff

      - name: Run linter (make lint)
        working-directory: ${{ env.WORKING_DIR }}
        run: make lint
        continue-on-error: true  # Don't fail CI for lint warnings in V1.0

      - name: Export OpenAPI spec (make export-openapi)
        working-directory: ${{ env.WORKING_DIR }}
        run: make export-openapi

      - name: Upload OpenAPI spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: ${{ env.WORKING_DIR }}/api/openapi.json
          retention-days: 30

  # ========================================
  # TIER 2: INTEGRATION TESTS (~5 min)
  # Coverage: >50% of BRs
  # ========================================
  integration-tests:
    name: Tier 2 - Integration Tests
    needs: [unit-tests, lint-and-validate]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '${{ env.WORKING_DIR }}/requirements*.txt'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt 2>/dev/null || pip install pytest pytest-cov

      - name: Run integration tests (make test-integration)
        working-directory: ${{ env.WORKING_DIR }}
        run: make test-integration
        env:
          MOCK_LLM: 'true'
          DATA_STORAGE_URL: 'http://localhost:8080'  # Mock endpoint

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: ${{ env.WORKING_DIR }}/htmlcov/
          retention-days: 7

  # ========================================
  # TIER 3: E2E TESTS (~15 min)
  # Uses Go infrastructure for Data Storage
  # ========================================
  e2e-tests:
    name: Tier 3 - E2E Tests
    needs: [integration-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '${{ env.WORKING_DIR }}/requirements*.txt'

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      - name: Install Python dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt 2>/dev/null || pip install pytest pytest-cov

      - name: Set up Data Storage infrastructure (Go)
        run: make test-e2e-datastorage
        timeout-minutes: 10

      - name: Run HAPI E2E tests
        run: make test-e2e-holmesgpt
        timeout-minutes: 10
        env:
          MOCK_LLM: 'true'

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: ${{ env.WORKING_DIR }}/htmlcov/
          retention-days: 7

      - name: Cleanup Kind cluster
        if: always()
        run: kind delete cluster --name datastorage-e2e 2>/dev/null || true

  # ========================================
  # ALL TESTS (Full Suite)
  # For manual runs and main branch
  # ========================================
  full-test-suite:
    name: Full Test Suite
    needs: [unit-tests, lint-and-validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '${{ env.WORKING_DIR }}/requirements*.txt'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt 2>/dev/null || pip install pytest pytest-cov

      - name: Run full test suite (make test)
        working-directory: ${{ env.WORKING_DIR }}
        run: make test
        env:
          MOCK_LLM: 'true'

      - name: Upload full coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-coverage
          path: ${{ env.WORKING_DIR }}/htmlcov/
          retention-days: 30

  # ========================================
  # CI SUMMARY
  # ========================================
  ci-summary:
    name: CI Summary
    needs: [unit-tests, lint-and-validate, integration-tests, e2e-tests]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: HolmesGPT API CI Summary
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "HolmesGPT API CI Summary (Defense-in-Depth V1.0)"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "Tier 1 - Unit Tests:        ${{ needs.unit-tests.result }}"
          echo "Lint & OpenAPI Validation:  ${{ needs.lint-and-validate.result }}"
          echo "Tier 2 - Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Tier 3 - E2E Tests:         ${{ needs.e2e-tests.result }}"
          echo ""
          echo "Test Coverage:"
          echo "  - Unit Tests: 481 tests (BR-HAPI-001 to BR-HAPI-200)"
          echo "  - Integration Tests: 39 scenarios"
          echo "  - E2E Tests: 28 tests (Go infrastructure)"
          echo ""
          echo "OpenAPI Contract: ADR-045 compliant"
          echo "═══════════════════════════════════════════════════════════"

          # Check results
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "❌ Unit tests failed"
            exit 1
          fi

          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi

          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "❌ E2E tests failed"
            exit 1
          fi

          echo ""
          echo "✅ All HolmesGPT API CI checks passed (3 tiers complete)!"


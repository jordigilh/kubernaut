# AIAnalysis INT Tests: HAPI Event Category Update

**Date:** January 31, 2026  
**Assignee:** AIAnalysis Team  
**Priority:** P1 - Unblocks PR merge  
**Estimated Effort:** 1-2 hours (20-30 test updates)  
**Status:** ‚è≥ PENDING

---

## Quick Summary

**What changed:**
- HolmesGPT API events now use `event_category="aiagent"` (was `"analysis"`)
- AIAnalysis controller events still use `event_category="analysis"` (no change)

**Why:**
- Fixed ADR-034 v1.2 violation (two services sharing same category)
- HolmesGPT is architecturally an autonomous AI agent, not an analysis controller

**Impact on AIAnalysis INT tests:**
- Tests querying for HAPI events with `event_category="analysis"` will fail
- Tests validating HAPI events expecting `EventCategory="analysis"` will fail
- **AIAnalysis controller events are unaffected** (keep `"analysis"`)

---

## What Needs to Change

### Rule: Update ONLY HAPI Event Queries/Validations

**HAPI Events (change to `"aiagent"`):**
- `aiagent.llm.request`
- `aiagent.llm.response`
- `aiagent.llm.tool_call`
- `aiagent.workflow.validation_attempt`
- `aiagent.response.complete`

**AIAnalysis Events (keep `"analysis"`):**
- `aianalysis.investigation.started`
- `aianalysis.analysis.completed`
- `aianalysis.phase.transition`
- `aianalysis.holmesgpt.call`
- `aianalysis.rego.evaluation`
- `aianalysis.approval.decision`

---

## Files to Update

### Estimated Changes per File

| File | Estimated Updates | Complexity |
|------|------------------|------------|
| `audit_flow_integration_test.go` | ~10 locations | Simple find/replace |
| `audit_provider_data_integration_test.go` | ~8 locations | Simple find/replace |
| `graceful_shutdown_test.go` | ~2 locations | Simple find/replace |
| `audit_integration_test.go` | ~1 location (commented code) | Optional |

**Total:** ~20-30 updates

---

## Search Patterns

### 1. Find HAPI Event Queries

```bash
cd test/integration/aianalysis

# Find queries with event_category="analysis" that might query HAPI events
grep -n 'EventCategory.*NewOptString.*"analysis"' *.go

# Find specific HAPI event type queries
grep -n 'aiagent.response.complete\|llm_request\|llm_response' *.go
```

### 2. Find HAPI Event Validations

```bash
# Find validators expecting EventCategory="analysis" for HAPI events
grep -n 'EventCategory.*AuditEventEventCategoryAnalysis' *.go | grep -i holmesgpt

# Find validators for HAPI event types
grep -B5 -A5 'EventType.*aiagent.response.complete' *.go | grep EventCategory
```

---

## Update Patterns

### Pattern 1: Query Parameters (For HAPI Events Only)

**BEFORE:**
```go
// When querying for HAPI events (llm_request, aiagent.response.complete, etc.)
params := ogenclient.QueryAuditEventsParams{
    CorrelationID: ogenclient.NewOptString(correlationID),
    EventCategory: ogenclient.NewOptString("analysis"),  // ‚ùå OLD
    EventType:     ogenclient.NewOptString("aiagent.response.complete"),
}
```

**AFTER:**
```go
// When querying for HAPI events (llm_request, aiagent.response.complete, etc.)
params := ogenclient.QueryAuditEventsParams{
    CorrelationID: ogenclient.NewOptString(correlationID),
    EventCategory: ogenclient.NewOptString("aiagent"),  // ‚úÖ NEW
    EventType:     ogenclient.NewOptString("aiagent.response.complete"),
}
```

---

### Pattern 2: Event Validation (For HAPI Events Only)

**BEFORE:**
```go
// When validating HAPI events
validators.ValidateAuditEvent(hapiEvent, validators.ExpectedAuditEvent{
    EventType:     "aiagent.response.complete",
    EventCategory: ogenclient.AuditEventEventCategoryAnalysis,  // ‚ùå OLD
    EventAction:   "response_sent",
    EventOutcome:  validators.EventOutcomePtr(ogenclient.AuditEventEventOutcomeSuccess),
    CorrelationID: correlationID,
})
```

**AFTER:**
```go
// When validating HAPI events
validators.ValidateAuditEvent(hapiEvent, validators.ExpectedAuditEvent{
    EventType:     "aiagent.response.complete",
    EventCategory: ogenclient.AuditEventEventCategoryAiagent,  // ‚úÖ NEW
    EventAction:   "response_sent",
    EventOutcome:  validators.EventOutcomePtr(ogenclient.AuditEventEventOutcomeSuccess),
    CorrelationID: correlationID,
})
```

**Note:** `AuditEventEventCategoryAiagent` constant should be generated by ogen when DataStorage OpenAPI spec is updated.

---

## Detailed Locations (Evidence from grep)

### File: `audit_flow_integration_test.go`

**Line 207:** Query parameters (if querying HAPI events)
```go
EventCategory: ogenclient.NewOptString(eventCategory),
```
- **Context check:** If `eventType` is a HAPI event ‚Üí change `eventCategory` from `"analysis"` to `"aiagent"`

**Line 475:** Query parameters (if querying HAPI events)
```go
EventCategory: ogenclient.NewOptString(eventCategory),
```

**Line 498:** Validation of `aianalysis.holmesgpt.call` event
```go
EventCategory: ogenclient.AuditEventEventCategoryAnalysis,
```
- **Keep as-is:** This is an AIAnalysis controller event (not HAPI), keep `"analysis"`

**Line 575:** Query parameters
**Line 679:** Query parameters
**Line 779:** Query parameters
**Line 892:** Query parameters
**Line 968:** Query parameters

**Action:** Review each location - only change if querying HAPI events (check `eventType`)

---

### File: `audit_provider_data_integration_test.go`

**Line 266:** Validation of HAPI event (`aiagent.response.complete`)
```go
validators.ValidateAuditEvent(hapiEvent, validators.ExpectedAuditEvent{
    EventType:     string(ogenclient.HolmesGPTResponsePayloadAuditEventEventData),
    EventCategory: ogenclient.AuditEventEventCategoryAnalysis,  // ‚ùå CHANGE TO AiAgent
```
- **Action:** Change to `AuditEventEventCategoryAiagent`

**Line 301:** Validation of AIAnalysis event
```go
EventCategory: ogenclient.AuditEventEventCategoryAnalysis,
```
- **Keep as-is:** This is AIAnalysis controller event

**Line 313:** Similar AIAnalysis validation
- **Keep as-is**

**Line 124-130:** `queryAuditEvents` function
```go
params := ogenclient.QueryAuditEventsParams{
    CorrelationID: ogenclient.NewOptString(correlationID),
    Limit:         ogenclient.NewOptInt(limit),
}
if eventType != nil {
    params.EventType = ogenclient.NewOptString(*eventType)
}
```
- **Note:** This function does NOT filter by `event_category`, so it's safe
- **Action:** No change needed (queries by event_type only)

---

### File: `graceful_shutdown_test.go`

**Line 323:** Query parameters
```go
EventCategory: ogenclient.NewOptString(eventCategory),
```
- **Context check:** If querying HAPI events ‚Üí change to `"aiagent"`
- **Likely:** This queries `"aianalysis.phase.transition"` (line 320), so keep `"analysis"`

---

### File: `audit_integration_test.go`

**Line 83-87:** Commented-out code
```go
eventCategory := "analysis"
params := ogenclient.QueryAuditEventsParams{
    EventCategory: ogenclient.NewOptString(eventCategory),
```
- **Action:** Optional - update comment for completeness

---

## Step-by-Step Instructions

### 1. Update OpenAPI Generated Client (if needed)

Check if `AuditEventEventCategoryAiagent` constant exists:

```bash
grep "AuditEventEventCategoryAiagent" pkg/datastorage/ogen-client/*.go
```

If not found, regenerate DataStorage client:
```bash
make generate-datastorage-client
```

### 2. Update Test Files

For each file listed above:

1. **Open file**
2. **Search for HAPI event types:**
   - `aiagent.response.complete`
   - `aiagent.llm.request`, `aiagent.llm.response`, `aiagent.llm.tool_call`
3. **For each HAPI event query/validation:**
   - Change `EventCategory: ogenclient.NewOptString("analysis")` ‚Üí `"aiagent"`
   - Change `EventCategory: ogenclient.AuditEventEventCategoryAnalysis` ‚Üí `AuditEventEventCategoryAiagent`
4. **Leave AIAnalysis events unchanged:**
   - `aianalysis.*` event types keep `event_category="analysis"`

### 3. Update Comments

Update any comments mentioning:
- "HAPI uses analysis category" ‚Üí "HAPI uses aiagent category"
- "HolmesGPT API events under analysis" ‚Üí "HolmesGPT API events under aiagent"

### 4. Run Tests

```bash
make test-integration-aianalysis
```

**Expected result:** All tests should pass

---

## Validation Checklist

After making changes, verify:

- [ ] All HAPI event queries use `event_category="aiagent"`
- [ ] All HAPI event validations use `AuditEventEventCategoryAiagent`
- [ ] All AIAnalysis controller events still use `event_category="analysis"`
- [ ] No accidental changes to AIAnalysis event queries/validations
- [ ] All AIAnalysis INT tests pass
- [ ] No new lint errors introduced

---

## Quick Decision Tree

**For each `EventCategory` you find:**

```
Is this a HAPI event?
‚îú‚îÄ YES (llm_request, llm_response, llm_tool_call, aiagent.response.complete, workflow_validation_attempt)
‚îÇ  ‚îî‚îÄ Change to "aiagent" / AuditEventEventCategoryAiagent
‚îÇ
‚îî‚îÄ NO (aianalysis.* prefix)
   ‚îî‚îÄ Keep as "analysis" / AuditEventEventCategoryAnalysis
```

---

## Example: Complete Update for One Location

### audit_provider_data_integration_test.go:266

**BEFORE:**
```go
// Line 263-270
actorID := "holmesgpt-api"
validators.ValidateAuditEvent(hapiEvent, validators.ExpectedAuditEvent{
    EventType:     string(ogenclient.HolmesGPTResponsePayloadAuditEventEventData),
    EventCategory: ogenclient.AuditEventEventCategoryAnalysis,  // ‚ùå
    EventAction:   "response_sent",
    EventOutcome:  validators.EventOutcomePtr(ogenclient.AuditEventEventOutcomeSuccess),
    CorrelationID: correlationID,
})
```

**AFTER:**
```go
// Line 263-270
actorID := "holmesgpt-api"
validators.ValidateAuditEvent(hapiEvent, validators.ExpectedAuditEvent{
    EventType:     string(ogenclient.HolmesGPTResponsePayloadAuditEventEventData),
    EventCategory: ogenclient.AuditEventEventCategoryAiagent,  // ‚úÖ Changed
    EventAction:   "response_sent",
    EventOutcome:  validators.EventOutcomePtr(ogenclient.AuditEventEventOutcomeSuccess),
    CorrelationID: correlationID,
})
```

---

## Common Pitfalls to Avoid

‚ùå **DON'T** change AIAnalysis controller events:
```go
// This should stay "analysis" - it's an AIAnalysis controller event
validators.ValidateAuditEvent(event, validators.ExpectedAuditEvent{
    EventType:     "aianalysis.analysis.completed",  // ‚Üê AIAnalysis prefix
    EventCategory: ogenclient.AuditEventEventCategoryAnalysis,  // ‚Üê KEEP THIS
})
```

‚ùå **DON'T** change queries that don't specify event_category:
```go
// This is fine - queries by correlation_id only
params := ogenclient.QueryAuditEventsParams{
    CorrelationID: ogenclient.NewOptString(correlationID),
}
```

‚úÖ **DO** change HAPI event queries:
```go
// This needs updating - HAPI event type
params := ogenclient.QueryAuditEventsParams{
    EventType:     ogenclient.NewOptString("aiagent.response.complete"),
    EventCategory: ogenclient.NewOptString("aiagent"),  // ‚Üê UPDATE THIS
}
```

---

## References

- **ADR-034 v1.6:** Event category table (updated with `aiagent`)
- **HAPI Audit Architecture Fix:** `docs/handoff/HAPI_AUDIT_ARCHITECTURE_FIX_JAN_31_2026.md`
- **HolmesGPT Documentation:** https://holmesgpt.dev/ (confirms AI agent architecture)

---

## Questions?

**Slack:** Ping HAPI team or Architecture team  
**Context:** All changes are part of fixing ADR-034 v1.2 violation (event_category collision)

---

## Acceptance Criteria

- [ ] All AIAnalysis INT tests pass
- [ ] HAPI events queried/validated with `event_category="aiagent"`
- [ ] AIAnalysis events still use `event_category="analysis"`
- [ ] No unintended changes to AIAnalysis event handling
- [ ] Code review completed
- [ ] Changes committed with clear commit message

---

## Commit Message Template

```
fix(aianalysis): Update HAPI event queries to use event_category='aiagent'

BREAKING CHANGE: HAPI events now use event_category='aiagent' (was 'analysis')

Context:
- Fixed ADR-034 v1.2 violation (two services sharing 'analysis' category)
- HolmesGPT API is architecturally an AI agent provider, not analysis controller
- AIAnalysis controller events still use event_category='analysis' (no change)

Changes:
- Updated HAPI event queries: event_category='analysis' ‚Üí 'aiagent'
- Updated HAPI event validations: AuditEventEventCategoryAnalysis ‚Üí AuditEventEventCategoryAiagent
- AIAnalysis controller event handling unchanged

Files modified:
- test/integration/aianalysis/audit_flow_integration_test.go (~10 updates)
- test/integration/aianalysis/audit_provider_data_integration_test.go (~8 updates)
- test/integration/aianalysis/graceful_shutdown_test.go (~2 updates)

Testing: make test-integration-aianalysis (all tests pass)

Related: ADR-034 v1.6, HAPI_AUDIT_ARCHITECTURE_FIX_JAN_31_2026.md
```

---

**Good luck! This is straightforward find/replace work. Estimated 1-2 hours.** üöÄ

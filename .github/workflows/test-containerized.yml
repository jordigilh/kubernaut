name: Containerized Test Suite

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-containerized:
    name: üê≥ ${{ matrix.test-tier }} Tests (Containerized)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test-tier: [unit, integration]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Podman and podman-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          # Install podman-compose via pip
          pip3 install podman-compose
          podman --version
          podman-compose --version
      
      - name: Build test runner image
        run: |
          podman build -f docker/test-runner.Dockerfile -t kubernaut-test-runner:latest .
      
      - name: Run ${{ matrix.test-tier }} tests
        env:
          PODMAN_SOCKET: /run/podman/podman.sock
        run: |
          make test-container-${{ matrix.test-tier }}
      
      - name: Cleanup
        if: always()
        run: |
          make test-container-down

  lint:
    name: üîç Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Run go fmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted. Run 'make fmt'"
            gofmt -l .
            exit 1
          fi
      
      - name: Run go vet
        env:
          GOFLAGS: -mod=mod
        run: go vet ./...
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
        continue-on-error: true

  build:
    name: üî® Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Build all binaries
        env:
          GOFLAGS: -mod=mod
        run: |
          echo "Building all Go binaries..."
          go build -v ./cmd/...

  summary:
    name: üìä Test Suite Summary
    runs-on: ubuntu-latest
    needs: [test-containerized, lint, build]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Test Suite Summary"
          echo "=================="
          
          if [ "${{ needs.test-containerized.result }}" == "success" ] && \
             [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "‚úÖ All checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed:"
            echo "  Containerized Tests: ${{ needs.test-containerized.result }}"
            echo "  Lint: ${{ needs.lint.result }}"
            echo "  Build: ${{ needs.build.result }}"
            exit 1
          fi

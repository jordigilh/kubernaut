name: Defense-in-Depth Test Suite

# Defense-in-Depth Testing Strategy (NOT Pyramid or Trophy)
# - Unit Tests: 70%+ of BRs (business logic)
# - Integration Tests: >50% of BRs (cross-component)
# - E2E Tests: 10-15% of BRs (critical journeys)
# - Total Coverage: 130-165% (overlapping validation)
#
# Authority: docs/testing/DEFENSE_IN_DEPTH_CI_CD_STRATEGY.md

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**.go'
      - '**.py'
      - 'go.mod'
      - 'go.sum'
      - 'test/**'
      - 'cmd/**'
      - 'pkg/**'
      - 'migrations/**'
      - 'Makefile'
      - 'holmesgpt-api/**'
      - '.github/workflows/test-integration-services.yml'
  push:
    branches: [ main ]
    paths:
      - '**.go'
      - '**.py'
      - 'go.mod'
      - 'go.sum'
      - 'test/**'
      - 'cmd/**'
      - 'pkg/**'
      - 'migrations/**'
      - 'Makefile'
      - 'holmesgpt-api/**'
      - '.github/workflows/test-integration-services.yml'
  workflow_dispatch:

jobs:
  # ========================================
  # FAST SERVICES (< 2 minutes)
  # Industry Standard: Fast feedback for services with minimal infrastructure
  # ========================================
  integration-holmesgpt:
    name: integration (holmesgpt-api)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: holmesgpt-api
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run HolmesGPT API integration tests
        working-directory: holmesgpt-api
        run: |
          # Run with mock LLM and fake K8s client (no real infrastructure)
          pytest tests/integration/ -v --tb=short
        env:
          # Use mock mode (no real LLM API calls)
          MOCK_LLM: "true"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: holmesgpt-test-results
          path: holmesgpt-api/test-results/

  # ========================================
  # MEDIUM SERVICES (1-5 minutes)
  # ========================================
  integration-datastorage:
    name: integration (data-storage)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version

      - name: Run Data Storage integration tests
        run: make test-integration-datastorage

      - name: Cleanup
        if: always()
        run: |
          # Cleanup is handled by Makefile target
          podman ps -a --filter "name=datastorage-" --format "{{.Names}}" | xargs -r podman rm -f
          podman network rm datastorage-test 2>/dev/null || true

  # ========================================
  # SLOW SERVICES (5-15 minutes) - Kind clusters
  # ========================================
  integration-notification:
    name: integration (notification)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      - name: Run Notification Service integration tests
        run: make test-integration-notification

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name notification-test 2>/dev/null || true

  integration-gateway:
    name: integration (gateway-service)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      - name: Run Gateway Service integration tests
        run: make test-integration-gateway-service

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name gateway-test 2>/dev/null || true

  # WorkflowExecution Service (EnvTest based - no Kind needed for integration)
  integration-workflowexecution:
    name: integration (workflowexecution)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run WorkflowExecution integration tests
        run: make test-integration-workflowexecution

  # ========================================
  # TIER 3: E2E TESTS (~30 minutes)
  # Defense-in-Depth: 10-15% of BRs
  # Run in parallel per-service
  # ========================================
  e2e-datastorage:
    name: e2e (data-storage)
    runs-on: ubuntu-latest
    needs: [integration-datastorage]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version

      - name: Run Data Storage E2E tests
        run: make test-e2e-datastorage

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name datastorage-e2e 2>/dev/null || true
          podman ps -a --filter "name=datastorage-" --format "{{.Names}}" | xargs -r podman rm -f

  # WorkflowExecution E2E Tests (Kind + Tekton)
  e2e-workflowexecution:
    name: e2e (workflowexecution)
    runs-on: ubuntu-latest
    needs: [integration-workflowexecution]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version

      - name: Run WorkflowExecution E2E tests
        run: make test-e2e-workflowexecution

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name workflowexecution-e2e 2>/dev/null || true

  # ========================================
  # SUMMARY JOB (Defense-in-Depth)
  # ========================================
  defense-in-depth-summary:
    name: defense-in-depth-summary
    runs-on: ubuntu-latest
    needs: [integration-holmesgpt, integration-datastorage, integration-notification, integration-gateway, integration-workflowexecution, e2e-datastorage, e2e-workflowexecution]
    if: always()
    steps:
      - name: Defense-in-Depth Test Summary
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "Defense-in-Depth Test Suite Summary"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "Tier 2 - Integration Tests (>50% of BRs):"
          echo "  HolmesGPT API:       ${{ needs.integration-holmesgpt.result }}"
          echo "  Data Storage:        ${{ needs.integration-datastorage.result }}"
          echo "  Notification:        ${{ needs.integration-notification.result }}"
          echo "  Dynamic Toolset:     ${{ needs.integration-toolset.result }}"
          echo "  Gateway Service:     ${{ needs.integration-gateway.result }}"
          echo "  WorkflowExecution:   ${{ needs.integration-workflowexecution.result }}"
          echo ""
          echo "Tier 3 - E2E Tests (10-15% of BRs):"
          echo "  Data Storage:        ${{ needs.e2e-datastorage.result }}"
          echo "  WorkflowExecution:   ${{ needs.e2e-workflowexecution.result }}"
          echo ""
          echo "Total Coverage: 130-165% (overlapping defense-in-depth)"
          echo "Strategy: NOT pyramid or trophy - overlapping validation"
          echo "═══════════════════════════════════════════════════════════"

          if [ "${{ needs.integration-holmesgpt.result }}" == "success" ] && \
             [ "${{ needs.integration-datastorage.result }}" == "success" ] && \
             [ "${{ needs.integration-notification.result }}" == "success" ] && \
             [ "${{ needs.integration-toolset.result }}" == "success" ] && \
             [ "${{ needs.integration-gateway.result }}" == "success" ] && \
             [ "${{ needs.integration-workflowexecution.result }}" == "success" ] && \
             [ "${{ needs.e2e-datastorage.result }}" == "success" ] && \
             [ "${{ needs.e2e-workflowexecution.result }}" == "success" ]; then
            echo "✅ All defense-in-depth tests passed!"
            echo ""
            echo "Note: E2E tests run on every PR (for now)"
            echo "Will move to nightly when duration > 45 min or flakiness > 5%"
            exit 0
          else
            echo "❌ Some tests failed"
            echo ""
            echo "Check individual tier logs above for details"
            exit 1
          fi


---
alwaysApply: false
---
# AI Assistant Behavioral Constraints for TDD Enforcement - COMPREHENSIVE

## ðŸš¨ **PRIORITY HIERARCHY**

**PRIORITY LEVEL**: 4 - ENFORCEMENT (per [13-conflict-resolution-matrix.mdc](mdc:.cursor/rules/13-conflict-resolution-matrix.mdc))

**Enforcement Priorities Within This Rule**:
1. **Enhanced 'fix-build' Methodology** (PRIMARY ENFORCEMENT)
2. **Real-Time Session Enforcement** (SECONDARY ENFORCEMENT)
3. **Basic TDD Validation** (BASELINE ENFORCEMENT)
4. **Emergency Stop Conditions** (CRITICAL PRIORITY)

---

## ðŸ¤– **MANDATORY AI ASSISTANT PROTOCOL**

### **REAL-TIME PREVENTION SYSTEM**

**CRITICAL PRINCIPLE**: Problems are **PREVENTED DURING THE SESSION** through mandatory AI validation, not caught after commit.

**AI must execute validation BEFORE generating any code, not after:**

---

## ðŸŽ¯ **ENHANCED 'fix-build' METHODOLOGY - PRIMARY ENFORCEMENT**

### **When user invokes `/fix-build` command, AI MUST execute this enhanced methodology:**

```
ðŸš¨ ENHANCED 'fix-build' METHODOLOGY ACTIVE - REAL-TIME SESSION ENFORCEMENT

âš ï¸  CRITICAL: This prevents catastrophic problems DURING the session, not after commit

BEFORE PROCEEDING, I MUST COMPLETE THESE MANDATORY VALIDATIONS:

PHASE 1: DISCOVERY VALIDATION â¸ï¸ (BLOCKING - MUST COMPLETE FIRST)
â–¡ Read actual type definition files (PREVENTS: undefined field references)
â–¡ Search existing test patterns comprehensively (PREVENTS: duplicate implementations)
â–¡ Verify current integration patterns (PREVENTS: orphaned business code)
â–¡ Execute build error analysis (PREVENTS: cascade failures)

PHASE 2: DECISION GATE VALIDATION â¸ï¸ (BLOCKING - MUST COMPLETE SECOND)
â–¡ Confirm all referenced fields exist in structs (PREVENTS: runtime panics)
â–¡ Verify testutil dependencies are available (PREVENTS: test compilation failures)
â–¡ Validate complete dependency chain (PREVENTS: missing imports)
â–¡ Confirm main application integration patterns (PREVENTS: unused code)

PHASE 3: TESTING STRATEGY VALIDATION â¸ï¸ (BLOCKING - MUST COMPLETE THIRD)
â–¡ Use real business logic components (PREVENTS: mock-only implementations)
â–¡ Mock ONLY external dependencies (PREVENTS: over-mocking)
â–¡ Map all tests to BR-[CATEGORY]-[NUMBER] requirements (PREVENTS: speculative code)
â–¡ Follow defense-in-depth testing approach (PREVENTS: inadequate coverage)

ðŸš¨ ENFORCEMENT RULE: I cannot proceed to implementation until ALL checkboxes are âœ…
ðŸš¨ SESSION SAFETY: Each validation PREVENTS specific catastrophic problems
ðŸš¨ REAL-TIME: Validation happens DURING session, not after commit
```

---

## ðŸ” **CRITICAL DECISION CHECKPOINTS - BLOCKING VALIDATION**

**These are BLOCKING checkpoints - AI must STOP and validate:**

### **CHECKPOINT A: Type Reference Validation**
**TRIGGER**: About to reference any struct field (e.g., `object.FieldName`)
**MANDATORY ACTION**:
```bash
# HALT: Validate type definition exists
grep -r "type.*ObjectType.*struct" pkg/ --include="*.go"
# RULE: If field not found in type definition, STOP and fix type definition first
```

### **CHECKPOINT B: Test Creation Validation**
**TRIGGER**: About to create test file with business logic references
**MANDATORY ACTION**:
```bash
# HALT: Search for existing implementations
codebase_search "existing [ComponentType] implementations"
# RULE: If creating new types, must follow TDD RED-GREEN-REFACTOR sequence
```

### **CHECKPOINT C: Business Integration Validation**
**TRIGGER**: Creating new business types or interfaces
**MANDATORY ACTION**:
```bash
# HALT: Check main application integration
grep -r "NewComponentType" cmd/ --include="*.go"
# RULE: If ZERO results, integration is required before proceeding
```

### **CHECKPOINT D: Build Error Investigation**
**TRIGGER**: User reports build errors or undefined symbols
**MANDATORY ACTION**:
```bash
# HALT: Execute comprehensive symbol analysis
codebase_search "[undefined_symbol] usage patterns and dependencies"
grep -r "[undefined_symbol]" . --include="*.go" -n
# RULE: NO implementation without user approval after complete analysis
```
**REQUIRED REPORT FORMAT**:
```
ðŸš¨ UNDEFINED SYMBOL ANALYSIS:
Symbol: [undefined_symbol]
References found: [N files]
Dependent infrastructure: [list missing types/functions]
Scope: [minimal/medium/extensive]

OPTIONS:
A) Implement complete infrastructure ([X] files affected)
B) Create minimal stub (may break [Y] files)  
C) Alternative approach: [suggest]

Which approach should I take?
```

---

## ðŸ› ï¸ **MANDATORY TOOL USAGE PATTERN**

**AI must ALWAYS use tools in this sequence for any code generation:**

### **Step 1: Discovery (REQUIRED)**
```
codebase_search "existing [ComponentType] implementations"
# OR
grep -r "[TypeName]" pkg/ --include="*.go"
```

### **Step 2: Type Validation (REQUIRED)**
```
read_file pkg/path/to/type_definition.go
# Verify all referenced fields exist in struct definitions
```

### **Step 3: Integration Check (REQUIRED)**
```
grep -r "[NewType]" cmd/ --include="*.go"
# Verify business code is used in main applications
```

---

## ðŸš« **FORBIDDEN AI ACTIONS - IMMEDIATE FAILURE CONDITIONS**

**NEVER DO THESE:**
1. **NEVER** reference struct fields without first reading the type definition file
2. **NEVER** assume testutil types exist - always validate with `read_file` or `grep`
3. **NEVER** create test code without first using `codebase_search` for existing implementations
4. **NEVER** generate business types without confirming main application usage
5. **NEVER** proceed if any validation step fails
6. **NEVER** implement missing types without full dependency analysis (CHECKPOINT D)

---

## ðŸ“‹ **MANDATORY VALIDATION SEQUENCE**

**AI must execute these steps IN ORDER before any code generation:**

### **Validation Step 1: Existence Check**
```bash
# For struct field references (e.g., node.Name)
read_file pkg/workflow/engine/workflow_simulator.go
# RULE: Verify field exists in struct definition before referencing

# For testutil types (e.g., testutil.TDDConversionHelper)
grep -r "TDDConversionHelper" pkg/testutil/ --include="*.go"
# RULE: Confirm type exists before using
```

### **Validation Step 2: Implementation Discovery**
```bash
# Before creating new test structures
codebase_search "existing WorkflowSimulator test patterns"
# RULE: Enhance existing patterns instead of creating new ones
```

### **Validation Step 3: Integration Verification**
```bash
# For new business types
grep -r "NewBusinessType" cmd/ --include="*.go"
# RULE: Business code must be integrated in main applications
```

### **Validation Step 4: Build Error Analysis (CHECKPOINT D)**
```bash
# For any undefined symbol error
codebase_search "[undefined_symbol] usage patterns across codebase"
grep -r "[undefined_symbol]" . --include="*.go" -n
# Find constructor patterns
grep -r "New[SymbolName]\|Create[SymbolName]" . --include="*.go"
# Test compilation impact
go build [dependent_file.go] 2>&1
# RULE: Present complete analysis before implementation
```

---

## âœ… **MANDATORY DECISION GATES**

**AI must answer YES to ALL questions before proceeding:**

### **For Type References:**
- âœ… Have I read the actual type definition file?
- âœ… Do all referenced fields exist in the struct?
- âœ… Are there no empty struct{} definitions?

### **For Test Creation:**
- âœ… Have I searched for existing test patterns?
- âœ… Am I following TDD RED-GREEN-REFACTOR sequence?
- âœ… Do all testutil dependencies actually exist?

### **For Business Code:**
- âœ… Is this integrated into main applications?
- âœ… Are all interfaces implemented by real code?
- âœ… Have I verified the complete dependency chain?

### **For Build Error Fixes (CHECKPOINT D):**
- âœ… Have I analyzed ALL references to the undefined symbol?
- âœ… Have I mapped the complete dependency chain?
- âœ… Have I presented options A/B/C to the user?
- âœ… Have I received explicit approval before implementing?

---

## ðŸ”§ **TOOL CALL ENFORCEMENT**

### **BLOCKING TOOL REQUIREMENTS**

**AI MUST use these tool calls BEFORE any code generation. No exceptions:**

**For ANY struct field reference (object.FieldName):**
```xml
<function_calls>
<invoke name="read_file">
<parameter name="target_file">pkg/workflow/engine/types.go</parameter>
</invoke>
</function_calls>
```

**For ANY undefined symbol error:**
```xml
<function_calls>
<invoke name="codebase_search">
<parameter name="query">[symbol_name] usage patterns and dependencies</parameter>
<parameter name="target_directories">[]</parameter>
</invoke>
</function_calls>
```

---

## ðŸš¨ **REAL-TIME CATASTROPHIC PROBLEM PREVENTION**

**These problems are prevented DURING the session through mandatory validation:**

### **CATASTROPHIC PROBLEMS PREVENTED:**
1. **Undefined Field References** â†’ PREVENTED by reading type definitions BEFORE referencing fields
2. **Missing Dependencies** â†’ PREVENTED by validating testutil existence BEFORE using
3. **Orphaned Business Code** â†’ PREVENTED by confirming main app integration BEFORE implementation
4. **Build Cascade Failures** â†’ PREVENTED by comprehensive symbol analysis BEFORE fixing
5. **Mock-Only Implementations** â†’ PREVENTED by validating real business logic usage
6. **Incomplete TDD Coverage** â†’ PREVENTED by mandatory BR-[CATEGORY]-[NUMBER] mapping
7. **Integration Gaps** â†’ PREVENTED by main application usage verification
8. **Type Safety Violations** â†’ PREVENTED by struct field existence validation

### **SESSION-TIME ENFORCEMENT TRIGGERS:**
Every time AI is about to:
- Reference `object.FieldName` â†’ **HALT** and validate field exists
- Use `testutil.TypeName` â†’ **HALT** and confirm type exists
- Create new business type â†’ **HALT** and verify main app integration
- Fix undefined symbol â†’ **HALT** and complete dependency analysis
- Create test â†’ **HALT** and search existing patterns
- Implement code â†’ **HALT** and confirm TDD sequence compliance

**Result**: Catastrophic problems are **IMPOSSIBLE** because they're prevented during the session through mandatory AI validation.

---

## ðŸ“Š **CONFIDENCE ASSESSMENT REQUIREMENTS**

**After any code generation, AI must provide:**
```
Validation Confidence: [60-100]%
Type Safety: âœ…/âŒ All referenced fields exist in type definitions
TDD Compliance: âœ…/âŒ Follows RED-GREEN-REFACTOR sequence
Integration Status: âœ…/âŒ Business code integrated in main applications
Build Error Analysis: âœ…/âŒ Complete dependency analysis performed (if applicable)
Risk Assessment: [Description of potential issues]
```

---

## ðŸ›‘ **EMERGENCY STOP CONDITIONS**

**AI must immediately halt and request manual intervention if:**
1. Type definitions are incomplete (empty structs) - **SESSION RISK: Runtime panics**
2. Referenced fields don't exist in type definitions - **SESSION RISK: Compilation failures**
3. Business code has no main application integration - **SESSION RISK: Orphaned code**
4. TDD sequence is being bypassed - **SESSION RISK: Incomplete implementations**
5. Validation scripts are missing or failing - **SESSION RISK: Undetected problems**
6. Undefined symbols detected without complete analysis - **SESSION RISK: Cascade failures**

---

## âœ… **QUALITY GATES**

**No code generation is permitted without:**
- âœ… Type safety validation passing
- âœ… TDD methodology compliance confirmed
- âœ… Business integration verified
- âœ… Dependency existence validated
- âœ… Main application usage confirmed
- âœ… Build error analysis completed (when applicable)

---

## ðŸŽ¯ **IMPLEMENTATION PRIORITY**

**PRIORITY LEVEL**: 4 - ENFORCEMENT (per [13-conflict-resolution-matrix.mdc](mdc:.cursor/rules/13-conflict-resolution-matrix.mdc))

This rule enforces methodology compliance within the established hierarchy:
- **ENFORCEMENT CONTROL**: Validates compliance with APDC methodology and testing strategy
- **NON-NEGOTIABLE**: Cannot be bypassed for convenience or speed
- **SCOPE**: Development validation - operates within APDC framework and testing strategy authority
- **AUTOMATED**: Must be enforced programmatically, not manually

---

## ðŸ”— **INTEGRATION WITH OTHER RULES**

This rule **enforces** compliance with:
- [00-core-development-methodology.mdc](mdc:.cursor/rules/00-core-development-methodology.mdc) - TDD methodology
- [07-business-code-integration.mdc](mdc:.cursor/rules/07-business-code-integration.mdc) - Integration requirements
- [02-technical-implementation.mdc](mdc:.cursor/rules/02-technical-implementation.mdc) - Technical patterns
- [03-testing-strategy.mdc](mdc:.cursor/rules/03-testing-strategy.mdc) - Testing framework
- [12-ai-ml-development-methodology.mdc](mdc:.cursor/rules/12-ai-ml-development-methodology.mdc) - AI/ML TDD patterns

---

## ðŸ“š **QUICK REFERENCE FOR ENHANCED 'fix-build' SHORTCUT**

| User Command | AI Response |
|---|---|
| `/fix-build @documents` | Execute enhanced methodology with comprehensive validation |
| "Fix build errors" | Execute CHECKPOINT D + ask for approval |
| "undefined [symbol]" | Complete symbol analysis + show options A/B/C |
| "implement recommended approach" | Follow approved option exactly as specified |

---

## ðŸŽ¯ **SUCCESS METRICS**

- **TDD Compliance Rate**: Target >98%
- **Implementation Accuracy**: Target >95% first-time success
- **Cascade Failure Prevention**: Target >99% prevention rate
- **Business Requirement Coverage**: Target 100% mapping
- **Methodology Compliance**: Target 100% enforcement

**Priority**: FOUNDATIONAL - This rule prevents cascade failures and incomplete implementations
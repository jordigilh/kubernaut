# Kind cluster configuration for AIAnalysis E2E tests
# Reference: DD-TEST-001 Port Allocation Strategy
#
# Port Allocation (from DD-TEST-001):
#   Host Port: 8084
#   NodePort (API): 30084
#   NodePort (Metrics): 30184
#   Health Port: 8081
#   Metrics Port: 9090
#
# Usage:
#   kind create cluster --name aianalysis-e2e --config test/infrastructure/kind-aianalysis-config.yaml
#
# Dependencies:
#   - HolmesGPT-API (port 8080) - can run in-cluster or external
#   - Data Storage (port 8081/30081) - for audit events
#   - SignalProcessing CRD (upstream) - for EnrichmentResults

kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  image: kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48  # K8s 1.34.3 with CRD selectableFields support
  # Expose AIAnalysis Controller ports via NodePort to host machine
  # This eliminates kubectl port-forward instability for E2E tests
  extraPortMappings:
  # Service NodePort (for API access if needed)
  - containerPort: 30084  # AIAnalysis NodePort (per DD-TEST-001)
    hostPort: 8084        # Port on host machine (localhost:8084)
    protocol: TCP
  # Metrics NodePort (for Prometheus scraping)
  - containerPort: 30184  # AIAnalysis Metrics NodePort (per DD-TEST-001)
    hostPort: 9184        # Port on host machine (localhost:9184/metrics)
    protocol: TCP
  # Health probe NodePort (for liveness/readiness checks from host)
  - containerPort: 30284  # AIAnalysis Health NodePort
    hostPort: 8184        # Port on host machine (localhost:8184/healthz)
    protocol: TCP
  # Dependency service ports (for E2E health checks)
  - containerPort: 30088  # HolmesGPT-API NodePort
    hostPort: 8088        # Port on host machine (localhost:8088/health)
    protocol: TCP
  - containerPort: 30081  # Data Storage NodePort
    hostPort: 8091        # Port on host machine (localhost:8091/health)
    protocol: TCP         # Note: 8091 used to avoid conflicts (8081=AIAnalysis, 8085=gvproxy)
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        # Increase API server rate limits for parallel E2E testing
        # With 4 parallel test processes, need headroom for CRD operations
        max-requests-inflight: "800"
        max-mutating-requests-inflight: "400"
    controllerManager:
      extraArgs:
        # Increase controller manager QPS for CRD operations
        kube-api-qps: "100"
        kube-api-burst: "200"

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernaut-stuck-rollout-rules
  namespace: demo-rollout
  labels:
    release: prometheus
spec:
  groups:
  - name: kubernaut-stuck-rollout
    rules:
    # Detect deployment rollout stuck (not progressing)
    # kube-state-metrics exposes a "Progressing" condition with status "false"
    # when the deployment exceeds its progressDeadlineSeconds
    - alert: KubernautStuckRollout
      expr: |
        kube_deployment_status_condition{
          namespace="demo-rollout",
          deployment="checkout-api",
          condition="Progressing",
          status="false"
        } == 1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: >
          Deployment {{ $labels.deployment }} in namespace {{ $labels.namespace }}
          has a stuck rollout -- not progressing for over 2 minutes.
        description: >
          The checkout-api deployment has exceeded its progressDeadlineSeconds (120s)
          and is no longer making progress on its rollout. This typically indicates
          new pods cannot start (bad image, missing config, resource constraints).
          Rolling back to the previous revision will restore service.

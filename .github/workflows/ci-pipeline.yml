name: CI Pipeline

# 3-Stage CI Pipeline with Smart Path Detection and Parallel Execution
#
# Stage 1A: Build & Lint (parallel: Go + Python)
# Stage 1B: Unit Tests (parallel matrix: 8 services)
# Stage 2: Integration Tests (parallel matrix: 8 services)
# Stage 3: E2E Tests (parallel jobs: 8 services) - Run REGARDLESS of integration results
#
# Smart Path Detection:
#   - Build & Lint: Runs in parallel (Go and Python separately)
#   - Unit Tests: Matrix runs ALL services always (~10 min total)
#   - Integration Tests: Matrix runs ALL services always (~15 min total)
#     * Design Decision: No path filtering at integration level
#     * Rationale: Fast enough + better cross-service issue detection
#   - E2E Tests: Smart path detection per service (30 min each)
#     * Data Storage changes â†’ ALL services (DS is shared dependency)
#     * Individual service changes â†’ ONLY that service
#     * Push to main â†’ ALL services (full validation)
#
# Optimization Strategy:
#   - Parallel build & lint jobs (Go + Python)
#   - Matrix parallelization for homogeneous jobs (unit, integration)
#   - Individual jobs for heterogeneous jobs (E2E with different infra)
#   - Fail-fast disabled for comprehensive feedback
#   - Path detection where it matters most (E2E tests)
#
# Authority: [TODO] Create ADR-CI-001 from docs/handoff/TRIAGE_GITHUB_WORKFLOW_OPTIMIZATION_REQUIREMENTS.md

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**.go'
      - '**.py'
      - 'go.mod'
      - 'go.sum'
      - 'test/**'
      - 'cmd/**'
      - 'pkg/**'
      - 'internal/**'
      - 'api/**'
      - 'migrations/**'
      - 'Makefile'
      - 'holmesgpt-api/**'
      - '.github/workflows/**'
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # CRITICAL: Kind must use Podman (we don't have Docker in our CI)
  # This ensures all Kind commands (create, load, etc.) use Podman as the provider
  KIND_EXPERIMENTAL_PROVIDER: podman
  
  # Image registry configuration for E2E tests
  # NOTE: ghcr.io is for CI/CD ONLY (ephemeral images, 14-day cleanup)
  # Production releases use Quay.io (separate workflow)
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}/kubernaut

jobs:
  # ========================================
  # STAGE 1A: BUILD & LINT (PARALLEL)
  # Two parallel jobs (~3 min total)
  # ========================================

  build-and-lint-go:
    name: Build & Lint (Go Services)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Generate Go code
        run: |
          echo "ğŸ”„ Generating Go code (tools auto-installed via Makefile)..."
          export PATH="${{ github.workspace }}/bin:$PATH"
          make generate

      - name: Build all Go services
        run: |
          echo "ğŸ”¨ Building all Go services..."
          export PATH="${{ github.workspace }}/bin:$PATH"
          make build-all

      - name: Lint Go code
        run: |
          echo "ğŸ” Linting Go code..."
          export PATH="${{ github.workspace }}/bin:$PATH"
          timeout 3m make lint || echo "âš ï¸ Linting timed out or had issues (non-blocking)"
        continue-on-error: true  # Don't block CI for lint warnings in V1.0

  build-and-lint-python:
    name: Build & Lint (Python Services)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'holmesgpt-api/requirements*.txt'

      - name: Install Python dependencies
        working-directory: holmesgpt-api
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Lint Python code (HAPI)
        run: |
          echo "ğŸ” Linting Python code..."
          make lint-holmesgpt-api
        continue-on-error: true  # Don't block CI for lint warnings in V1.0

  # ========================================
  # STAGE 1B: UNIT TESTS (PARALLEL)
  # Matrix job, 8 services in parallel (~2 min)
  # ========================================

  unit-tests:
    name: Unit Tests (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [build-and-lint-go, build-and-lint-python]
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        service:
          - aianalysis
          - authwebhook
          - datastorage
          - gateway
          - notification
          - remediationorchestrator
          - signalprocessing
          - workflowexecution
          - holmesgpt-api
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Go
        if: matrix.service != 'holmesgpt-api'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Set up Python
        if: matrix.service == 'holmesgpt-api'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'holmesgpt-api/requirements*.txt'

      - name: Install Python dependencies
        if: matrix.service == 'holmesgpt-api'
        working-directory: holmesgpt-api
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Generate Go code
        if: matrix.service != 'holmesgpt-api'
        run: |
          echo "ğŸ”„ Generating Go code for tests..."
          export PATH="${{ github.workspace }}/bin:$PATH"
          make generate

      - name: Run unit tests (Go)
        if: matrix.service != 'holmesgpt-api'
        run: |
          echo "ğŸ§ª Running unit tests for ${{ matrix.service }}..."
          export PATH="${{ github.workspace }}/bin:$PATH"
          make test-unit-${{ matrix.service }}

      - name: Run unit tests (Python)
        if: matrix.service == 'holmesgpt-api'
        run: |
          echo "ğŸ§ª Running HolmesGPT API unit tests..."
          make test-unit-holmesgpt-api
        env:
          MOCK_LLM: 'true'

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage-${{ matrix.service }}
          path: |
            coverage.out
            holmesgpt-api/htmlcov/
          retention-days: 7

  # ========================================
  # STAGE 2: BUILD & PUSH IMAGES (ghcr.io)
  # Matrix job: Build all service images and push to GitHub Container Registry
  # Purpose: E2E tests pull from registry (saves ~60% disk space)
  # Retention: Images auto-cleanup after 14 days (GitHub policy)
  # Production: NOT used for production (Quay.io for production releases)
  # ========================================

  build-and-push-images:
    name: Build & Push (${{ matrix.service }})
    needs: [unit-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write  # Required for ghcr.io push
    strategy:
      fail-fast: false
      matrix:
        include:
          # Go Services (8)
          - service: datastorage
            dockerfile: docker/data-storage.Dockerfile
            image_name: datastorage
          - service: gateway
            dockerfile: docker/gateway-ubi9.Dockerfile
            image_name: gateway
          - service: aianalysis
            dockerfile: docker/aianalysis.Dockerfile
            image_name: aianalysis
          - service: authwebhook
            dockerfile: docker/authwebhook.Dockerfile
            image_name: authwebhook
          - service: notification
            dockerfile: docker/notification-controller-ubi9.Dockerfile
            image_name: notification
          - service: remediationorchestrator
            dockerfile: docker/remediationorchestrator-controller.Dockerfile
            image_name: remediationorchestrator
          - service: signalprocessing
            dockerfile: docker/signalprocessing-controller.Dockerfile
            image_name: signalprocessing
          - service: workflowexecution
            dockerfile: docker/workflowexecution-controller.Dockerfile
            image_name: workflowexecution
          # Python Services (1)
          - service: holmesgpt-api
            dockerfile: holmesgpt-api/Dockerfile
            image_name: holmesgpt-api
          # Test Fixtures (1)
          - service: mock-llm
            dockerfile: test/services/mock-llm/Dockerfile
            image_name: mock-llm
            context: test/services/mock-llm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "tag=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "tag=main-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ${{ matrix.service }} image
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/kubernaut/${{ matrix.image_name }}
          IMAGE_TAG=${{ steps.tag.outputs.tag }}
          CONTEXT=${{ matrix.context || '.' }}
          
          echo "ğŸ”¨ Building ${{ matrix.service }} image..."
          echo "   Image: ${IMAGE_NAME}:${IMAGE_TAG}"
          echo "   Dockerfile: ${{ matrix.dockerfile }}"
          echo "   Context: ${CONTEXT}"
          
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -f ${{ matrix.dockerfile }} \
            ${CONTEXT}
          
          echo "ğŸ“¤ Pushing to ghcr.io..."
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          
          echo "âœ… Image pushed successfully!"

  # ========================================
  # STAGE 3: INTEGRATION TESTS
  # Matrix strategy: 9 services (all use same pattern: envtest + Podman)
  #   - 7 Go services: signalprocessing, aianalysis, workflowexecution,
  #     remediationorchestrator, notification, gateway, datastorage
  #   - 1 Go+Python hybrid: holmesgpt-api (Go infrastructure, Python tests)
  # Only start if Stage 1 passes
  #
  # DESIGN DECISION: No smart path detection at this level
  # - All integration tests run for ANY change (after unit tests pass)
  # - Rationale: Integration tests are fast (~15 min total, parallel)
  # - Benefit: Better cross-service issue detection
  # - Trade-off: Uses more CI minutes, but comprehensive coverage worth it
  # - Smart path detection reserved for E2E tests (slower, 30 min each)
  # ========================================

  integration-tests:
    name: integration (${{ matrix.service }})
    needs: [unit-tests]  # Integration tests don't need images
    runs-on: ubuntu-latest
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        service: [signalprocessing, aianalysis, authwebhook, workflowexecution, remediationorchestrator, notification, gateway, datastorage, holmesgpt-api]
        include:
          - service: signalprocessing
            service_name: "Signal Processing"
            timeout: 10
          - service: aianalysis
            service_name: "AI Analysis"
            timeout: 15
          - service: authwebhook
            service_name: "Auth Webhook"
            timeout: 10
          - service: workflowexecution
            service_name: "Workflow Execution"
            timeout: 15
          - service: remediationorchestrator
            service_name: "Remediation Orchestrator"
            timeout: 15
          - service: notification
            service_name: "Notification"
            timeout: 10
          - service: gateway
            service_name: "Gateway"
            timeout: 20
          - service: datastorage
            service_name: "Data Storage"
            timeout: 10
          - service: holmesgpt-api
            service_name: "HolmesGPT API"
            timeout: 10
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true  # CRITICAL: holmesgpt is a submodule required for HAPI builds
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Generate OpenAPI specs
        run: make generate
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
      - name: Setup envtest (K8s test binaries)
        run: |
          go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
          echo "KUBEBUILDER_ASSETS=$($(go env GOPATH)/bin/setup-envtest use -p path)" >> $GITHUB_ENV
      - name: Run ${{ matrix.service }} integration tests
        run: make test-integration-${{ matrix.service }}
      - name: Validate Data Storage OpenAPI spec (ADR-031)
        if: matrix.service == 'datastorage'
        run: make validate-openapi-datastorage
      - name: Collect must-gather logs on failure
        if: failure()
        run: |
          echo "ğŸ“‹ Collecting must-gather logs for triage..."
          if [ -d "/tmp/kubernaut-must-gather" ]; then
            echo "âœ… Found must-gather directory"
            ls -la /tmp/kubernaut-must-gather/
            # Create timestamped archive for this service
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            tar -czf must-gather-${{ matrix.service }}-${TIMESTAMP}.tar.gz -C /tmp kubernaut-must-gather/
            echo "âœ… Created must-gather archive: must-gather-${{ matrix.service }}-${TIMESTAMP}.tar.gz"
          else
            echo "âš ï¸  No must-gather directory found at /tmp/kubernaut-must-gather"
            echo "    This may be expected if tests failed before must-gather was triggered"
          fi
      - name: Upload must-gather logs as artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: must-gather-logs-${{ matrix.service }}-${{ github.run_id }}
          path: must-gather-*.tar.gz
          retention-days: 14
          if-no-files-found: warn
      - name: Cleanup
        if: always()
        run: podman ps -a --filter "name=${{ matrix.service }}-" --format "{{.Names}}" | xargs -r podman rm -f
  # ========================================
  # SUMMARY
  # ========================================
  # ========================================
  # STAGE 4: E2E TESTS (TODO - Not yet enabled)
  # E2E tests will use images from ghcr.io (built in Stage 2)
  # This saves ~60% disk space on GitHub Actions runners
  # ========================================
  # e2e-tests:
  #   name: E2E (${{ matrix.service }})
  #   needs: [build-and-push-images]
  #   env:
  #     IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}/kubernaut
  #     IMAGE_TAG: ${{ needs.build-and-push-images.outputs.tag }}
  #   ...

  # ========================================
  # SUMMARY
  # ========================================
  summary:
    name: Test Suite Summary
    needs: [
      build-and-lint-go, build-and-lint-python, unit-tests,
      build-and-push-images, integration-tests
    ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Test Suite Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Defense-in-Depth Test Suite Summary (Optimized + Parallel)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "STAGE 1A - Build & Lint (Parallel):"
          echo "  Go Services:    ${{ needs.build-and-lint-go.result }}"
          echo "  Python Services: ${{ needs.build-and-lint-python.result }}"
          echo ""
          echo "STAGE 1B - Unit Tests (Parallel Matrix):"
          echo "  Unit Tests: ${{ needs.unit-tests.result }}"
          echo ""
          echo "STAGE 2 - Build & Push Images (Parallel Matrix):"
          echo "  All Images (10 services): ${{ needs.build-and-push-images.result }}"
          echo "  Registry: ghcr.io (CI/CD ephemeral images only)"
          echo ""
          echo "STAGE 3 - Integration Tests (Parallel Matrix):"
          echo "  All Services (9 services):  ${{ needs.integration-tests.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Test Strategy:"
          echo "  âœ… ALL tests run for every non-draft PR"
          echo "  âœ… Comprehensive validation ensures stability"
          echo "  âœ… Smart path detection can be added once CI/CD is stable"
          echo ""
          echo "Optimizations:"
          echo "  âœ… Parallel build & lint (Go + Python)"
          echo "  âœ… Build & lint separated from tests"
          echo "  âœ… Parallel unit tests (matrix: 9 services)"
          echo "  âœ… Parallel image builds & push to ghcr.io (matrix: 10 images)"
          echo "  âœ… Parallel integration tests (matrix: 9 services)"
          echo "  âœ… Matrix strategy for test tiers"
          echo "  â­ï¸  E2E tests temporarily disabled (will use ghcr.io images when enabled)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Check for build & lint failure (critical)
          if [ "${{ needs.build-and-lint-go.result }}" != "success" ] || [ "${{ needs.build-and-lint-python.result }}" != "success" ]; then
            echo ""
            echo "âŒ Build & Lint failed - all other tests skipped"
            exit 1
          fi

          # Check for unit tests failure (critical)
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo ""
            echo "âŒ Unit tests failed - subsequent stages skipped"
            exit 1
          fi

          # Check for image build & push failure (critical for E2E)
          if [ "${{ needs.build-and-push-images.result }}" != "success" ]; then
            echo ""
            echo "âŒ Image builds failed - check individual service builds in the matrix"
            echo "   Services: datastorage, gateway, aianalysis, authwebhook, notification,"
            echo "             remediationorchestrator, signalprocessing, workflowexecution,"
            echo "             holmesgpt-api, mock-llm"
            exit 1
          fi

          # Check for integration tests failure (matrix job)
          # Note: integration-tests is a single matrix job that runs 8 services
          # GitHub Actions reports the matrix job result as a whole (fail-fast: false)
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo ""
            echo "âŒ Integration tests failed - check individual service logs in the matrix"
            echo "   Services tested: signalprocessing, aianalysis, workflowexecution,"
            echo "                    remediationorchestrator, gateway, datastorage,"
            echo "                    notification, holmesgpt-api"
            exit 1
          fi

          echo ""
          echo "âœ… All tests passed!"
          exit 0

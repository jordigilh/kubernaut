---
# ========================================
# DD-AUTH-006: RBAC for OAuth-Proxy Protected HolmesGPT API Access
# ========================================
#
# This RBAC configuration enables AIAnalysis controller to authenticate with HolmesGPT API
# via DD-AUTH-014 middleware using ServiceAccount tokens.
#
# Flow:
# 1. AIAnalysis controller → HolmesGPT API (with ServiceAccount token in Authorization header)
# 2. DD-AUTH-014 middleware validates token (TokenReview)
# 3. DD-AUTH-014 middleware performs Subject Access Review (SAR) using this RBAC
# 4. DD-AUTH-014 middleware authorizes request
# 5. HolmesGPT API receives authenticated request
#
# Services (1 total):
# - AIAnalysis Controller (calls HAPI for investigation/recovery analysis)
#
# Why Only AIAnalysis?
# - AIAnalysis controller orchestrates the investigation workflow
# - AIAnalysis is responsible for calling LLM for incident/recovery analysis
# - Gateway receives alerts but does NOT call HAPI (it creates AIAnalysis CRDs instead)
# - This minimizes LLM API surface area and cost exposure
#
# ========================================

---
# ClusterRole: Defines permissions to access HolmesGPT API service
# DD-AUTH-006: OAuth-proxy SAR check - "get" verb on service resource
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: holmesgpt-api-client
  labels:
    app.kubernetes.io/name: holmesgpt-api
    app.kubernetes.io/component: rbac
rules:
  # OAuth-proxy SAR check: Can the ServiceAccount "get" the holmesgpt-api service?
  # This is the authorization check performed by oauth-proxy before proxying requests
  - apiGroups: [""]
    resources: ["services"]
    resourceNames: ["holmesgpt-api"]
    verbs: ["get"]

---
# RoleBinding: Grant AIAnalysis Controller ServiceAccount access to HolmesGPT API
# DD-AUTH-006: AIAnalysis is the ONLY service authorized to call HAPI
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: aianalysis-controller-holmesgpt-api-client
  namespace: kubernaut-system
  labels:
    app.kubernetes.io/name: aianalysis
    app.kubernetes.io/component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: holmesgpt-api-client
subjects:
  - kind: ServiceAccount
    name: aianalysis-controller
    namespace: kubernaut-system

# ========================================
# SECURITY NOTES
# ========================================
#
# 1. **LLM Cost Control**: Only Gateway can call HAPI
#    - Prevents unauthorized LLM usage (expensive)
#    - Enables cost attribution via X-Auth-Request-User header
#
# 2. **Port-Forward Protection**: OAuth-proxy blocks unauthorized access
#    - Even with port-forward, requests must have valid ServiceAccount token
#    - Token must belong to gateway-sa (only authorized service)
#    - Blocks attackers from using kubectl port-forward to access LLM
#
# 3. **User Attribution**: X-Auth-Request-User header enables:
#    - Cost tracking: Which service is using LLM?
#    - Security auditing: Detect misuse patterns
#    - Future SOC2 readiness: If HAPI generates audit events
#
# 4. **Architecture Clarification**: AIAnalysis vs Gateway
#    - AIAnalysis Controller: Creates HolmesGPT client, calls HAPI for analysis
#    - Gateway Service: Receives alerts, creates AIAnalysis CRDs (does NOT call HAPI)
#    - Flow: Alert → Gateway → AIAnalysis CRD → AIAnalysis Controller → HAPI
#    - This separation ensures LLM calls are isolated in the AIAnalysis controller
#
# 5. **Future Expansion**: To add more services:
#    - Create new RoleBinding for each service
#    - Grant "get" permission on "holmesgpt-api" service
#    - Example for another service:
#      ```yaml
#      ---
#      apiVersion: rbac.authorization.k8s.io/v1
#      kind: RoleBinding
#      metadata:
#        name: other-service-holmesgpt-api-client
#        namespace: kubernaut-system
#      roleRef:
#        apiGroup: rbac.authorization.k8s.io
#        kind: ClusterRole
#        name: holmesgpt-api-client
#      subjects:
#        - kind: ServiceAccount
#          name: other-service-sa
#          namespace: kubernaut-system
#      ```
#
# Authority: DD-AUTH-006 (HolmesGPT API oauth-proxy integration)
# Related: DD-AUTH-004 (DataStorage oauth-proxy pattern)
# ========================================



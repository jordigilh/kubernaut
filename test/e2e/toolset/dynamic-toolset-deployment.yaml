# Simplified Dynamic Toolset Deployment for E2E Testing
# This is a minimal deployment focused on E2E test requirements
# Production deployment is in deploy/dynamic-toolset-deployment.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubernaut-service-discovery
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: service-discovery

---
# RBAC Configuration for Service Discovery
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubernaut-service-discovery-__NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: service-discovery
rules:
# Service discovery permissions
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list"]
# Application discovery permissions
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch"]
# ConfigMap management
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "create", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubernaut-service-discovery-__NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: service-discovery
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubernaut-service-discovery-__NAMESPACE__
subjects:
- kind: ServiceAccount
  name: kubernaut-service-discovery
  namespace: __NAMESPACE__

---
# ConfigMap for Dynamic Toolset Configuration (E2E Test)
apiVersion: v1
kind: ConfigMap
metadata:
  name: kubernaut-dynamic-toolset-config
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: configuration
data:
  config.yaml: |
    service_discovery:
      enabled: true
      discovery_interval: "5s"  # Fast for E2E tests
      cache_ttl: "10s"
      health_check_interval: "5s"
      namespaces:
        - "__NAMESPACE__"  # Only test namespace

      service_patterns:
        prometheus:
          enabled: true
          priority: 80
          selectors:
            - app.kubernetes.io/name: prometheus
            - app: prometheus
          service_names: ["prometheus", "prometheus-server"]
          required_ports: [9090]

        grafana:
          enabled: true
          priority: 70
          selectors:
            - app.kubernetes.io/name: grafana
          service_names: ["grafana"]
          required_ports: [3000]

        custom:
          enabled: true
          priority: 30

    holmesgpt:
      enabled: true
      endpoint: "http://holmesgpt-api:8080"
      timeout: "10s"
      dynamic_toolsets:
        enabled: true
        update_interval: "5s"  # Fast for E2E tests
        baseline_toolsets: ["kubernetes", "internet"]

---
# Dynamic Toolset Deployment (E2E Test - Simplified)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubernaut-dynamic-toolsets
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: dynamic-toolsets
spec:
  replicas: 1  # Single replica for E2E tests
  selector:
    matchLabels:
      app.kubernetes.io/name: kubernaut
      app.kubernetes.io/component: dynamic-toolsets
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kubernaut
        app.kubernetes.io/component: dynamic-toolsets
    spec:
      serviceAccountName: kubernaut-service-discovery
      containers:
      - name: kubernaut
        image: localhost/kubernaut-dynamic-toolsets:e2e-test
        imagePullPolicy: Never  # Use local image
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: health
          containerPort: 8081
          protocol: TCP
        env:
        - name: CONFIG_FILE
          value: "/etc/kubernaut/config.yaml"
        - name: LOG_LEVEL
          value: "debug"  # Verbose for E2E tests
        - name: SERVICE_DISCOVERY_ENABLED
          value: "true"
        - name: DYNAMIC_TOOLSETS_ENABLED
          value: "true"
        volumeMounts:
        - name: config
          mountPath: /etc/kubernaut
          readOnly: true
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: health
          initialDelaySeconds: 5
          periodSeconds: 3
          timeoutSeconds: 2
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: config
        configMap:
          name: kubernaut-dynamic-toolset-config

---
# Service for Dynamic Toolset (E2E Test)
apiVersion: v1
kind: Service
metadata:
  name: kubernaut-dynamic-toolsets
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: dynamic-toolsets
spec:
  selector:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: dynamic-toolsets
  ports:
  - name: http
    port: 8080
    targetPort: http
    protocol: TCP
  type: ClusterIP


# Gas Town Convoy: SOC2 Audit Trail (RR Reconstruction)
# Business Requirement: BR-AUDIT-005 v2.0
# Epic: Complete RemediationRequest reconstruction from audit events

convoy_id = "soc2-audit-trail"
name = "SOC2 Audit Trail - RR Reconstruction (Gaps 1-8 + Integration)"
owner = "@jgil"
created = "2026-01-04T08:00:00Z"
status = "in_progress"
priority = "high"
compliance_requirement = "SOC2 Type II"

[scope]
business_requirements = ["BR-AUDIT-005", "BR-WE-013"]
design_decisions = [
    "DD-AUDIT-003",  # Service Audit Trace Requirements
    "DD-AUDIT-004",  # Structured event_data
    "DD-AUDIT-005",  # Hybrid Provider Data Capture
    "DD-TESTING-001" # Audit Event Validation Standards
]
authoritative_docs = [
    "docs/development/SOC2/SOC2_AUDIT_RR_RECONSTRUCTION_TEST_PLAN.md",
    "docs/development/business-requirements/TESTING_GUIDELINES.md"
]

[timeline]
start_date = "2026-01-04"
estimated_end_date = "2026-01-13"
total_days = 8
completed_days = 2
remaining_days = 6
progress_percent = 25.0

[teams]
involved_teams = [
    "gateway",
    "aianalysis",
    "holmesgpt-api",
    "workflowexecution",
    "orchestrator",
    "notification",
    "datastorage"
]
primary_coordinator = "@jgil"

# ========================================
# COMPLETED MOLECULES
# ========================================

[[molecules]]
id = "day1-gateway-fields"
name = "Day 1: Gateway Signal Fields (Gap 1-3)"
formula = "integration-test-full-validation"
formula_version = "2.0"
status = "completed"
start_date = "2026-01-04"
end_date = "2026-01-04"
owner = "@jgil"
team = "gateway"

[molecules.scope]
gaps = ["Gap 1", "Gap 2", "Gap 3"]
services = ["gateway"]
event_types = ["gateway.signal.received"]
test_file = "test/integration/gateway/audit_signal_data_integration_test.go"
test_specs = 3

[molecules.deliverables]
tests_passing = true
test_pass_rate = 100.0
compliance_validated = true
documentation_updated = true

[molecules.quality_metrics]
test_count = 3
event_count = 1
coverage = "complete"

[[molecules]]
id = "day2-hybrid-provider-data"
name = "Day 2: Hybrid Provider Data Capture (Gap 4)"
formula = "integration-test-full-validation"
formula_version = "2.1"
status = "completed"
start_date = "2026-01-05"
end_date = "2026-01-05"
owner = "@jgil"
team = "aianalysis"

[molecules.scope]
gaps = ["Gap 4"]
services = ["holmesgpt-api", "aianalysis"]
event_types = [
    "holmesgpt.response.complete",
    "aianalysis.analysis.completed"
]
test_file = "test/integration/aianalysis/audit_provider_data_integration_test.go"
test_specs = 3

[molecules.deliverables]
tests_passing = true
test_pass_rate = 100.0
compliance_validated = true
documentation_updated = true
design_decision = "DD-AUDIT-005"

[molecules.quality_metrics]
test_count = 3
event_count = 2  # Hybrid approach
coverage = "complete"
implementation_confidence = 95

# ========================================
# PLANNED MOLECULES (Days 3-8)
# ========================================

[[molecules]]
id = "day3-workflow-refs"
name = "Day 3: Workflow Selection & Execution (Gap 5-6)"
formula = "integration-test-full-validation"
formula_version = "2.1"
status = "planned"
estimated_start_date = "2026-01-06"
estimated_end_date = "2026-01-06"
owner = "@jgil"
team = "workflowexecution"

[molecules.scope]
gaps = ["Gap 5", "Gap 6"]
services = ["workflowexecution"]
event_types = [
    "workflowexecution.workflow.selected",
    "workflowexecution.workflow.executed"
]
test_file = "test/integration/workflowexecution/audit_workflow_selection_integration_test.go"
estimated_test_specs = 3

[molecules.dependencies]
requires = ["day2-hybrid-provider-data"]
blocks = ["day4-error-details"]

[molecules.estimated_effort]
analysis_phase = "15m"
plan_phase = "20m"
do_phase = "45m"
check_phase = "40m"
document_phase = "10m"
total = "2h 10m"

[[molecules]]
id = "day4-5-error-details"
name = "Day 4-5: Error Details Across Services (Gap 7)"
formula = "integration-test-full-validation"
formula_version = "2.1"
status = "planned"
estimated_start_date = "2026-01-07"
estimated_end_date = "2026-01-08"
owner = "@jgil"
team = "all-services"  # Multi-service coordination

[molecules.scope]
gaps = ["Gap 7"]
services = [
    "gateway",
    "aianalysis",
    "workflowexecution",
    "orchestrator",
    "notification"
]
event_types = [
    "gateway.*.failure",
    "aianalysis.*.failure",
    "workflowexecution.*.failure",
    "orchestration.*.failure",
    "notification.*.failure"
]
test_files = [
    "test/integration/gateway/audit_error_handling_test.go",
    "test/integration/aianalysis/audit_error_handling_test.go",
    "test/integration/workflowexecution/audit_error_handling_test.go",
    "test/integration/orchestrator/audit_error_handling_test.go",
    "test/integration/notification/audit_error_handling_test.go"
]
estimated_test_specs = 7  # 1-2 per service

[molecules.dependencies]
requires = ["day3-workflow-refs"]
blocks = ["day6-timeout-config", "day7-8-rr-reconstruction"]

[molecules.coordination_strategy]
approach = "parallel_per_service"
parallel_molecules = [
    "day4-gateway-errors",
    "day4-ai-errors",
    "day4-we-errors",
    "day4-orchestrator-errors",
    "day4-notification-errors"
]
benefit = "Reduces calendar time from 2 days to 1 day"

[molecules.estimated_effort]
total_sequential = "8-10h"  # If done sequentially
total_parallel = "4-5h"     # If done in parallel per service

[[molecules]]
id = "day6-timeout-config"
name = "Day 6: Timeout Configuration (Gap 8)"
formula = "integration-test-full-validation"
formula_version = "2.1"
status = "planned"
estimated_start_date = "2026-01-09"
estimated_end_date = "2026-01-09"
owner = "@jgil"
team = "orchestrator"

[molecules.scope]
gaps = ["Gap 8"]
services = ["orchestrator"]
event_types = ["orchestration.remediation.created"]
test_file = "test/integration/orchestrator/audit_timeout_config_test.go"
estimated_test_specs = 3

[molecules.dependencies]
requires = ["day4-5-error-details"]
blocks = ["day7-8-rr-reconstruction"]

[molecules.estimated_effort]
total = "2-2.5h"

[[molecules]]
id = "day7-8-rr-reconstruction"
name = "Day 7-8: Full RR Reconstruction Integration"
formula = "integration-test-full-validation"
formula_version = "2.1"
status = "planned"
estimated_start_date = "2026-01-10"
estimated_end_date = "2026-01-11"
owner = "@jgil"
team = "cross-service"

[molecules.scope]
gaps = ["Integration"]
services = [
    "gateway",
    "signalprocessing",
    "aianalysis",
    "workflowexecution",
    "orchestrator"
]
event_types_minimum = 9  # Full lifecycle with HAPI
test_files = [
    "test/integration/orchestrator/audit_rr_reconstruction_integration_test.go",
    "test/e2e/audit/full_lifecycle_reconstruction_test.go"
]
estimated_test_specs = 5  # 3 integration + 2 E2E

[molecules.dependencies]
requires = [
    "day3-workflow-refs",
    "day4-5-error-details",
    "day6-timeout-config"
]
blocks = []  # This is the final molecule

[molecules.validation]
reconstruction_accuracy = "100%"
event_completeness = "all_9_events_present"
cross_service_correlation = "validated"

[molecules.estimated_effort]
total = "6-8h"  # Most complex molecule, cross-service coordination

# ========================================
# CONVOY METRICS
# ========================================

[metrics]
total_molecules = 5  # Can be 6-10 if parallel strategy used for Day 4-5
completed_molecules = 2
in_progress_molecules = 0
planned_molecules = 3
blocked_molecules = 0

total_test_specs_planned = 21  # 3 + 3 + 3 + 7 + 3 + 5 = 24 (adjusted for parallel)
completed_test_specs = 6  # Day 1 + Day 2
remaining_test_specs = 15

total_gaps_planned = 8  # Gaps 1-8
completed_gaps = 4  # Gaps 1-4
remaining_gaps = 4  # Gaps 5-8

total_services = 7
services_with_audit_events = 7  # All services will have audit events after completion

[quality_gates]
test_pass_rate_requirement = 100.0
compliance_validation_required = true
human_checkpoints_per_molecule = 4
anti_pattern_detection_enabled = true

[progress]
days_completed = 2
days_remaining = 6
percent_complete = 25.0
on_track = true
blocking_issues = 0

# ========================================
# HANDOFF STATUS
# ========================================

[handoffs]
day1_to_day2 = "completed"
day2_to_day3 = "ready"  # Day 2 at 100%, Day 3 can start
day3_to_day4 = "pending"
day4_to_day6 = "pending"
day6_to_day7 = "pending"

# ========================================
# COORDINATION
# ========================================

[coordination]
primary_communication = "gas-town-mail-system"
secondary_communication = "slack-#kubernaut-soc2"
checkpoint_notifications = "email + slack"
status_dashboard = "gastown convoy show soc2-audit-trail"

[coordination.patterns]
analysis_checkpoint = "Polecat asks questions before implementation"
plan_checkpoint = "Human approves plan before DO phase"
test_validation_checkpoint = "Human confirms 100% pass before compliance"
compliance_checkpoint = "Human reviews triage report before day completion"

# ========================================
# SUCCESS CRITERIA
# ========================================

[success_criteria]
all_gaps_closed = false  # 4/8 complete
all_tests_passing = true  # 6/6 (100% so far)
compliance_validated = true
documentation_updated = true
rr_reconstruction_validated = false  # Day 7-8 work

[success_criteria.soc2_compliance]
defense_in_depth_auditing = true  # Hybrid approach (Day 2)
complete_rr_reconstruction = false  # Day 7-8 work
operator_attribution = false  # Week 2-3 work (separate convoy)
audit_event_standards = true  # DD-TESTING-001 compliance

# ========================================
# RISKS & MITIGATIONS
# ========================================

[[risks]]
id = "risk-1"
description = "Day 4-5 multi-service coordination may cause delays"
likelihood = "medium"
impact = "medium"
mitigation = "Use parallel molecule strategy per service"
status = "mitigated"

[[risks]]
id = "risk-2"
description = "E2E tests in Day 7-8 may be flaky"
likelihood = "low"
impact = "high"
mitigation = "Use Eventually() with generous timeouts, follow TESTING_GUIDELINES.md"
status = "planned"

[[risks]]
id = "risk-3"
description = "Checkpoint approval delays may extend timeline"
likelihood = "low"
impact = "low"
mitigation = "2h timeout with proactive notifications, async approval via CLI"
status = "acceptable"

# ========================================
# LESSONS LEARNED (Updated per day)
# ========================================

[[lessons_learned]]
date = "2026-01-04"
day = "day1"
lesson = "Gateway audit integration smooth, existing patterns worked well"
action = "Continue using DD-TESTING-001 helper functions"

[[lessons_learned]]
date = "2026-01-05"
day = "day2"
lesson = "Hybrid approach (HAPI + AA) provides superior defense-in-depth"
action = "Document as best practice in DD-AUDIT-005, consider for other provider integrations"

[[lessons_learned]]
date = "2026-01-05"
day = "day2"
lesson = "TDD violation occurred when tests weren't written first"
action = "Enforce APDC analysis-checkpoint to prevent future violations"

# ========================================
# CONVOY HEALTH
# ========================================

[health]
status = "healthy"
last_updated = "2026-01-05T18:00:00Z"
blocking_issues = 0
overdue_checkpoints = 0
failing_molecules = 0

[health.quality_indicators]
test_pass_rate = 100.0
compliance_pass_rate = 100.0
checkpoint_approval_rate = 100.0
on_schedule = true


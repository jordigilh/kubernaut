openapi: 3.0.3
info:
  title: Data Storage Service API
  version: 2.0.0
  description: |
    REST API for querying Kubernetes remediation action history and success rate analytics.

    This API provides read-only access to incident data stored in PostgreSQL,
    including resource action traces, alert information, remediation history, and
    **ADR-033 multi-dimensional success tracking**.

    **Version 2.0.0 (ADR-033)**: Multi-dimensional success tracking
    - Incident-type success rate aggregation
    - Playbook success rate aggregation
    - AI execution mode distribution tracking
    - Confidence-based recommendations

    **Phase 1 (Current)**: Read API only
    **Phase 2 (Future)**: Write API for creating incidents
  contact:
    name: Kubernaut Team
    url: https://github.com/jordigilh/kubernaut
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://data-storage.kubernaut-system.svc.cluster.local:8080
    description: Kubernetes cluster (in-cluster service)
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Incidents
    description: Query remediation action incidents
  - name: Success Rate Analytics
    description: ADR-033 multi-dimensional success tracking and aggregation
  - name: Health
    description: Health check endpoints

paths:
  # ========================================
  # ADR-033: SUCCESS RATE ANALYTICS (NEW IN V2.0.0)
  # ========================================

  /api/v1/success-rate/incident-type:
    get:
      summary: Get success rate by incident type
      description: |
        **ADR-033 PRIMARY DIMENSION**: Calculate remediation success rate by incident type.

        This endpoint provides success rate analytics for specific incident types (e.g., "pod-oom-killer", "disk-pressure"),
        enabling AI to learn which remediation approaches work best for each problem category.

        **Key Features**:
        - Success rate percentage (0-100%)
        - Confidence levels (high/medium/low/insufficient_data)
        - AI execution mode distribution (catalog/chained/manual)
        - Playbook breakdown showing which playbooks were tried
        - Time range filtering for recent vs historical data

        **Use Cases**:
        - AI playbook selection optimization
        - Incident-specific remediation effectiveness
        - Historical trend analysis
        - Confidence-based decision making

        **BR-STORAGE-031-01**: Incident-Type Success Rate API
      operationId: getSuccessRateByIncidentType
      tags:
        - Success Rate Analytics
      parameters:
        - name: incident_type
          in: query
          required: true
          schema:
            type: string
          description: |
            The incident type to query (e.g., "pod-oom-killer", "disk-pressure", "network-timeout").
            This is the PRIMARY dimension for success tracking per ADR-033.
          example: "pod-oom-killer"

        - name: time_range
          in: query
          required: false
          schema:
            type: string
            pattern: '^[0-9]+(h|d)$'
            default: "7d"
          description: |
            Time window for analysis. Valid formats: "1h", "24h", "7d", "30d".
            Default: "7d" (last 7 days).
          example: "7d"

        - name: min_samples
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 5
          description: |
            Minimum sample size for confidence calculation.
            - high confidence: >=100 samples
            - medium confidence: 20-99 samples
            - low confidence: 5-19 samples
            - insufficient_data: <5 samples (or below this threshold)
          example: 5

      responses:
        '200':
          description: Successful response with incident-type success rate data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentTypeSuccessRateResponse'
              examples:
                high_confidence:
                  summary: High confidence example (100+ samples)
                  value:
                    incident_type: "pod-oom-killer"
                    time_range: "7d"
                    total_executions: 150
                    successful_executions: 135
                    failed_executions: 15
                    success_rate: 90.0
                    confidence: "high"
                    min_samples_met: true
                    ai_execution_mode:
                      catalog_selected: 135
                      chained: 12
                      manual_escalation: 3
                    playbook_breakdown:
                      - playbook_id: "pod-oom-recovery"
                        playbook_version: "v1.2"
                        executions: 120
                        success_rate: 92.5
                      - playbook_id: "memory-limit-increase"
                        playbook_version: "v2.0"
                        executions: 30
                        success_rate: 80.0

                insufficient_data:
                  summary: Insufficient data example (<5 samples)
                  value:
                    incident_type: "rare-database-deadlock"
                    time_range: "7d"
                    total_executions: 3
                    successful_executions: 2
                    failed_executions: 1
                    success_rate: 66.67
                    confidence: "insufficient_data"
                    min_samples_met: false
                    ai_execution_mode:
                      catalog_selected: 2
                      chained: 0
                      manual_escalation: 1
                    playbook_breakdown: []

        '400':
          description: Bad request - Missing or invalid parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                missing_incident_type:
                  summary: Missing required incident_type parameter
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "incident_type query parameter is required"
                    instance: "/api/v1/success-rate/incident-type"

                invalid_time_range:
                  summary: Invalid time_range format
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "invalid time_range format: 5w (expected format: 1h, 24h, 7d, 30d)"
                    instance: "/api/v1/success-rate/incident-type?incident_type=pod-oom-killer&time_range=5w"

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                database_error:
                  summary: Database query failure
                  value:
                    type: "https://api.kubernaut.io/problems/internal-error"
                    title: "Internal Server Error"
                    status: 500
                    detail: "Failed to retrieve success rate data"
                    instance: "/api/v1/success-rate/incident-type?incident_type=pod-oom-killer"

  /api/v1/success-rate/playbook:
    get:
      summary: Get success rate by playbook
      description: |
        **ADR-033 SECONDARY DIMENSION**: Calculate remediation success rate by playbook.

        This endpoint provides success rate analytics for specific playbooks (e.g., "pod-oom-recovery", "disk-cleanup"),
        enabling AI to learn which playbooks are most effective overall and for which incident types.

        **Key Features**:
        - Success rate percentage (0-100%)
        - Confidence levels (high/medium/low/insufficient_data)
        - AI execution mode distribution (catalog/chained/manual)
        - Incident-type breakdown showing which problems this playbook solves
        - Version filtering for A/B testing and rollout validation

        **Use Cases**:
        - Playbook effectiveness validation
        - Version comparison (v1.0 vs v2.0)
        - Incident-type suitability analysis
        - Playbook catalog optimization

        **BR-STORAGE-031-02**: Playbook Success Rate API
      operationId: getSuccessRateByPlaybook
      tags:
        - Success Rate Analytics
      parameters:
        - name: playbook_id
          in: query
          required: true
          schema:
            type: string
          description: |
            The playbook identifier to query (e.g., "pod-oom-recovery", "disk-cleanup").
            This is the SECONDARY dimension for success tracking per ADR-033.
          example: "pod-oom-recovery"

        - name: playbook_version
          in: query
          required: false
          schema:
            type: string
            pattern: '^v[0-9]+\.[0-9]+(\.[0-9]+)?$'
          description: |
            Optional: Filter by specific playbook version (e.g., "v1.2", "v2.0").
            Omit to aggregate across all versions.
          example: "v1.2"

        - name: time_range
          in: query
          required: false
          schema:
            type: string
            pattern: '^[0-9]+(h|d)$'
            default: "7d"
          description: |
            Time window for analysis. Valid formats: "1h", "24h", "7d", "30d".
            Default: "7d" (last 7 days).
          example: "7d"

        - name: min_samples
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 5
          description: |
            Minimum sample size for confidence calculation.
            Same thresholds as incident-type endpoint.
          example: 5

      responses:
        '200':
          description: Successful response with playbook success rate data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaybookSuccessRateResponse'
              examples:
                all_versions:
                  summary: Aggregated across all versions
                  value:
                    playbook_id: "pod-oom-recovery"
                    playbook_version: null
                    time_range: "7d"
                    total_executions: 200
                    successful_executions: 185
                    failed_executions: 15
                    success_rate: 92.5
                    confidence: "high"
                    min_samples_met: true
                    ai_execution_mode:
                      catalog_selected: 180
                      chained: 15
                      manual_escalation: 5
                    incident_type_breakdown:
                      - incident_type: "pod-oom-killer"
                        executions: 150
                        success_rate: 94.0
                      - incident_type: "container-memory-pressure"
                        executions: 50
                        success_rate: 88.0

                specific_version:
                  summary: Filtered by version v2.0
                  value:
                    playbook_id: "pod-oom-recovery"
                    playbook_version: "v2.0"
                    time_range: "7d"
                    total_executions: 80
                    successful_executions: 76
                    failed_executions: 4
                    success_rate: 95.0
                    confidence: "high"
                    min_samples_met: true
                    ai_execution_mode:
                      catalog_selected: 75
                      chained: 4
                      manual_escalation: 1
                    incident_type_breakdown:
                      - incident_type: "pod-oom-killer"
                        executions: 60
                        success_rate: 96.67
                      - incident_type: "container-memory-pressure"
                        executions: 20
                        success_rate: 90.0

        '400':
          description: Bad request - Missing or invalid parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                missing_playbook_id:
                  summary: Missing required playbook_id parameter
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "playbook_id query parameter is required"
                    instance: "/api/v1/success-rate/playbook"

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  # ========================================
  # EXISTING V1 ENDPOINTS (UNCHANGED)
  # ========================================

  /api/v1/incidents:
    get:
      summary: List incidents with filters
      description: |
        Retrieve a paginated list of incidents filtered by alert name, severity, action type, etc.

        Supports:
        - Filter by alert_name, severity, action_type
        - Pagination with limit/offset
        - Sorting by action_timestamp (DESC)
      operationId: listIncidents
      tags:
        - Incidents
      parameters:
        - name: alert_name
          in: query
          required: false
          schema:
            type: string
          description: Filter by alert name pattern (exact match)
          example: "test-integration-prod-cpu-high"

        - name: severity
          in: query
          required: false
          schema:
            type: string
            enum: [low, medium, high, critical]
          description: Filter by alert severity
          example: "critical"

        - name: action_type
          in: query
          required: false
          schema:
            type: string
          description: Filter by action type (e.g., scale, restart, check)
          example: "scale"

        - name: namespace
          in: query
          required: false
          schema:
            type: string
          description: Filter by Kubernetes namespace
          example: "production"

        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Maximum number of results to return
          example: 50

        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip (for pagination)
          example: 100

      responses:
        '200':
          description: Successful response with incident list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentListResponse'

        '400':
          description: Bad request - Invalid filter parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/incidents/{id}:
    get:
      summary: Get incident by ID
      description: Retrieve a single incident by its unique identifier
      operationId: getIncidentByID
      tags:
        - Incidents
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Unique incident ID
          example: 12345

      responses:
        '200':
          description: Successful response with incident details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

        '404':
          description: Incident not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /health:
    get:
      summary: Health check endpoint
      description: Check if the service is healthy (application + database)
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            text/plain:
              schema:
                type: string
                example: "OK"
        '503':
          description: Service is unhealthy
          content:
            text/plain:
              schema:
                type: string
                example: "Database connection failed"

  /health/ready:
    get:
      summary: Readiness probe
      description: Check if the service is ready to accept traffic (Kubernetes readiness probe)
      operationId: readinessCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is ready
          content:
            text/plain:
              schema:
                type: string
                example: "OK"
        '503':
          description: Service is not ready (shutting down or starting up)
          content:
            text/plain:
              schema:
                type: string
                example: "Service is shutting down"

  /health/live:
    get:
      summary: Liveness probe
      description: Check if the service is alive (Kubernetes liveness probe)
      operationId: livenessCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is alive
          content:
            text/plain:
              schema:
                type: string
                example: "OK"

components:
  schemas:
    # ========================================
    # ADR-033: SUCCESS RATE SCHEMAS (NEW IN V2.0.0)
    # ========================================

    IncidentTypeSuccessRateResponse:
      type: object
      required:
        - incident_type
        - time_range
        - total_executions
        - successful_executions
        - failed_executions
        - success_rate
        - confidence
        - min_samples_met
      properties:
        incident_type:
          type: string
          description: The incident type being analyzed (e.g., "pod-oom-killer")
          example: "pod-oom-killer"

        time_range:
          type: string
          description: Time window for this analysis (e.g., "7d")
          example: "7d"

        total_executions:
          type: integer
          minimum: 0
          description: Total number of remediation attempts for this incident type
          example: 150

        successful_executions:
          type: integer
          minimum: 0
          description: Number of successful remediation attempts
          example: 135

        failed_executions:
          type: integer
          minimum: 0
          description: Number of failed remediation attempts
          example: 15

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate percentage (0-100%)
          example: 90.0

        confidence:
          type: string
          enum: [high, medium, low, insufficient_data]
          description: |
            Confidence level based on sample size:
            - high: >=100 samples
            - medium: 20-99 samples
            - low: 5-19 samples
            - insufficient_data: <5 samples (or below min_samples threshold)
          example: "high"

        min_samples_met:
          type: boolean
          description: Whether the minimum sample size threshold was met
          example: true

        ai_execution_mode:
          $ref: '#/components/schemas/AIExecutionModeStats'
          description: Distribution of AI execution modes (ADR-033 Hybrid Model)

        playbook_breakdown:
          type: array
          items:
            $ref: '#/components/schemas/PlaybookBreakdownItem'
          description: Breakdown by playbook showing which playbooks were tried for this incident type

    PlaybookSuccessRateResponse:
      type: object
      required:
        - playbook_id
        - time_range
        - total_executions
        - successful_executions
        - failed_executions
        - success_rate
        - confidence
        - min_samples_met
      properties:
        playbook_id:
          type: string
          description: The playbook identifier being analyzed (e.g., "pod-oom-recovery")
          example: "pod-oom-recovery"

        playbook_version:
          type: string
          nullable: true
          description: Specific playbook version (null if aggregated across all versions)
          example: "v1.2"

        time_range:
          type: string
          description: Time window for this analysis (e.g., "7d")
          example: "7d"

        total_executions:
          type: integer
          minimum: 0
          description: Total number of times this playbook was executed
          example: 200

        successful_executions:
          type: integer
          minimum: 0
          description: Number of successful playbook executions
          example: 185

        failed_executions:
          type: integer
          minimum: 0
          description: Number of failed playbook executions
          example: 15

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate percentage (0-100%)
          example: 92.5

        confidence:
          type: string
          enum: [high, medium, low, insufficient_data]
          description: Confidence level based on sample size
          example: "high"

        min_samples_met:
          type: boolean
          description: Whether the minimum sample size threshold was met
          example: true

        ai_execution_mode:
          $ref: '#/components/schemas/AIExecutionModeStats'
          description: Distribution of AI execution modes for this playbook

        incident_type_breakdown:
          type: array
          items:
            $ref: '#/components/schemas/IncidentTypeBreakdownItem'
          description: Breakdown by incident type showing which problems this playbook solves

    AIExecutionModeStats:
      type: object
      required:
        - catalog_selected
        - chained
        - manual_escalation
      properties:
        catalog_selected:
          type: integer
          minimum: 0
          description: |
            Number of times AI selected a single playbook from the catalog (90-95% expected per ADR-033 Hybrid Model)
          example: 135

        chained:
          type: integer
          minimum: 0
          description: |
            Number of times AI chained multiple playbooks together (4-9% expected per ADR-033 Hybrid Model)
          example: 12

        manual_escalation:
          type: integer
          minimum: 0
          description: |
            Number of times AI escalated to human operator (<1% expected per ADR-033 Hybrid Model)
          example: 3

    PlaybookBreakdownItem:
      type: object
      required:
        - playbook_id
        - playbook_version
        - executions
        - success_rate
      properties:
        playbook_id:
          type: string
          description: Playbook identifier
          example: "pod-oom-recovery"

        playbook_version:
          type: string
          description: Playbook version
          example: "v1.2"

        executions:
          type: integer
          minimum: 0
          description: Number of times this playbook was used
          example: 120

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate for this specific playbook
          example: 92.5

    IncidentTypeBreakdownItem:
      type: object
      required:
        - incident_type
        - executions
        - success_rate
      properties:
        incident_type:
          type: string
          description: Incident type identifier
          example: "pod-oom-killer"

        executions:
          type: integer
          minimum: 0
          description: Number of times this playbook was used for this incident type
          example: 150

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate for this specific incident type
          example: 94.0

    # ========================================
    # EXISTING V1 SCHEMAS (UNCHANGED)
    # ========================================

    IncidentListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Incident'
          description: Array of incidents matching the filter criteria
        pagination:
          $ref: '#/components/schemas/Pagination'
          description: Pagination metadata

    Incident:
      type: object
      required:
        - id
        - alert_name
        - alert_severity
        - action_type
        - action_timestamp
        - model_used
        - model_confidence
        - execution_status
      properties:
        id:
          type: integer
          format: int64
          description: Unique incident identifier (from resource_action_traces table)
          example: 12345

        alert_name:
          type: string
          description: Name of the Prometheus alert or Kubernetes event
          example: "prod-cpu-high"

        alert_fingerprint:
          type: string
          description: Unique alert fingerprint from Prometheus
          example: "abc123def456"

        alert_severity:
          type: string
          enum: [low, medium, high, critical]
          description: Severity level of the alert
          example: "critical"

        action_type:
          type: string
          description: Type of remediation action taken (e.g., scale, restart, check)
          example: "scale"

        action_timestamp:
          type: string
          format: date-time
          description: Timestamp when the action was executed (ISO 8601)
          example: "2025-11-02T10:30:00Z"

        namespace:
          type: string
          description: Kubernetes namespace where the action was taken
          example: "production"

        cluster_name:
          type: string
          description: Kubernetes cluster identifier
          example: "prod-us-west-2"

        environment:
          type: string
          description: Environment (e.g., production, staging, development)
          example: "production"

        target_resource:
          type: string
          description: Target Kubernetes resource (e.g., deployment/my-app)
          example: "deployment/nginx"

        remediation_request_id:
          type: string
          description: Unique remediation request identifier
          example: "req-abc-123"

        model_used:
          type: string
          description: AI model used for analysis (e.g., gpt-4, claude-3)
          example: "gpt-4"

        model_confidence:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          description: Confidence score from the AI model (0.0 to 1.0)
          example: 0.95

        execution_status:
          type: string
          enum: [pending, in_progress, completed, failed, cancelled]
          description: Current status of the remediation action
          example: "completed"

        start_time:
          type: string
          format: date-time
          description: When the remediation started (ISO 8601)
          example: "2025-11-02T10:30:00Z"

        end_time:
          type: string
          format: date-time
          description: When the remediation completed (ISO 8601)
          example: "2025-11-02T10:35:00Z"

        duration:
          type: integer
          format: int64
          description: Duration of the remediation in milliseconds
          example: 300000

        error_message:
          type: string
          description: Error message if the remediation failed
          example: "Failed to scale deployment: insufficient resources"

        metadata:
          type: string
          description: Additional metadata as JSON string
          example: "{\"replicas_before\":2,\"replicas_after\":5}"

    Pagination:
      type: object
      required:
        - total
        - limit
        - offset
        - has_more
      properties:
        total:
          type: integer
          format: int64
          description: Total number of incidents matching the filter criteria
          example: 1523

        limit:
          type: integer
          description: Maximum number of results returned in this response
          example: 100

        offset:
          type: integer
          description: Number of results skipped (pagination offset)
          example: 0

        has_more:
          type: boolean
          description: Whether there are more results available (for next page)
          example: true

    RFC7807Error:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: URI reference identifying the problem type
          example: "https://api.kubernaut.io/problems/invalid-filter"

        title:
          type: string
          description: Short, human-readable summary of the problem
          example: "Invalid Filter Parameter"

        status:
          type: integer
          description: HTTP status code
          example: 400

        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
          example: "The 'severity' filter value must be one of: low, medium, high, critical"

        instance:
          type: string
          format: uri
          description: URI reference identifying the specific occurrence of the problem
          example: "/api/v1/incidents"

  securitySchemes:
    # Future: Add authentication when needed
    # BearerAuth:
    #   type: http
    #   scheme: bearer
    #   bearerFormat: JWT

# Future: Add security when authentication is implemented
# security:
#   - BearerAuth: []


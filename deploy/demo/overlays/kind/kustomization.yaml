apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base/

# Override image tags for all Kubernaut services.
# Usage: kustomize edit set image quay.io/kubernaut-ai/*:newTag
# or set DEMO_TAG in Makefile which patches this via sed.
images:
- name: quay.io/kubernaut-ai/aianalysis
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/authwebhook
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/datastorage
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/effectivenessmonitor
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/gateway
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/holmesgpt-api
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/notification
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/remediationorchestrator
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/signalprocessing
  newTag: demo-v1.0
- name: quay.io/kubernaut-ai/workflowexecution
  newTag: demo-v1.0

  # Gateway Service: ClusterIP -> NodePort

  # DataStorage Service: ClusterIP -> NodePort

  # Prometheus Service: ClusterIP -> NodePort

  # AlertManager Service: ClusterIP -> NodePort

  # HolmesGPT API Service: ClusterIP -> NodePort

  # Grafana Service: ClusterIP -> NodePort

  # All Deployments in kubernaut-system: schedule on control-plane node (Kind)
patches:
- patch: |
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30080
    - op: add
      path: /spec/ports/1/nodePort
      value: 30090
  target:
    kind: Service
    name: gateway-service
    namespace: kubernaut-system
- patch: |
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30081
  target:
    kind: Service
    name: data-storage-service
    namespace: kubernaut-system
- patch: |
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30190
  target:
    kind: Service
    name: prometheus-svc
    namespace: kubernaut-system
- patch: |
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30193
  target:
    kind: Service
    name: alertmanager-svc
    namespace: kubernaut-system
- patch: |
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30120
  target:
    kind: Service
    name: holmesgpt-api
    namespace: kubernaut-system
- patch: |
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30300
  target:
    kind: Service
    name: grafana-svc
    namespace: kubernaut-system
- patch: |
    - op: add
      path: /spec/template/spec/nodeSelector
      value:
        node-role.kubernetes.io/control-plane: ""
    - op: add
      path: /spec/template/spec/tolerations
      value:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
  target:
    kind: Deployment
    namespace: kubernaut-system

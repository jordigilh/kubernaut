apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Authority: DD-AUTH-008 (Secret Management Strategy - Production)
# Purpose: Generate OAuth2-proxy cookie secrets from secure files

namespace: kubernaut-system

secretGenerator:
  # DataStorage OAuth2-Proxy Cookie Secret (Production)
  # Reads from secure file location (NOT in Git)
  - name: data-storage-oauth-proxy-secret
    files:
      # Path to secure file containing 32-byte random string
      # Generate once: openssl rand -base64 32 > /vault/secrets/ds-cookie-secret.txt
      - cookie-secret=/vault/secrets/ds-cookie-secret.txt
    options:
      disableNameSuffixHash: true
    type: Opaque

  # HolmesGPT API OAuth2-Proxy Cookie Secret (Production)
  - name: holmesgpt-api-oauth-proxy-secret
    files:
      # Generate once: openssl rand -base64 32 > /vault/secrets/hapi-cookie-secret.txt
      - cookie-secret=/vault/secrets/hapi-cookie-secret.txt
    options:
      disableNameSuffixHash: true
    type: Opaque

# ========================================
# PRODUCTION DEPLOYMENT
# ========================================
#
# Prerequisites:
#   1. Generate secrets once per environment:
#      openssl rand -base64 32 > /vault/secrets/ds-cookie-secret.txt
#      openssl rand -base64 32 > /vault/secrets/hapi-cookie-secret.txt
#
#   2. Secure the files:
#      chmod 600 /vault/secrets/*.txt
#      chown root:root /vault/secrets/*.txt
#
#   3. Verify files exist:
#      ls -la /vault/secrets/
#
# Deploy:
#   kubectl apply -k deploy/secrets/production/
#
# ========================================
# SECURITY NOTES
# ========================================
#
# 1. File Location:
#    - /vault/secrets/ should be:
#      * Encrypted filesystem (e.g., LUKS, dm-crypt)
#      * Restricted permissions (700)
#      * Backed up securely
#      * NOT in Git repository
#
# 2. Secret Rotation:
#    - Regenerate secret files
#    - Redeploy: kubectl apply -k deploy/secrets/production/
#    - Restart deployments: kubectl rollout restart ...
#
# 3. Access Control:
#    - Only deployment operators should have access to /vault/secrets/
#    - Use Kubernetes RBAC to restrict Secret access
#    - Audit all secret access via Kubernetes audit logs
#
# ========================================
# ALTERNATIVE: EXTERNAL SECRETS OPERATOR
# ========================================
#
# For enterprise deployments, consider:
#   - HashiCorp Vault
#   - AWS Secrets Manager
#   - Azure Key Vault
#   - External Secrets Operator
#
# See: DD-AUTH-008 Section "Alternative 3: External Secrets Operator"
#
# ========================================

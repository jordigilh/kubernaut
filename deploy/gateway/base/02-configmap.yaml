apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-config
  namespace: kubernaut-system
  labels:
    app.kubernetes.io/name: kubernaut
    app.kubernetes.io/component: gateway
    app.kubernetes.io/part-of: kubernaut
data:
  config.yaml: |
    # Gateway Service Configuration
    # Organized by Single Responsibility Principle
    # See: pkg/gateway/server.go - type ServerConfig struct

    # HTTP Server configuration
    server:
      listenAddr: ":8080"
      readTimeout: 30s
      writeTimeout: 30s
      idleTimeout: 120s

    # Middleware configuration
    middleware:
      rate_limit:
        requests_per_minute: 100
        burst: 10

    # DD-GATEWAY-012: Redis REMOVED - Gateway is now Redis-free (K8s-native)
    # All deduplication and storm state managed via RR status fields

    # Infrastructure configuration
    infrastructure:
      # DD-AUDIT-003: Data Storage URL for audit event emission
      # Gateway emits audit events for signal processing (signal.received, signal.deduplicated, storm.detected)
      dataStorageUrl: "http://data-storage-service:8080"

    # Business logic configuration
    processing:
      deduplication:
        ttl: 5m

      storm:
        # Storm Detection (existing)
        rate_threshold: 10
        pattern_threshold: 5
        aggregation_window: 1m  # DEPRECATED: Use inactivity_timeout for DD-GATEWAY-008

        # DD-GATEWAY-008: Buffered First-Alert Aggregation (BR-GATEWAY-016)
        buffer_threshold: 5       # Alerts to buffer before creating window (default: 5)

        # DD-GATEWAY-008: Sliding Window with Inactivity Timeout (BR-GATEWAY-008)
        inactivity_timeout: 60s   # Sliding window timeout (resets on each alert)
        max_window_duration: 5m   # Maximum window duration (safety limit)

        # DD-GATEWAY-008: Multi-Tenant Isolation (BR-GATEWAY-011)
        default_max_size: 1000    # Default namespace buffer size
        global_max_size: 5000     # Global buffer limit across all namespaces
        # per_namespace_limits:   # Optional per-namespace overrides
        #   prod-api: 2000        # Example: prod-api gets 2000 buffer size
        #   dev-test: 500         # Example: dev-test gets 500 buffer size

        # DD-GATEWAY-008: Overflow Handling (BR-GATEWAY-011)
        sampling_threshold: 0.95  # Utilization to trigger sampling (95%)
        sampling_rate: 0.5        # Sample rate when threshold reached (50%)

      environment:
        cache_ttl: 30s
        configmap_namespace: kubernaut-system
        configmap_name: kubernaut-environment-overrides

  priority.rego: |
    # Priority Assignment Policy for Gateway Service
    #
    # This Rego policy determines alert priority based on:
    # - Severity (critical, warning, info)
    # - Environment (production, staging, development)
    # - Optional: Custom labels (team, service, etc.)
    #
    # Priority levels:
    # - P0: Critical production issues (immediate response)
    # - P1: High priority issues (response within 1 hour)
    # - P2: Normal priority issues (best effort)
    # - P3: Low priority issues (background processing)

    package kubernaut.gateway.priority

    import rego.v1

    # Default priority if no rules match
    default priority := "P2"

    # P0: Critical production issues
    priority := "P0" if {
        input.severity == "critical"
        input.environment == "production"
    }

    # P0: Critical issues for high-value teams (custom rule example)
    priority := "P0" if {
        input.severity == "critical"
        input.labels["team"] == "platform-engineering"
    }

    # P1: Critical staging issues (pre-production testing)
    priority := "P1" if {
        input.severity == "critical"
        input.environment == "staging"
    }

    # P1: Warning production issues (may escalate)
    priority := "P1" if {
        input.severity == "warning"
        input.environment == "production"
    }

    # P2: Critical development issues
    priority := "P2" if {
        input.severity == "critical"
        input.environment == "development"
    }

    # P2: Warning staging issues
    priority := "P2" if {
        input.severity == "warning"
        input.environment == "staging"
    }

    # P2: Warning development issues
    priority := "P2" if {
        input.severity == "warning"
        input.environment == "development"
    }

    # P3: Info alerts (any environment)
    priority := "P3" if {
        input.severity == "info"
    }

    # P3: Unknown severity (safety default)
    priority := "P3" if {
        not input.severity
    }


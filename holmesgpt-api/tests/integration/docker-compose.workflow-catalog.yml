# Docker Compose for Workflow Catalog Integration Tests
version: '3.8'

services:
  postgres-integration:
    image: pgvector/pgvector:pg16
    container_name: kubernaut-postgres-integration
    environment:
      POSTGRES_DB: kubernaut_test
      POSTGRES_USER: kubernaut
      POSTGRES_PASSWORD: kubernaut_test_password
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "15433:5432"
    volumes:
      - postgres-integration-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kubernaut -d kubernaut_test"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - kubernaut-integration

  redis-integration:
    image: redis:7-alpine
    container_name: kubernaut-redis-integration
    ports:
      - "16380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - kubernaut-integration

  embedding-service:
    build:
      context: ../../../embedding-service
      dockerfile: Dockerfile
    container_name: kubernaut-embedding-service-integration
    environment:
      - EMBEDDING_SERVICE_PORT=8086
      - EMBEDDING_DEVICE=cpu
      - LOG_LEVEL=INFO
    ports:
      - "18000:8086"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - kubernaut-integration

  data-storage-service:
    image: localhost/data-storage:integration
    container_name: kubernaut-data-storage-integration
    environment:
      - CONFIG_PATH=/app/config/data-storage-integration.yaml
      - EMBEDDING_SERVICE_URL=http://embedding-service:8086
    ports:
      - "18090:8080"
    volumes:
      - ./data-storage-integration.yaml:/app/config/data-storage-integration.yaml:ro
      - ./secrets/database-credentials.yaml:/app/secrets/database-credentials.yaml:ro
      - ./secrets/redis-credentials.yaml:/app/secrets/redis-credentials.yaml:ro
    depends_on:
      postgres-integration:
        condition: service_healthy
      redis-integration:
        condition: service_healthy
      embedding-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - kubernaut-integration

networks:
  kubernaut-integration:
    driver: bridge

volumes:
  postgres-integration-data:
  embedding-model-cache:

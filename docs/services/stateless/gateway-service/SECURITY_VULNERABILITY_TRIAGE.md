# Security Vulnerability Triage - Implementation Plan Alignment
**Date**: 2025-10-23
**Plan Version**: v2.9
**Security Report**: SECURITY_TRIAGE_REPORT.md v1.0

---

## üéØ **Executive Summary**

**Status**: ‚ö†Ô∏è **PARTIAL COVERAGE** - 3/5 vulnerabilities addressed, 2 CRITICAL gaps
**Action Required**: Expand Day 6 (Authentication & Security) with missing components
**Estimated Additional Time**: +6 hours (Day 6: 8h ‚Üí 14h)

---

## üìä **Vulnerability Coverage Matrix**

| Vulnerability | Severity | Plan Coverage | Status | Action Required |
|---------------|----------|---------------|--------|-----------------|
| **VULN-GATEWAY-001**: No Authentication | üî¥ CRITICAL (9.1) | ‚ö†Ô∏è **PARTIAL** | ‚ùå **GAP** | Expand Day 6 (+3h) |
| **VULN-GATEWAY-002**: No Authorization | üî¥ CRITICAL (8.8) | ‚ùå **MISSING** | ‚ùå **GAP** | Add to Day 6 (+3h) |
| **VULN-GATEWAY-003**: Insufficient DOS | üü° MEDIUM (6.5) | ‚úÖ **COVERED** | ‚úÖ Pass | Day 6 (rate limiting) |
| **VULN-GATEWAY-004**: Sensitive Data Logs | üü° MEDIUM (5.3) | ‚ùå **MISSING** | ‚ö†Ô∏è Defer v1.1 | Add to Day 7 (v1.1) |
| **VULN-GATEWAY-005**: Redis Creds Exposure | üü° MEDIUM (5.9) | ‚ùå **MISSING** | ‚ö†Ô∏è Defer v1.1 | Add to Day 12 (v1.1) |

---

## üî¥ **CRITICAL GAPS - MUST FIX FOR v1.0**

### **GAP 1: VULN-GATEWAY-001 - Incomplete Authentication Implementation**

#### **Current Plan Coverage** (Day 6, BR-GATEWAY-066-068)
```
Day 6: AUTHENTICATION + SECURITY (8 hours)
- TokenReviewer authentication (Bearer tokens)
- Rate limiting (100 req/min, burst 10)
- Security headers (CORS, CSP, HSTS)
- Webhook timestamp validation (5min window)
```

#### **What's Missing** ‚ö†Ô∏è
Current plan mentions "TokenReviewer authentication" but lacks:
1. ‚ùå **Detailed implementation specification** (how to validate tokens)
2. ‚ùå **ServiceAccount extraction** (who is the caller?)
3. ‚ùå **Error handling** (401 vs 403 vs 500)
4. ‚ùå **Integration with webhook handlers** (middleware wiring)
5. ‚ùå **Test coverage specification** (10 tests is vague)

#### **Required Expansion** (+3 hours)

**Add to Day 6 - Phase 1: TokenReview Authentication (3 hours)**

##### **DO-RED: Authentication Tests (1 hour)**
```go
// test/unit/gateway/middleware/auth_test.go
var _ = Describe("TokenReview Authentication", func() {
    Context("Valid ServiceAccount Token", func() {
        It("should allow request with valid token", func() {
            // Test: Valid K8s SA token ‚Üí 200 OK
        })

        It("should extract ServiceAccount identity", func() {
            // Test: Token ‚Üí "system:serviceaccount:monitoring:prometheus"
        })
    })

    Context("Invalid Token", func() {
        It("should reject expired token with 401", func() {
            // Test: Expired token ‚Üí 401 Unauthorized
        })

        It("should reject malformed token with 401", func() {
            // Test: "Bearer invalid" ‚Üí 401 Unauthorized
        })

        It("should reject missing token with 401", func() {
            // Test: No Authorization header ‚Üí 401 Unauthorized
        })
    })

    Context("TokenReview API Failures", func() {
        It("should return 503 if TokenReview API unavailable", func() {
            // Test: K8s API down ‚Üí 503 Service Unavailable
        })

        It("should return 500 if TokenReview returns error", func() {
            // Test: TokenReview error ‚Üí 500 Internal Server Error
        })
    })

    Context("ServiceAccount Extraction", func() {
        It("should extract namespace from token", func() {
            // Test: Token ‚Üí namespace "monitoring"
        })

        It("should extract ServiceAccount name from token", func() {
            // Test: Token ‚Üí SA name "prometheus"
        })
    })
})
```

##### **DO-GREEN: Minimal Authentication (1.5 hours)**
```go
// pkg/gateway/middleware/auth.go
package middleware

import (
    "context"
    "fmt"
    "net/http"
    "strings"

    authv1 "k8s.io/api/authentication/v1"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
    "k8s.io/client-go/kubernetes"
)

// TokenReviewAuth creates authentication middleware using Kubernetes TokenReview API.
// BR-GATEWAY-066: Authenticate webhook senders using K8s ServiceAccount tokens
// VULN-GATEWAY-001: Prevents unauthorized webhook access
func TokenReviewAuth(k8sClient kubernetes.Interface) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            // Extract Bearer token from Authorization header
            authHeader := r.Header.Get("Authorization")
            if authHeader == "" {
                http.Error(w, `{"error":"missing Authorization header"}`, http.StatusUnauthorized)
                return
            }

            // Parse "Bearer <token>"
            parts := strings.SplitN(authHeader, " ", 2)
            if len(parts) != 2 || parts[0] != "Bearer" {
                http.Error(w, `{"error":"invalid Authorization header format"}`, http.StatusUnauthorized)
                return
            }
            token := parts[1]

            // Call Kubernetes TokenReview API
            tr := &authv1.TokenReview{
                Spec: authv1.TokenReviewSpec{
                    Token: token,
                },
            }

            result, err := k8sClient.AuthenticationV1().TokenReviews().Create(
                r.Context(),
                tr,
                metav1.CreateOptions{},
            )

            // Handle TokenReview API errors
            if err != nil {
                http.Error(w, `{"error":"TokenReview API unavailable"}`, http.StatusServiceUnavailable)
                return
            }

            // Check if token is valid
            if !result.Status.Authenticated {
                http.Error(w, `{"error":"invalid token"}`, http.StatusUnauthorized)
                return
            }

            // Extract ServiceAccount identity
            // Format: "system:serviceaccount:<namespace>:<sa-name>"
            username := result.Status.User.Username

            // Store identity in request context for authorization
            ctx := context.WithValue(r.Context(), "serviceaccount", username)

            // Continue to next handler
            next.ServeHTTP(w, r.WithContext(ctx))
        })
    }
}
```

##### **DO-REFACTOR: Error Handling & Logging (0.5 hours)**
- Add structured logging for auth failures
- Add metrics for auth success/failure rates
- Improve error messages with request IDs

##### **Integration Tests** (included in Day 8)
```go
// test/integration/gateway/authentication_test.go
It("should reject webhook without token", func() {
    resp := SendWebhook(gatewayURL+"/webhook/prometheus", payload, WithoutAuth())
    Expect(resp.StatusCode).To(Equal(401))
})

It("should accept webhook with valid ServiceAccount token", func() {
    token := GetServiceAccountToken("monitoring", "prometheus")
    resp := SendWebhook(gatewayURL+"/webhook/prometheus", payload, WithToken(token))
    Expect(resp.StatusCode).To(Equal(201))
})
```

---

### **GAP 2: VULN-GATEWAY-002 - Missing Authorization Implementation**

#### **Current Plan Coverage**
‚ùå **NOT MENTIONED** in Day 6 or any other day

#### **Security Impact**
- **CWE-862**: Missing Authorization
- **CVSS 8.8**: High severity
- **Attack**: Authenticated user creates CRDs in any namespace (cross-namespace privilege escalation)

#### **Required Addition** (+3 hours)

**Add to Day 6 - Phase 2: SubjectAccessReview Authorization (3 hours)**

##### **DO-RED: Authorization Tests (1 hour)**
```go
// test/unit/gateway/middleware/authz_test.go
var _ = Describe("SubjectAccessReview Authorization", func() {
    Context("Authorized ServiceAccount", func() {
        It("should allow CRD creation in authorized namespace", func() {
            // Test: SA "monitoring/prometheus" ‚Üí create in "monitoring" ‚Üí 201 Created
        })
    })

    Context("Unauthorized ServiceAccount", func() {
        It("should reject CRD creation in unauthorized namespace with 403", func() {
            // Test: SA "attacker-ns/malicious" ‚Üí create in "kube-system" ‚Üí 403 Forbidden
        })

        It("should return detailed error message", func() {
            // Test: 403 response includes "not authorized for namespace kube-system"
        })
    })

    Context("SubjectAccessReview API Failures", func() {
        It("should return 503 if SAR API unavailable", func() {
            // Test: K8s API down ‚Üí 503 Service Unavailable
        })

        It("should deny by default if SAR returns error", func() {
            // Test: SAR error ‚Üí 403 Forbidden (fail-closed)
        })
    })

    Context("Cluster-Scoped Resources", func() {
        It("should check cluster-admin permissions for cluster-scoped CRDs", func() {
            // Test: Cluster-scoped CRD ‚Üí requires cluster-admin
        })
    })
})
```

##### **DO-GREEN: Minimal Authorization (1.5 hours)**
```go
// pkg/gateway/middleware/authz.go
package middleware

import (
    "context"
    "fmt"
    "net/http"

    authv1 "k8s.io/api/authorization/v1"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
    "k8s.io/client-go/kubernetes"
)

// AuthorizationChecker checks if a ServiceAccount can create RemediationRequests in a namespace.
// BR-GATEWAY-067: Authorize CRD creation based on namespace permissions
// VULN-GATEWAY-002: Prevents cross-namespace privilege escalation
type AuthorizationChecker struct {
    k8sClient kubernetes.Interface
}

func NewAuthorizationChecker(k8sClient kubernetes.Interface) *AuthorizationChecker {
    return &AuthorizationChecker{k8sClient: k8sClient}
}

// CheckNamespaceAccess verifies if the caller can create RemediationRequests in the target namespace.
// Returns error if unauthorized or if SubjectAccessReview API fails.
func (a *AuthorizationChecker) CheckNamespaceAccess(
    ctx context.Context,
    serviceAccount string,
    namespace string,
) error {
    // Create SubjectAccessReview request
    sar := &authv1.SubjectAccessReview{
        Spec: authv1.SubjectAccessReviewSpec{
            User: serviceAccount,
            ResourceAttributes: &authv1.ResourceAttributes{
                Namespace: namespace,
                Verb:      "create",
                Group:     "remediation.kubernaut.io",
                Resource:  "remediationrequests",
            },
        },
    }

    // Call Kubernetes SubjectAccessReview API
    result, err := a.k8sClient.AuthorizationV1().SubjectAccessReviews().Create(
        ctx,
        sar,
        metav1.CreateOptions{},
    )

    // Handle SAR API errors (fail-closed: deny by default)
    if err != nil {
        return fmt.Errorf("SubjectAccessReview API unavailable: %w", err)
    }

    // Check if access is allowed
    if !result.Status.Allowed {
        return fmt.Errorf(
            "ServiceAccount %s not authorized to create RemediationRequests in namespace %s: %s",
            serviceAccount,
            namespace,
            result.Status.Reason,
        )
    }

    return nil
}
```

##### **Integration into Webhook Handler** (0.5 hours)
```go
// pkg/gateway/server/handlers.go
func (s *Server) processWebhook(...) {
    // ... existing code ...

    // v1.0: Authorization check (VULN-GATEWAY-002)
    // Extract ServiceAccount from context (set by TokenReview middleware)
    serviceAccount, ok := ctx.Value("serviceaccount").(string)
    if !ok {
        s.respondError(w, http.StatusUnauthorized, "missing ServiceAccount identity", requestID, fmt.Errorf("authentication required"))
        return
    }

    // Check if ServiceAccount can create CRDs in target namespace
    if err := s.authzChecker.CheckNamespaceAccess(ctx, serviceAccount, signal.Namespace); err != nil {
        s.respondError(w, http.StatusForbidden, "not authorized for namespace", requestID, err)
        return
    }

    // ... continue with CRD creation ...
}
```

##### **DO-REFACTOR: Metrics & Caching (0.5 hours)**
- Add authorization success/failure metrics
- Add caching for SAR results (5-minute TTL)
- Add structured logging for authorization decisions

---

## ‚úÖ **COVERED VULNERABILITIES**

### **VULN-GATEWAY-003: DOS Protection** ‚úÖ
**Status**: ‚úÖ **FULLY COVERED** in Day 6

**Current Plan**:
```
Day 6: Rate limiting (100 req/min, burst 10)
BR-GATEWAY-069-070: Rate limiting
File: pkg/gateway/middleware/rate_limiter.go
Tests: 8 unit tests, 3 integration tests
```

**Assessment**: **SUFFICIENT** - Addresses CVSS 6.5 DOS vulnerability

---

## ‚ö†Ô∏è **DEFERRED VULNERABILITIES (v1.1)**

### **VULN-GATEWAY-004: Sensitive Data in Logs** ‚ö†Ô∏è
**Status**: ‚ö†Ô∏è **DEFER TO v1.1**
**Severity**: üü° MEDIUM (5.3)
**Justification**: Not blocking for v1.0 release (low likelihood, medium impact)

**Recommendation**: Add to Day 7 (Metrics + Observability) in v1.1
- Sanitize webhook payloads before logging
- Redact sensitive fields (annotations, generatorURL)
- Add log sanitization tests

---

### **VULN-GATEWAY-005: Redis Credentials Exposure** ‚ö†Ô∏è
**Status**: ‚ö†Ô∏è **DEFER TO v1.1**
**Severity**: üü° MEDIUM (5.9)
**Justification**: Redis already uses Kubernetes Secrets (deployment manifests)

**Recommendation**: Add to Day 12 (Deployment + Documentation) in v1.1
- Document Redis Secret best practices
- Add connection string sanitization in logs
- Add security hardening guide

---

## üìã **UPDATED DAY 6 SCHEDULE**

### **Before** (v2.9)
```
DAY 6: AUTHENTICATION + SECURITY (8 hours)
- Analysis (1h): TokenReviewer API, rate limiting, security headers
- Plan (1h): TDD strategy
- Do (5h): TokenReviewer auth, rate limiter, security headers, timestamp validation
- Check (1h): Verification
```

### **After** (v2.10 - Security Hardened)
```
DAY 6: AUTHENTICATION + AUTHORIZATION + SECURITY (14 hours)

Phase 1: TokenReview Authentication (3 hours) - VULN-GATEWAY-001
- DO-RED (1h): 10 authentication tests
- DO-GREEN (1.5h): TokenReview middleware implementation
- DO-REFACTOR (0.5h): Error handling, logging, metrics

Phase 2: SubjectAccessReview Authorization (3 hours) - VULN-GATEWAY-002
- DO-RED (1h): 8 authorization tests
- DO-GREEN (1.5h): SAR authorization checker + webhook integration
- DO-REFACTOR (0.5h): Caching, metrics, logging

Phase 3: Rate Limiting (2 hours) - VULN-GATEWAY-003
- DO-RED (0.5h): 8 rate limiting tests
- DO-GREEN (1h): Redis-based rate limiter (100 req/min, burst 10)
- DO-REFACTOR (0.5h): Per-source rate limiting, metrics

Phase 4: Security Headers (2 hours)
- DO-RED (0.5h): 6 security header tests
- DO-GREEN (1h): CORS, CSP, HSTS headers
- DO-REFACTOR (0.5h): Configurable policies

Phase 5: Webhook Timestamp Validation (2 hours)
- DO-RED (0.5h): 7 timestamp validation tests
- DO-GREEN (1h): 5-minute replay window validation
- DO-REFACTOR (0.5h): Configurable window, metrics

Phase 6: APDC Check (2 hours)
- Integration test execution (1h)
- Security validation (0.5h)
- Documentation update (0.5h)
```

**Total**: 14 hours (+6 hours from v2.9)

---

## üìä **Updated Business Requirements**

### **New BRs for Authorization**

| BR ID | Description | Priority | Implementation |
|-------|-------------|----------|----------------|
| **BR-GATEWAY-066** | TokenReview authentication for all webhooks | P0 | Day 6 Phase 1 |
| **BR-GATEWAY-067** | SubjectAccessReview authorization for CRD creation | P0 | Day 6 Phase 2 |
| **BR-GATEWAY-068** | ServiceAccount identity extraction from tokens | P0 | Day 6 Phase 1 |
| **BR-GATEWAY-069** | Rate limiting (100 req/min per source) | P0 | Day 6 Phase 3 |
| **BR-GATEWAY-070** | Rate limit burst capacity (10 requests) | P0 | Day 6 Phase 3 |
| **BR-GATEWAY-071** | CORS security headers | P1 | Day 6 Phase 4 |
| **BR-GATEWAY-072** | CSP security headers | P1 | Day 6 Phase 4 |
| **BR-GATEWAY-073** | HSTS security headers | P1 | Day 6 Phase 4 |
| **BR-GATEWAY-074** | Webhook timestamp validation (5min window) | P1 | Day 6 Phase 5 |
| **BR-GATEWAY-075** | Replay attack prevention | P1 | Day 6 Phase 5 |

---

## üìä **Updated Test Coverage**

### **Day 6 Test Breakdown**

| Phase | Unit Tests | Integration Tests | Total |
|-------|------------|-------------------|-------|
| Phase 1: Authentication | 10 | 4 | 14 |
| Phase 2: Authorization | 8 | 3 | 11 |
| Phase 3: Rate Limiting | 8 | 3 | 11 |
| Phase 4: Security Headers | 6 | 2 | 8 |
| Phase 5: Timestamp Validation | 7 | 2 | 9 |
| **Total** | **39** | **14** | **53** |

**Files Created**:
- `pkg/gateway/middleware/auth.go` (TokenReview)
- `pkg/gateway/middleware/authz.go` (SubjectAccessReview)
- `pkg/gateway/middleware/rate_limiter.go` (Rate limiting)
- `pkg/gateway/middleware/security.go` (Security headers)
- `pkg/gateway/middleware/timestamp.go` (Timestamp validation)
- `test/unit/gateway/middleware/auth_test.go`
- `test/unit/gateway/middleware/authz_test.go`
- `test/unit/gateway/middleware/rate_limiter_test.go`
- `test/unit/gateway/middleware/security_test.go`
- `test/unit/gateway/middleware/timestamp_test.go`
- `test/integration/gateway/authentication_test.go`
- `test/integration/gateway/authorization_test.go`

---

## ‚úÖ **Sign-Off**

**Triage Status**: ‚úÖ **COMPLETE**
**Critical Gaps Identified**: 2 (VULN-GATEWAY-001 partial, VULN-GATEWAY-002 missing)
**Action Required**: Update implementation plan to v2.10 with expanded Day 6
**Estimated Impact**: +6 hours (Day 6: 8h ‚Üí 14h)
**Confidence**: 95% - Comprehensive analysis with detailed implementation specifications

**Next Steps**:
1. Update `IMPLEMENTATION_PLAN_V2.9.md` to `v2.10` with expanded Day 6
2. Add changelog entry documenting security enhancements
3. Update BR coverage matrix with new authorization BRs
4. Proceed with Day 6 implementation (14 hours)

---

**Prepared By**: AI Assistant
**Review Status**: ‚ö†Ô∏è **PENDING USER APPROVAL**
**Recommendation**: **Approve v2.10 update** to address critical security gaps before v1.0 release



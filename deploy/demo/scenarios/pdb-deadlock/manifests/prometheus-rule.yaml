apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernaut-pdb-deadlock-rules
  namespace: demo-pdb
  labels:
    release: prometheus
spec:
  groups:
  - name: kubernaut-pdb-deadlock
    rules:
    # Detect PDB blocking disruptions (0 allowed disruptions for extended period)
    - alert: KubePodDisruptionBudgetAtLimit
      expr: |
        kube_poddisruptionbudget_status_pod_disruptions_allowed{
          namespace="demo-pdb",
          poddisruptionbudget="payment-service-pdb"
        } == 0
        and
        kube_poddisruptionbudget_status_expected_pods{
          namespace="demo-pdb",
          poddisruptionbudget="payment-service-pdb"
        }
        ==
        kube_poddisruptionbudget_status_current_healthy{
          namespace="demo-pdb",
          poddisruptionbudget="payment-service-pdb"
        }
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: >
          PDB {{ $labels.poddisruptionbudget }} in namespace {{ $labels.namespace }}
          is at disruption limit - blocking node drain/eviction
        description: >
          The PodDisruptionBudget is preventing pod evictions because minAvailable
          equals current available pods. This typically occurs during node maintenance
          (drain/cordon) when the PDB blocks eviction of the last available replica.
          The PDB should be temporarily relaxed to allow at least 1 disruption.
        runbook_url: "https://kubernaut.ai/runbooks/relax-pdb"
        kubernaut.ai/hint_action_type: "RelaxPDB"
        kubernaut.ai/hint_context: >
          PDB is blocking node drain. Temporarily relaxing minAvailable will
          unblock evictions. Investigate the PDB spec and matched pods before
          selecting a remediation workflow.

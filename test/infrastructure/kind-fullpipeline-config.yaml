# Kind Cluster Configuration for Full Pipeline E2E Tests
# Reference: DD-TEST-001 Port Allocation Strategy
#
# Full Pipeline E2E deploys ALL Kubernaut services in a single Kind cluster
# to test the complete remediation lifecycle:
#   Gateway → RO → SP → AA → HAPI → WE → Notification
#
# Port Allocation (from DD-TEST-001 v2.8):
#   Gateway API:      hostPort 30080, NodePort 30080
#   Data Storage API: hostPort 30081, NodePort 30081
#   Mock LLM:         ClusterIP only (internal access by HAPI)
#   Prometheus:        hostPort 9190,  NodePort 30190 (EM metric comparison)
#   AlertManager:      hostPort 9193,  NodePort 30193 (EM alert resolution)
#
# Kubeconfig Convention (per TESTING_GUIDELINES.md):
#   Pattern: ~/.kube/{service}-e2e-config
#   Path: ~/.kube/fullpipeline-e2e-config
#   Cluster Name: fullpipeline-e2e
#
# Memory Budget: ~6GB total
#   - Kind cluster overhead: ~1.5GB
#   - PostgreSQL: ~256MB
#   - DataStorage: ~128MB
#   - Gateway: ~128MB
#   - RO Controller: ~128MB
#   - SP Controller: ~64MB
#   - AA Controller: ~128MB
#   - WE Controller: ~64MB
#   - Notification Controller: ~64MB
#   - HAPI + Mock LLM: ~512MB
#   - Event Exporter: ~64MB
#   - Prometheus: ~128MB
#   - AlertManager: ~64MB
#   - Memory Eater Pod: ~256MB (target workload)
#   - Buffer: ~1.5GB
#
# Usage:
#   kind create cluster \
#     --name fullpipeline-e2e \
#     --config test/infrastructure/kind-fullpipeline-config.yaml \
#     --kubeconfig ~/.kube/fullpipeline-e2e-config

kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  image: kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48  # K8s 1.34.3 with CRD selectableFields support
  # Expose service ports via NodePort to host machine
  # Gateway (for event-exporter webhook delivery)
  extraPortMappings:
  - containerPort: 30080  # Gateway NodePort
    hostPort: 30080       # DD-TEST-001: Gateway API
    protocol: TCP
  # DataStorage (for workflow catalog seeding and audit queries)
  - containerPort: 30081  # DataStorage NodePort
    hostPort: 30081       # DD-TEST-001: DataStorage API
    protocol: TCP
  # Prometheus (for EM metric comparison - remote write receiver)
  - containerPort: 30190  # Prometheus NodePort
    hostPort: 9190        # DD-TEST-001 v2.8: Prometheus
    protocol: TCP
  # AlertManager (for EM alert resolution queries)
  - containerPort: 30193  # AlertManager NodePort
    hostPort: 9193        # DD-TEST-001 v2.8: AlertManager
    protocol: TCP
  # Extra mounts for coverage data collection (DD-TEST-007) and notification output
  # Note: ALL extraMounts are added programmatically in SetupFullPipelineInfrastructure
  # based on OS (macOS vs Linux) to handle path differences between environments
  # Increase API server rate limits for parallel integration testing
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        # Increase API server rate limits for parallel operations
        max-requests-inflight: "800"
        max-mutating-requests-inflight: "400"
    controllerManager:
      extraArgs:
        # Increase controller manager QPS for CRD operations
        kube-api-qps: "100"
        kube-api-burst: "200"

name: Service Maturity Validation

# Purpose: Validate all services meet V1.0 maturity requirements
# Trigger: ONLY on PRs targeting main (allows WIP on feature branches)
# Authority: docs/services/SERVICE_MATURITY_REQUIREMENTS.md

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      fail_on_violations:
        description: 'Fail on P0 violations'
        required: false
        default: 'true'
        type: boolean

jobs:
  maturity-validation:
    name: validate-maturity
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate service maturity
        run: |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║         V1.0 SERVICE MATURITY VALIDATION                     ║"
          echo "╠══════════════════════════════════════════════════════════════╣"
          echo "║ Enforced: PRs to main branch only                            ║"
          echo "║ Feature branches: No enforcement (iterative development)     ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""

          chmod +x ./scripts/validate-service-maturity.sh
          ./scripts/validate-service-maturity.sh --ci

      - name: Upload maturity report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maturity-report
          path: docs/reports/maturity-status.md
          retention-days: 30

      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('docs/reports/maturity-status.md', 'utf8');
            } catch (e) {
              report = 'Report generation failed. Run `make validate-maturity` locally for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ Service Maturity Validation Failed

Some services do not meet P0 maturity requirements. This PR cannot be merged until fixed.

### Quick Fix

\`\`\`bash
# Check violations locally
make validate-maturity

# Reference docs
cat docs/services/SERVICE_MATURITY_REQUIREMENTS.md
\`\`\`

### Details

<details>
<summary>Maturity Report</summary>

\`\`\`markdown
${report.substring(0, 3000)}
\`\`\`

</details>

---

**Need help?** See [TESTING_GUIDELINES.md](docs/development/business-requirements/TESTING_GUIDELINES.md)`
            });


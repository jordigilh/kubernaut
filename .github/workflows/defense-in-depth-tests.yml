name: Defense-in-Depth Test Suite

# Defense-in-Depth Testing Strategy (NOT Pyramid or Trophy)
# - Unit Tests: 70%+ of BRs (business logic)
# - Integration Tests: >50% of BRs (cross-component)
# - E2E Tests: 10-15% of BRs (critical journeys)
# - Total Coverage: 130-165% (overlapping validation)
#
# Authority: docs/testing/APPROVED_CI_CD_STRATEGY.md

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ========================================
  # TIER 1: UNIT TESTS (< 2 minutes)
  # Coverage: 70%+ of BRs
  # ========================================
  unit:
    name: unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run unit tests
        run: make test

      - name: Verify 70%+ coverage
        run: |
          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
            echo "Unit test coverage: ${COVERAGE}%"
            if [ $(echo "$COVERAGE < 70" | bc) -eq 1 ]; then
              echo "âŒ Unit test coverage below 70% threshold"
              exit 1
            fi
          fi

  # ========================================
  # TIER 2: INTEGRATION TESTS (~10 min)
  # Coverage: >50% of BRs
  # Per-service lanes with smart path detection
  # ========================================

  # Fast Lane: HolmesGPT API (< 2 min)
  integration-holmesgpt:
    name: integration (holmesgpt-api)
    needs: unit
    # Smart path detection: Only run if HolmesGPT code changed
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'holmesgpt-api/') ||
      contains(github.event.pull_request.changed_files, 'test/integration/holmesgpt/')
    uses: ./.github/workflows/integration-test-template.yml
    with:
      service: holmesgpt
      timeout: 5
      infrastructure: none

  # Medium Lane: Data Storage (2-5 min)
  integration-datastorage:
    name: integration (data-storage)
    needs: unit
    # Smart path detection: Only run if Data Storage code changed
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'pkg/datastorage/') ||
      contains(github.event.pull_request.changed_files, 'cmd/datastorage/') ||
      contains(github.event.pull_request.changed_files, 'test/integration/datastorage/') ||
      contains(github.event.pull_request.changed_files, 'migrations/') ||
      contains(github.event.pull_request.changed_files, 'docker/data-storage.Dockerfile')
    uses: ./.github/workflows/integration-test-template.yml
    with:
      service: datastorage
      timeout: 10
      infrastructure: podman

  # Slow Lane: Gateway Service (5-15 min)
  integration-gateway:
    name: integration (gateway-service)
    needs: unit
    # Smart path detection: Only run if Gateway code changed
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'pkg/gateway/') ||
      contains(github.event.pull_request.changed_files, 'cmd/gateway/') ||
      contains(github.event.pull_request.changed_files, 'test/integration/gateway/')
    uses: ./.github/workflows/integration-test-template.yml
    with:
      service: gateway
      timeout: 20
      infrastructure: kind

  # Medium Lane: Notification Service (~45s - envtest only, no E2E)
  integration-notification:
    name: integration (notification)
    needs: unit
    # Smart path detection: Only run if Notification code changed
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'pkg/notification/') ||
      contains(github.event.pull_request.changed_files, 'cmd/notification/') ||
      contains(github.event.pull_request.changed_files, 'test/integration/notification/')
    uses: ./.github/workflows/integration-test-template.yml
    with:
      service: notification
      timeout: 10
      infrastructure: none

  # Slow Lane: WorkflowExecution Service (5-15 min)
  # Requires: EnvTest (envtest-based integration tests)
  integration-workflowexecution:
    name: integration (workflowexecution)
    needs: unit
    # Smart path detection: Only run if WorkflowExecution code changed
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'internal/controller/workflowexecution/') ||
      contains(github.event.pull_request.changed_files, 'cmd/workflowexecution/') ||
      contains(github.event.pull_request.changed_files, 'api/workflowexecution/') ||
      contains(github.event.pull_request.changed_files, 'test/integration/workflowexecution/') ||
      contains(github.event.pull_request.changed_files, 'test/unit/workflowexecution/')
    uses: ./.github/workflows/integration-test-template.yml
    with:
      service: workflowexecution
      timeout: 15
      infrastructure: none  # EnvTest based - no Kind needed for integration

  # Slow Lane: Dynamic Toolset (5-15 min)
  # ğŸš« DEFERRED TO V2.0: Dynamic Toolset Service (DD-016)
  # Rationale: V1.x only needs Prometheus discovery (already in HolmesGPT-API)
  # Will return in V2.0 when expanding to multi-service observability
  integration-toolset:
    name: integration (dynamic-toolset) [V2.0 DEFERRED]
    needs: unit
    # ğŸš« DISABLED FOR V1.x: Integration tests excluded per DD-016
    # Re-enable in V2.0 when multi-service observability is prioritized
    if: false  # Always skip for V1.x releases
    uses: ./.github/workflows/integration-test-template.yml
    with:
      service: toolset
      timeout: 15
      infrastructure: kind

  # ========================================
  # TIER 3: E2E TESTS (~30 min)
  # Coverage: 10-15% of BRs
  # Per-service lanes with smart path detection
  # Skip for draft PRs (better developer experience)
  # ========================================

  e2e-datastorage:
    name: e2e (data-storage)
    needs: [integration-datastorage]
    # Smart path detection: Only run if Data Storage code changed
    # Skip if integration tests were skipped
    if: |
      needs.integration-datastorage.result == 'success' &&
      (github.event_name == 'push' ||
       contains(github.event.pull_request.changed_files, 'pkg/datastorage/') ||
       contains(github.event.pull_request.changed_files, 'cmd/datastorage/') ||
       contains(github.event.pull_request.changed_files, 'test/e2e/datastorage/') ||
       contains(github.event.pull_request.changed_files, 'migrations/'))
    uses: ./.github/workflows/e2e-test-template.yml
    with:
      service: datastorage
      timeout: 30
      skip_on_draft: true

  e2e-gateway:
    name: e2e (gateway-service)
    needs: [integration-gateway]
    # Smart path detection: Only run if Gateway code changed
    # Skip if integration tests were skipped
    if: |
      needs.integration-gateway.result == 'success' &&
      (github.event_name == 'push' ||
       contains(github.event.pull_request.changed_files, 'pkg/gateway/') ||
       contains(github.event.pull_request.changed_files, 'cmd/gateway/') ||
       contains(github.event.pull_request.changed_files, 'test/e2e/gateway/'))
    uses: ./.github/workflows/e2e-test-template.yml
    with:
      service: gateway
      timeout: 30
      skip_on_draft: true

  # ğŸš« DEFERRED TO V2.0: Dynamic Toolset Service (DD-016)
  # E2E tests preserved for V2.0 but excluded from V1.x CI/CD
  e2e-toolset:
    name: e2e (dynamic-toolset) [V2.0 DEFERRED]
    needs: [integration-toolset]
    # ğŸš« DISABLED FOR V1.x: E2E tests excluded per DD-016
    # Re-enable in V2.0 when multi-service observability is prioritized
    if: false  # Always skip for V1.x releases
    uses: ./.github/workflows/e2e-test-template.yml
    with:
      service: toolset
      timeout: 30
      skip_on_draft: true

  # ========================================
  # SUMMARY JOB (Defense-in-Depth)
  # ========================================
  defense-in-depth-summary:
    name: defense-in-depth-summary
    runs-on: ubuntu-latest
    needs: [unit, integration-holmesgpt, integration-datastorage, integration-gateway, integration-notification, integration-toolset, e2e-datastorage, e2e-gateway, e2e-toolset]
    if: always()
    steps:
      - name: Defense-in-Depth Test Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Defense-in-Depth Test Suite Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Tier 1 - Unit Tests (70%+ BRs):"
          echo "  Status: ${{ needs.unit.result }}"
          echo ""
          echo "Tier 2 - Integration Tests (>50% BRs):"
          echo "  HolmesGPT API:     ${{ needs.integration-holmesgpt.result }}"
          echo "  Data Storage:      ${{ needs.integration-datastorage.result }}"
          echo "  Gateway Service:   ${{ needs.integration-gateway.result }}"
          echo "  Notification:      ${{ needs.integration-notification.result }}"
          echo "  Dynamic Toolset:   â­ï¸  SKIPPED (V2.0 DEFERRED - DD-016)"
          echo ""
          echo "Tier 3 - E2E Tests (10-15% BRs):"
          echo "  Data Storage:      ${{ needs.e2e-datastorage.result }}"
          echo "  Gateway Service:   ${{ needs.e2e-gateway.result }}"
          echo "  Dynamic Toolset:   â­ï¸  SKIPPED (V2.0 DEFERRED - DD-016)"
          echo ""
          echo "Smart Path Detection: âœ… Only affected services tested"
          echo "Draft PR Skip: âœ… E2E skipped for draft PRs"
          echo "Retry Logic: âœ… E2E tests retry once on failure"
          echo ""
          echo "Total Coverage: 130-165% (overlapping defense-in-depth)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Check if any required jobs failed
          FAILED=0

          # Unit tests are always required
          if [ "${{ needs.unit.result }}" != "success" ]; then
            echo "âŒ Unit tests failed"
            FAILED=1
          fi

          # Integration tests: Check only if they ran (exclude toolset - V2.0 deferred)
          for service in holmesgpt datastorage gateway notification; do
            result=$(echo "${{ toJSON(needs) }}" | jq -r ".\"integration-${service}\".result")
            if [ "$result" == "failure" ]; then
              echo "âŒ Integration tests failed for ${service}"
              FAILED=1
            fi
          done

          # E2E tests: Check only if they ran (exclude toolset - V2.0 deferred)
          for service in datastorage gateway; do
            result=$(echo "${{ toJSON(needs) }}" | jq -r ".\"e2e-${service}\".result")
            if [ "$result" == "failure" ]; then
              echo "âŒ E2E tests failed for ${service}"
              FAILED=1
            fi
          done

          # Note: Dynamic Toolset (integration-toolset, e2e-toolset) excluded per DD-016 (V2.0 deferral)

          if [ $FAILED -eq 0 ]; then
            echo ""
            echo "âœ… All defense-in-depth tests passed!"
            exit 0
          else
            echo ""
            echo "âŒ Some tests failed - check logs above"
            exit 1
          fi


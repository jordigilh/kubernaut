openapi: 3.0.3
info:
  title: Data Storage Service API
  version: 3.0.0
  description: |
    REST API for Kubernetes remediation workflow catalog and action history.

    This API provides:
    - **V3.0.0 (DD-STORAGE-011)**: Workflow Catalog CRUD API
      - Create workflows with ADR-043 schema validation
      - Get workflow by ID and version
      - List workflow versions
      - Disable workflows (soft delete per DD-WORKFLOW-012)
      - Semantic search with hybrid weighted scoring

    - **V2.0.0 (ADR-033)**: Multi-dimensional success tracking
      - Incident-type success rate aggregation
      - Workflow success rate aggregation
      - AI execution mode distribution tracking

    - **V1.0.0**: Read API for incidents

    **Business Requirements**:
    - BR-STORAGE-012: Workflow catalog persistence
    - BR-STORAGE-013: Semantic search with hybrid weighted scoring
    - BR-WORKFLOW-001: Workflow version management
    - DD-WORKFLOW-012: Workflow immutability (no updates, new versions only)
    - ADR-043: Workflow schema definition standard
  contact:
    name: Kubernaut Team
    url: https://github.com/jordigilh/kubernaut
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://data-storage.kubernaut-system.svc.cluster.local:8080
    description: Kubernetes cluster (in-cluster service)
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Workflows
    description: Workflow catalog CRUD operations (DD-STORAGE-011)
  - name: Workflow Search
    description: Semantic search for remediation workflows (BR-STORAGE-013)
  - name: Incidents
    description: Query remediation action incidents
  - name: Success Rate Analytics
    description: ADR-033 multi-dimensional success tracking and aggregation
  - name: Health
    description: Health check endpoints

paths:
  # ========================================
  # V3.0.0: WORKFLOW CATALOG CRUD (DD-STORAGE-011)
  # ========================================

  /api/v1/workflows:
    post:
      summary: Create a new workflow
      description: |
        Create a new workflow in the catalog with automatic embedding generation.

        **Business Requirements**:
        - BR-STORAGE-012: Workflow catalog persistence
        - BR-WORKFLOW-001: Workflow version management

        **Design Decisions**:
        - DD-STORAGE-011: Synchronous embedding generation
        - DD-WORKFLOW-012: Workflow immutability (unique workflow_id + version)
        - ADR-043: Content must be valid workflow-schema.yaml
      operationId: createWorkflow
      tags:
        - Workflows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowRequest'
      responses:
        '201':
          description: Workflow created successfully
          headers:
            Location:
              schema:
                type: string
              description: URL to the created workflow
            X-Request-ID:
              schema:
                type: string
              description: Request ID for tracing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '400':
          description: Bad request - Invalid or missing required fields
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
        '409':
          description: Conflict - Workflow already exists with this workflow_id + version
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/workflows/{workflow_id}:
    get:
      summary: Get workflow by UUID
      description: |
        Retrieve a specific workflow by its UUID.

        **DD-WORKFLOW-002 v3.0**: workflow_id is UUID (single identifier)

        **Business Requirements**:
        - BR-WORKFLOW-001: Workflow version management

        **Design Decisions**:
        - DD-WORKFLOW-012 v2.0: Workflows are immutable, UUID is primary key
      operationId: getWorkflow
      tags:
        - Workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: DD-WORKFLOW-002 v3.0 - UUID primary key
      responses:
        '200':
          description: Workflow found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '404':
          description: Workflow not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/workflows/by-name/{workflow_name}/versions:
    get:
      summary: List all versions of a workflow by name
      description: |
        Retrieve all versions of a specific workflow by its human-readable name,
        ordered by creation date (newest first).

        **DD-WORKFLOW-002 v3.0**: Use workflow_name (human-readable) to list versions.
        Each version has its own UUID (workflow_id).

        **Business Requirements**:
        - BR-WORKFLOW-001: Workflow version management
      operationId: listWorkflowVersions
      tags:
        - Workflows
      parameters:
        - name: workflow_name
          in: path
          required: true
          schema:
            type: string
          description: DD-WORKFLOW-002 v3.0 - Human-readable workflow identifier
      responses:
        '200':
          description: List of workflow versions (empty array if none found)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkflowVersionSummary'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/workflows/{workflow_id}/disable:
    patch:
      summary: Disable a workflow
      description: |
        Disable a specific workflow (soft delete).

        **DD-WORKFLOW-002 v3.0**: workflow_id is UUID (single identifier)

        **Design Decisions**:
        - DD-WORKFLOW-012 v2.0: Workflows are never hard deleted, only disabled
        - Disabled workflows are excluded from search results
      operationId: disableWorkflow
      tags:
        - Workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: DD-WORKFLOW-002 v3.0 - UUID primary key
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisableWorkflowRequest'
      responses:
        '200':
          description: Workflow disabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediationWorkflow'
        '400':
          description: Bad request - Missing reason
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
        '404':
          description: Workflow not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/workflows/search:
    post:
      summary: Search workflows using semantic search
      description: |
        Search for remediation workflows using semantic search with hybrid weighted scoring.

        **Business Requirements**:
        - BR-STORAGE-013: Semantic search with hybrid weighted scoring

        **Design Decisions**:
        - DD-WORKFLOW-004: V1.0 uses confidence = base_similarity (no boost/penalty)
      operationId: searchWorkflows
      tags:
        - Workflow Search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowSearchRequest'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowSearchResponse'
        '400':
          description: Bad request - Invalid search parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  # ========================================
  # ADR-033: SUCCESS RATE ANALYTICS (V2.0.0)
  # ========================================

  /api/v1/success-rate/incident-type:
    get:
      summary: Get success rate by incident type
      description: |
        **ADR-033 PRIMARY DIMENSION**: Calculate remediation success rate by incident type.

        This endpoint provides success rate analytics for specific incident types (e.g., "pod-oom-killer", "disk-pressure"),
        enabling AI to learn which remediation approaches work best for each problem category.

        **Key Features**:
        - Success rate percentage (0-100%)
        - Confidence levels (high/medium/low/insufficient_data)
        - AI execution mode distribution (catalog/chained/manual)
        - Workflow breakdown showing which workflows were tried
        - Time range filtering for recent vs historical data

        **Use Cases**:
        - AI workflow selection optimization
        - Incident-specific remediation effectiveness
        - Historical trend analysis
        - Confidence-based decision making

        **BR-STORAGE-031-01**: Incident-Type Success Rate API
      operationId: getSuccessRateByIncidentType
      tags:
        - Success Rate Analytics
      parameters:
        - name: incident_type
          in: query
          required: true
          schema:
            type: string
          description: |
            The incident type to query (e.g., "pod-oom-killer", "disk-pressure", "network-timeout").
            This is the PRIMARY dimension for success tracking per ADR-033.
          example: "pod-oom-killer"

        - name: time_range
          in: query
          required: false
          schema:
            type: string
            pattern: '^[0-9]+(h|d)$'
            default: "7d"
          description: |
            Time window for analysis. Valid formats: "1h", "24h", "7d", "30d".
            Default: "7d" (last 7 days).
          example: "7d"

        - name: min_samples
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 5
          description: |
            Minimum sample size for confidence calculation.
            - high confidence: >=100 samples
            - medium confidence: 20-99 samples
            - low confidence: 5-19 samples
            - insufficient_data: <5 samples (or below this threshold)
          example: 5

      responses:
        '200':
          description: Successful response with incident-type success rate data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentTypeSuccessRateResponse'
              examples:
                high_confidence:
                  summary: High confidence example (100+ samples)
                  value:
                    incident_type: "pod-oom-killer"
                    time_range: "7d"
                    total_executions: 150
                    successful_executions: 135
                    failed_executions: 15
                    success_rate: 90.0
                    confidence: "high"
                    min_samples_met: true
                    ai_execution_mode:
                      catalog_selected: 135
                      chained: 12
                      manual_escalation: 3
                    workflow_breakdown:
                      - workflow_id: "pod-oom-recovery"
                        workflow_version: "v1.2"
                        executions: 120
                        success_rate: 92.5
                      - workflow_id: "memory-limit-increase"
                        workflow_version: "v2.0"
                        executions: 30
                        success_rate: 80.0

                insufficient_data:
                  summary: Insufficient data example (<5 samples)
                  value:
                    incident_type: "rare-database-deadlock"
                    time_range: "7d"
                    total_executions: 3
                    successful_executions: 2
                    failed_executions: 1
                    success_rate: 66.67
                    confidence: "insufficient_data"
                    min_samples_met: false
                    ai_execution_mode:
                      catalog_selected: 2
                      chained: 0
                      manual_escalation: 1
                    workflow_breakdown: []

        '400':
          description: Bad request - Missing or invalid parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                missing_incident_type:
                  summary: Missing required incident_type parameter
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "incident_type query parameter is required"
                    instance: "/api/v1/success-rate/incident-type"

                invalid_time_range:
                  summary: Invalid time_range format
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "invalid time_range format: 5w (expected format: 1h, 24h, 7d, 30d)"
                    instance: "/api/v1/success-rate/incident-type?incident_type=pod-oom-killer&time_range=5w"

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                database_error:
                  summary: Database query failure
                  value:
                    type: "https://api.kubernaut.io/problems/internal-error"
                    title: "Internal Server Error"
                    status: 500
                    detail: "Failed to retrieve success rate data"
                    instance: "/api/v1/success-rate/incident-type?incident_type=pod-oom-killer"

  /api/v1/success-rate/workflow:
    get:
      summary: Get success rate by workflow
      description: |
        **ADR-033 SECONDARY DIMENSION**: Calculate remediation success rate by workflow.

        This endpoint provides success rate analytics for specific workflows (e.g., "pod-oom-recovery", "disk-cleanup"),
        enabling AI to learn which workflows are most effective overall and for which incident types.

        **Key Features**:
        - Success rate percentage (0-100%)
        - Confidence levels (high/medium/low/insufficient_data)
        - AI execution mode distribution (catalog/chained/manual)
        - Incident-type breakdown showing which problems this workflow solves
        - Version filtering for A/B testing and rollout validation

        **Use Cases**:
        - Workflow effectiveness validation
        - Version comparison (v1.0 vs v2.0)
        - Incident-type suitability analysis
        - Workflow catalog optimization

        **BR-STORAGE-031-02**: Workflow Success Rate API
      operationId: getSuccessRateByWorkflow
      tags:
        - Success Rate Analytics
      parameters:
        - name: workflow_id
          in: query
          required: true
          schema:
            type: string
          description: |
            The workflow identifier to query (e.g., "pod-oom-recovery", "disk-cleanup").
            This is the SECONDARY dimension for success tracking per ADR-033.
          example: "pod-oom-recovery"

        - name: workflow_version
          in: query
          required: false
          schema:
            type: string
            pattern: '^v[0-9]+\.[0-9]+(\.[0-9]+)?$'
          description: |
            Optional: Filter by specific workflow version (e.g., "v1.2", "v2.0").
            Omit to aggregate across all versions.
          example: "v1.2"

        - name: time_range
          in: query
          required: false
          schema:
            type: string
            pattern: '^[0-9]+(h|d)$'
            default: "7d"
          description: |
            Time window for analysis. Valid formats: "1h", "24h", "7d", "30d".
            Default: "7d" (last 7 days).
          example: "7d"

        - name: min_samples
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 5
          description: |
            Minimum sample size for confidence calculation.
            Same thresholds as incident-type endpoint.
          example: 5

      responses:
        '200':
          description: Successful response with workflow success rate data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowSuccessRateResponse'
              examples:
                all_versions:
                  summary: Aggregated across all versions
                  value:
                    workflow_id: "pod-oom-recovery"
                    workflow_version: null
                    time_range: "7d"
                    total_executions: 200
                    successful_executions: 185
                    failed_executions: 15
                    success_rate: 92.5
                    confidence: "high"
                    min_samples_met: true
                    ai_execution_mode:
                      catalog_selected: 180
                      chained: 15
                      manual_escalation: 5
                    incident_type_breakdown:
                      - incident_type: "pod-oom-killer"
                        executions: 150
                        success_rate: 94.0
                      - incident_type: "container-memory-pressure"
                        executions: 50
                        success_rate: 88.0

                specific_version:
                  summary: Filtered by version v2.0
                  value:
                    workflow_id: "pod-oom-recovery"
                    workflow_version: "v2.0"
                    time_range: "7d"
                    total_executions: 80
                    successful_executions: 76
                    failed_executions: 4
                    success_rate: 95.0
                    confidence: "high"
                    min_samples_met: true
                    ai_execution_mode:
                      catalog_selected: 75
                      chained: 4
                      manual_escalation: 1
                    incident_type_breakdown:
                      - incident_type: "pod-oom-killer"
                        executions: 60
                        success_rate: 96.67
                      - incident_type: "container-memory-pressure"
                        executions: 20
                        success_rate: 90.0

        '400':
          description: Bad request - Missing or invalid parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                missing_workflow_id:
                  summary: Missing required workflow_id parameter
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "workflow_id query parameter is required"
                    instance: "/api/v1/success-rate/workflow"

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/success-rate/multi-dimensional:
    get:
      summary: Get success rate across multiple dimensions
      description: |
        **ADR-033 MULTI-DIMENSIONAL AGGREGATION**: Calculate success rate filtered by any combination of dimensions.

        **BR-STORAGE-031-05**: Multi-Dimensional Success Rate API
      operationId: getSuccessRateMultiDimensional
      tags:
        - Success Rate Analytics
      parameters:
        - name: incident_type
          in: query
          required: false
          schema:
            type: string
          example: "pod-oom-killer"
        - name: workflow_id
          in: query
          required: false
          schema:
            type: string
          example: "pod-oom-recovery"
        - name: workflow_version
          in: query
          required: false
          schema:
            type: string
          example: "v1.2"
        - name: action_type
          in: query
          required: false
          schema:
            type: string
          example: "increase_memory"
        - name: time_range
          in: query
          required: false
          schema:
            type: string
            default: "7d"
          example: "7d"
        - name: min_samples
          in: query
          required: false
          schema:
            type: integer
            default: 5
          example: 5
      responses:
        '200':
          description: Multi-dimensional success rate data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultiDimensionalSuccessRateResponse'
              examples:
                all_three_dimensions:
                  summary: Success rate for specific incident + workflow + action
                  value:
                    dimensions:
                      incident_type: "pod-oom-killer"
                      workflow_id: "pod-oom-recovery"
                      workflow_version: "v1.2"
                      action_type: "increase_memory"
                    time_range: "7d"
                    total_executions: 50
                    successful_executions: 45
                    failed_executions: 5
                    success_rate: 90.0
                    confidence: "medium"
                    min_samples_met: true

                partial_dimensions:
                  summary: Success rate by incident type only
                  value:
                    dimensions:
                      incident_type: "pod-oom-killer"
                      workflow_id: ""
                      workflow_version: ""
                      action_type: ""
                    time_range: "30d"
                    total_executions: 150
                    successful_executions: 135
                    failed_executions: 15
                    success_rate: 90.0
                    confidence: "high"
                    min_samples_met: true

                insufficient_data:
                  summary: Insufficient sample size
                  value:
                    dimensions:
                      incident_type: "rare-error"
                      workflow_id: "experimental-fix"
                      workflow_version: "v0.1"
                      action_type: ""
                    time_range: "7d"
                    total_executions: 2
                    successful_executions: 2
                    failed_executions: 0
                    success_rate: 100.0
                    confidence: "insufficient_data"
                    min_samples_met: false

        '400':
          description: Invalid parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                no_dimensions:
                  summary: No dimension filters specified
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Invalid Query Parameter"
                    status: 400
                    detail: "at least one dimension filter (incident_type, workflow_id, or action_type) must be specified"
                    instance: "/api/v1/success-rate/multi-dimensional?time_range=7d"

                workflow_version_without_id:
                  summary: workflow_version requires workflow_id
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Invalid Query Parameter"
                    status: 400
                    detail: "workflow_version requires workflow_id to be specified"
                    instance: "/api/v1/success-rate/multi-dimensional?incident_type=pod-oom-killer&workflow_version=v1.2"

                invalid_time_range:
                  summary: Invalid time_range format
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Invalid Query Parameter"
                    status: 400
                    detail: "invalid time_range: invalid (expected format: 1h, 24h, 7d, 30d)"
                    instance: "/api/v1/success-rate/multi-dimensional?incident_type=pod-oom-killer&time_range=invalid"

                invalid_min_samples:
                  summary: Invalid min_samples value
                  value:
                    type: "https://api.kubernaut.io/problems/validation-error"
                    title: "Invalid Query Parameter"
                    status: 400
                    detail: "min_samples must be a positive integer"
                    instance: "/api/v1/success-rate/multi-dimensional?incident_type=pod-oom-killer&min_samples=-5"

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'
              examples:
                database_error:
                  summary: Database query failure
                  value:
                    type: "https://api.kubernaut.io/problems/internal-error"
                    title: "Internal Server Error"
                    status: 500
                    detail: "Failed to retrieve multi-dimensional success rate data"
                    instance: "/api/v1/success-rate/multi-dimensional?incident_type=pod-oom-killer"

  # ========================================
  # EXISTING V1 ENDPOINTS (UNCHANGED)
  # ========================================

  /api/v1/incidents:
    get:
      summary: List incidents with filters
      description: |
        Retrieve a paginated list of incidents filtered by alert name, severity, action type, etc.

        Supports:
        - Filter by alert_name, severity, action_type
        - Pagination with limit/offset
        - Sorting by action_timestamp (DESC)
      operationId: listIncidents
      tags:
        - Incidents
      parameters:
        - name: alert_name
          in: query
          required: false
          schema:
            type: string
          description: Filter by alert name pattern (exact match)
          example: "test-integration-prod-cpu-high"

        - name: severity
          in: query
          required: false
          schema:
            type: string
            enum: [low, medium, high, critical]
          description: Filter by alert severity
          example: "critical"

        - name: action_type
          in: query
          required: false
          schema:
            type: string
          description: Filter by action type (e.g., scale, restart, check)
          example: "scale"

        - name: namespace
          in: query
          required: false
          schema:
            type: string
          description: Filter by Kubernetes namespace
          example: "production"

        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Maximum number of results to return
          example: 50

        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip (for pagination)
          example: 100

      responses:
        '200':
          description: Successful response with incident list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentListResponse'

        '400':
          description: Bad request - Invalid filter parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /api/v1/incidents/{id}:
    get:
      summary: Get incident by ID
      description: Retrieve a single incident by its unique identifier
      operationId: getIncidentByID
      tags:
        - Incidents
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Unique incident ID
          example: 12345

      responses:
        '200':
          description: Successful response with incident details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

        '404':
          description: Incident not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

        '500':
          description: Internal server error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RFC7807Error'

  /health:
    get:
      summary: Health check endpoint
      description: Check if the service is healthy (application + database)
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            text/plain:
              schema:
                type: string
                example: "OK"
        '503':
          description: Service is unhealthy
          content:
            text/plain:
              schema:
                type: string
                example: "Database connection failed"

  /health/ready:
    get:
      summary: Readiness probe
      description: Check if the service is ready to accept traffic (Kubernetes readiness probe)
      operationId: readinessCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is ready
          content:
            text/plain:
              schema:
                type: string
                example: "OK"
        '503':
          description: Service is not ready (shutting down or starting up)
          content:
            text/plain:
              schema:
                type: string
                example: "Service is shutting down"

  /health/live:
    get:
      summary: Liveness probe
      description: Check if the service is alive (Kubernetes liveness probe)
      operationId: livenessCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is alive
          content:
            text/plain:
              schema:
                type: string
                example: "OK"

components:
  schemas:
    # ========================================
    # V3.0.0: WORKFLOW CRUD SCHEMAS (DD-STORAGE-011)
    # ========================================

    CreateWorkflowRequest:
      type: object
      description: |
        DD-WORKFLOW-002 v3.0: workflow_id is UUID (auto-generated by server).
        Client provides workflow_name (human-readable) + version as unique identifier.
      required:
        - workflow_name
        - version
        - name
        - description
        - content
        - labels
        - container_image
      properties:
        workflow_name:
          type: string
          description: |
            DD-WORKFLOW-002 v3.0: Human-readable workflow identifier.
            Combined with version for uniqueness (UNIQUE constraint).
            Example: "pod-oom-recovery", "crashloop-fix-configuration"
        version:
          type: string
          description: Semantic version (e.g., "1.0.0")
        name:
          type: string
          description: Human-readable display title
        description:
          type: string
          description: Description (used for embedding generation)
        content:
          type: string
          description: Full workflow-schema.yaml content per ADR-043
        labels:
          type: object
          additionalProperties:
            type: string
          description: Workflow labels (must include signal_type and severity)
        container_image:
          type: string
          description: |
            DD-WORKFLOW-002 v2.4: OCI image pullspec with digest (MANDATORY for V1.0).
            Format: <registry>/<repo>:<tag>@sha256:<digest> or <registry>/<repo>@sha256:<digest>
            Example: "quay.io/kubernaut/workflow-oomkill:v1.0.0@sha256:abc123..."
            The digest portion is extracted and stored separately in container_digest.
        owner:
          type: string
          description: Team or user who owns this workflow
        maintainer:
          type: string
          description: Contact email for maintenance

    DisableWorkflowRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          description: Reason for disabling the workflow (required for audit trail)
        updated_by:
          type: string
          description: User or service that disabled the workflow

    RemediationWorkflow:
      type: object
      description: |
        DD-WORKFLOW-002 v3.0: workflow_id is UUID (auto-generated primary key).
        workflow_name + version provides human-readable uniqueness.
      required:
        - workflow_id
        - workflow_name
        - version
        - name
        - description
        - content
        - labels
        - status
        - container_image
        - container_digest
        - created_at
      properties:
        workflow_id:
          type: string
          format: uuid
          description: DD-WORKFLOW-002 v3.0 - UUID primary key (auto-generated)
        workflow_name:
          type: string
          description: DD-WORKFLOW-002 v3.0 - Human-readable identifier
        version:
          type: string
        name:
          type: string
          description: Human-readable display title
        description:
          type: string
        content:
          type: string
          description: Full workflow-schema.yaml content
        content_hash:
          type: string
          description: SHA-256 hash of content for integrity verification
        labels:
          type: object
          additionalProperties:
            type: string
        container_image:
          type: string
          description: |
            DD-WORKFLOW-002 v2.4: OCI image reference (base + optional tag).
            Example: "quay.io/kubernaut/workflow-oomkill:v1.0.0"
            Full pullspec = container_image + "@" + container_digest
        container_digest:
          type: string
          description: |
            DD-WORKFLOW-002 v2.4: SHA256 digest for audit trail and immutability.
            Example: "sha256:abc123def456..."
        owner:
          type: string
        maintainer:
          type: string
        status:
          type: string
          enum: [active, disabled]
        is_latest_version:
          type: boolean
        parameters:
          type: object
          description: Extracted parameters from workflow-schema.yaml (ADR-043)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        disabled_at:
          type: string
          format: date-time
        disabled_by:
          type: string
        disabled_reason:
          type: string

    WorkflowVersionSummary:
      type: object
      required:
        - version
        - status
        - is_latest_version
        - created_at
      properties:
        version:
          type: string
        status:
          type: string
          enum: [active, disabled]
        is_latest_version:
          type: boolean
        created_at:
          type: string
          format: date-time

    WorkflowSearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Natural language search query
        remediation_id:
          type: string
          description: Remediation ID for audit trail correlation
        filters:
          $ref: '#/components/schemas/WorkflowSearchFilters'
        top_k:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
          description: Maximum number of results to return
        min_similarity:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          default: 0.5
          description: Minimum similarity threshold

    WorkflowSearchFilters:
      type: object
      properties:
        signal_type:
          type: string
          description: Filter by signal type (mandatory label)
        severity:
          type: string
          description: Filter by severity (mandatory label)
        environment:
          type: string
          description: Filter by environment

    WorkflowSearchResponse:
      type: object
      required:
        - workflows
        - total_results
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowSearchResult'
          description: List of matching workflows, ranked by confidence
        total_results:
          type: integer
          description: Total number of matching workflows
        query:
          type: string
          description: The original search query
        filters:
          $ref: '#/components/schemas/WorkflowSearchFilters'
          description: Applied filters (if any)

    # DD-WORKFLOW-002 v2.4: FLAT response structure for LLM consumption
    # All fields at same level - no nested "workflow" object
    WorkflowSearchResult:
      type: object
      description: |
        DD-WORKFLOW-002 v3.0: FLAT response structure for LLM consumption.
        - workflow_id is UUID (auto-generated primary key)
        - Removed: version (not needed for LLM)
        - Removed: estimated_duration (circumstantial)
        - Changed: signal_types (array) â†’ signal_type (string)
      required:
        - workflow_id
        - title
        - description
        - signal_type
        - container_image
        - container_digest
        - confidence
      properties:
        workflow_id:
          type: string
          format: uuid
          description: DD-WORKFLOW-002 v3.0 - UUID primary key (single identifier)
          example: "550e8400-e29b-41d4-a716-446655440000"
        title:
          type: string
          description: |
            Human-readable name of the workflow.
            DD-WORKFLOW-002 v3.0: Uses "title" (maps to internal "name").
          example: "OOMKilled Remediation - Conservative Memory Increase"
        description:
          type: string
          description: Detailed description of the workflow
          example: "OOMKilled critical: Increases memory limits conservatively without restart"
        signal_type:
          type: string
          description: |
            DD-WORKFLOW-002 v3.0: Single signal type this workflow handles.
            Extracted from labels["signal-type"].
          example: "OOMKilled"
        container_image:
          type: string
          description: |
            DD-WORKFLOW-002 v2.4: OCI image reference (base + optional tag).
            Example: "quay.io/kubernaut/workflow-oomkill:v1.0.0"
          example: "quay.io/kubernaut/workflow-oomkill:v1.0.0"
        container_digest:
          type: string
          description: |
            DD-WORKFLOW-002 v2.4: SHA256 digest for audit trail.
            Example: "sha256:abc123def456..."
          example: "sha256:abc123def456..."
        confidence:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          description: |
            DD-WORKFLOW-004 v2.0: Semantic similarity score (0.0-1.0).
            V1.0: confidence = base_similarity (cosine similarity from pgvector)
            Higher is better (1.0 = identical)
          example: 0.95

    # ========================================
    # ADR-033: SUCCESS RATE SCHEMAS (V2.0.0)
    # ========================================

    IncidentTypeSuccessRateResponse:
      type: object
      required:
        - incident_type
        - time_range
        - total_executions
        - successful_executions
        - failed_executions
        - success_rate
        - confidence
        - min_samples_met
      properties:
        incident_type:
          type: string
          description: The incident type being analyzed (e.g., "pod-oom-killer")
          example: "pod-oom-killer"

        time_range:
          type: string
          description: Time window for this analysis (e.g., "7d")
          example: "7d"

        total_executions:
          type: integer
          minimum: 0
          description: Total number of remediation attempts for this incident type
          example: 150

        successful_executions:
          type: integer
          minimum: 0
          description: Number of successful remediation attempts
          example: 135

        failed_executions:
          type: integer
          minimum: 0
          description: Number of failed remediation attempts
          example: 15

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate percentage (0-100%)
          example: 90.0

        confidence:
          type: string
          enum: [high, medium, low, insufficient_data]
          description: |
            Confidence level based on sample size:
            - high: >=100 samples
            - medium: 20-99 samples
            - low: 5-19 samples
            - insufficient_data: <5 samples (or below min_samples threshold)
          example: "high"

        min_samples_met:
          type: boolean
          description: Whether the minimum sample size threshold was met
          example: true

        ai_execution_mode:
          $ref: '#/components/schemas/AIExecutionModeStats'
          description: Distribution of AI execution modes (ADR-033 Hybrid Model)

        workflow_breakdown:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowBreakdownItem'
          description: Breakdown by workflow showing which workflows were tried for this incident type

    WorkflowSuccessRateResponse:
      type: object
      required:
        - workflow_id
        - time_range
        - total_executions
        - successful_executions
        - failed_executions
        - success_rate
        - confidence
        - min_samples_met
      properties:
        workflow_id:
          type: string
          description: The workflow identifier being analyzed (e.g., "pod-oom-recovery")
          example: "pod-oom-recovery"

        workflow_version:
          type: string
          nullable: true
          description: Specific workflow version (null if aggregated across all versions)
          example: "v1.2"

        time_range:
          type: string
          description: Time window for this analysis (e.g., "7d")
          example: "7d"

        total_executions:
          type: integer
          minimum: 0
          description: Total number of times this workflow was executed
          example: 200

        successful_executions:
          type: integer
          minimum: 0
          description: Number of successful workflow executions
          example: 185

        failed_executions:
          type: integer
          minimum: 0
          description: Number of failed workflow executions
          example: 15

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate percentage (0-100%)
          example: 92.5

        confidence:
          type: string
          enum: [high, medium, low, insufficient_data]
          description: Confidence level based on sample size
          example: "high"

        min_samples_met:
          type: boolean
          description: Whether the minimum sample size threshold was met
          example: true

        ai_execution_mode:
          $ref: '#/components/schemas/AIExecutionModeStats'
          description: Distribution of AI execution modes for this workflow

        incident_type_breakdown:
          type: array
          items:
            $ref: '#/components/schemas/IncidentTypeBreakdownItem'
          description: Breakdown by incident type showing which problems this workflow solves

    AIExecutionModeStats:
      type: object
      required:
        - catalog_selected
        - chained
        - manual_escalation
      properties:
        catalog_selected:
          type: integer
          minimum: 0
          description: |
            Number of times AI selected a single workflow from the catalog (90-95% expected per ADR-033 Hybrid Model)
          example: 135

        chained:
          type: integer
          minimum: 0
          description: |
            Number of times AI chained multiple workflows together (4-9% expected per ADR-033 Hybrid Model)
          example: 12

        manual_escalation:
          type: integer
          minimum: 0
          description: |
            Number of times AI escalated to human operator (<1% expected per ADR-033 Hybrid Model)
          example: 3

    WorkflowBreakdownItem:
      type: object
      required:
        - workflow_id
        - workflow_version
        - executions
        - success_rate
      properties:
        workflow_id:
          type: string
          description: Workflow identifier
          example: "pod-oom-recovery"

        workflow_version:
          type: string
          description: Workflow version
          example: "v1.2"

        executions:
          type: integer
          minimum: 0
          description: Number of times this workflow was used
          example: 120

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate for this specific workflow
          example: 92.5

    MultiDimensionalSuccessRateResponse:
      type: object
      required:
        - dimensions
        - time_range
        - total_executions
        - successful_executions
        - failed_executions
        - success_rate
        - confidence
        - min_samples_met
      properties:
        dimensions:
          $ref: '#/components/schemas/QueryDimensions'

        time_range:
          type: string
          description: Time window for this analysis
          example: "7d"

        total_executions:
          type: integer
          minimum: 0
          description: Total number of action executions matching the dimension filters
          example: 50

        successful_executions:
          type: integer
          minimum: 0
          description: Number of successful executions
          example: 45

        failed_executions:
          type: integer
          minimum: 0
          description: Number of failed executions
          example: 5

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate percentage (successful / total * 100)
          example: 90.0

        confidence:
          type: string
          enum: [high, medium, low, insufficient_data]
          description: Statistical confidence level based on sample size
          example: "medium"

        min_samples_met:
          type: boolean
          description: Whether minimum sample size threshold was met
          example: true

    QueryDimensions:
      type: object
      properties:
        incident_type:
          type: string
          description: Incident type filter (empty if not specified)
          example: "pod-oom-killer"

        workflow_id:
          type: string
          description: Workflow ID filter (empty if not specified)
          example: "pod-oom-recovery"

        workflow_version:
          type: string
          description: Workflow version filter (empty if not specified)
          example: "v1.2"

        action_type:
          type: string
          description: Action type filter (empty if not specified)
          example: "increase_memory"

    IncidentTypeBreakdownItem:
      type: object
      required:
        - incident_type
        - executions
        - success_rate
      properties:
        incident_type:
          type: string
          description: Incident type identifier
          example: "pod-oom-killer"

        executions:
          type: integer
          minimum: 0
          description: Number of times this workflow was used for this incident type
          example: 150

        success_rate:
          type: number
          format: double
          minimum: 0.0
          maximum: 100.0
          description: Success rate for this specific incident type
          example: 94.0

    # ========================================
    # EXISTING V1 SCHEMAS (UNCHANGED)
    # ========================================

    IncidentListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Incident'
          description: Array of incidents matching the filter criteria
        pagination:
          $ref: '#/components/schemas/Pagination'
          description: Pagination metadata

    Incident:
      type: object
      required:
        - id
        - alert_name
        - alert_severity
        - action_type
        - action_timestamp
        - model_used
        - model_confidence
        - execution_status
      properties:
        id:
          type: integer
          format: int64
          description: Unique incident identifier (from resource_action_traces table)
          example: 12345

        alert_name:
          type: string
          description: Name of the Prometheus alert or Kubernetes event
          example: "prod-cpu-high"

        alert_fingerprint:
          type: string
          description: Unique alert fingerprint from Prometheus
          example: "abc123def456"

        alert_severity:
          type: string
          enum: [low, medium, high, critical]
          description: Severity level of the alert
          example: "critical"

        action_type:
          type: string
          description: Type of remediation action taken (e.g., scale, restart, check)
          example: "scale"

        action_timestamp:
          type: string
          format: date-time
          description: Timestamp when the action was executed (ISO 8601)
          example: "2025-11-02T10:30:00Z"

        namespace:
          type: string
          description: Kubernetes namespace where the action was taken
          example: "production"

        cluster_name:
          type: string
          description: Kubernetes cluster identifier
          example: "prod-us-west-2"

        environment:
          type: string
          description: Environment (e.g., production, staging, development)
          example: "production"

        target_resource:
          type: string
          description: Target Kubernetes resource (e.g., deployment/my-app)
          example: "deployment/nginx"

        remediation_request_id:
          type: string
          description: Unique remediation request identifier
          example: "req-abc-123"

        model_used:
          type: string
          description: AI model used for analysis (e.g., gpt-4, claude-3)
          example: "gpt-4"

        model_confidence:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          description: Confidence score from the AI model (0.0 to 1.0)
          example: 0.95

        execution_status:
          type: string
          enum: [pending, in_progress, completed, failed, cancelled]
          description: Current status of the remediation action
          example: "completed"

        start_time:
          type: string
          format: date-time
          description: When the remediation started (ISO 8601)
          example: "2025-11-02T10:30:00Z"

        end_time:
          type: string
          format: date-time
          description: When the remediation completed (ISO 8601)
          example: "2025-11-02T10:35:00Z"

        duration:
          type: integer
          format: int64
          description: Duration of the remediation in milliseconds
          example: 300000

        error_message:
          type: string
          description: Error message if the remediation failed
          example: "Failed to scale deployment: insufficient resources"

        metadata:
          type: string
          description: Additional metadata as JSON string
          example: "{\"replicas_before\":2,\"replicas_after\":5}"

    Pagination:
      type: object
      required:
        - total
        - limit
        - offset
        - has_more
      properties:
        total:
          type: integer
          format: int64
          description: Total number of incidents matching the filter criteria
          example: 1523

        limit:
          type: integer
          description: Maximum number of results returned in this response
          example: 100

        offset:
          type: integer
          description: Number of results skipped (pagination offset)
          example: 0

        has_more:
          type: boolean
          description: Whether there are more results available (for next page)
          example: true

    RFC7807Error:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: URI reference identifying the problem type
          example: "https://api.kubernaut.io/problems/invalid-filter"

        title:
          type: string
          description: Short, human-readable summary of the problem
          example: "Invalid Filter Parameter"

        status:
          type: integer
          description: HTTP status code
          example: 400

        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
          example: "The 'severity' filter value must be one of: low, medium, high, critical"

        instance:
          type: string
          format: uri
          description: URI reference identifying the specific occurrence of the problem
          example: "/api/v1/incidents"

  securitySchemes:
    # Future: Add authentication when needed
    # BearerAuth:
    #   type: http
    #   scheme: bearer
    #   bearerFormat: JWT

# Future: Add security when authentication is implemented
# security:
#   - BearerAuth: []


# CI/CD Coverage Report Integration Guide

## Overview

This document explains how to integrate the comprehensive coverage reporting system (unit-testable, integration, E2E, and all-tiers) into the CI/CD pipeline for PR comments.

**Business Requirement**: BR-HAPI-197 (Enhanced coverage reporting with test tier categorization)

**Related**: [Testing Coverage Methodology](../testing/TESTING_COVERAGE_METHODOLOGY.md) | [Makefile Refactoring](MAKEFILE_REFACTORING_COMPLETE.md)

---

## Current CI Coverage Reporting (PR #37)

### Current Implementation

The existing CI pipeline (`.github/workflows/ci-pipeline.yml`) collects coverage in 3 stages:

1. **Unit Tests** (Stage 1): Each service generates `coverage_unit_{service}.out`
2. **Integration Tests** (Stage 3): Each service generates `coverage_integration_{service}.out`
3. **E2E Tests** (Stage 4): Each service generates `coverage_e2e_{service}.out`

### Current PR Comment Format

```markdown
## üìä Code Coverage Report

| Service | Unit | Integration | E2E |
|---------|------|-------------|-----|
| aianalysis | 85.3% | 42.1% | N/A |
| ...
```

**Limitations**:
- Shows **raw coverage** (all code including generated, test utilities)
- No distinction between **unit-testable** vs **integration-testable** code
- No **merged "All Tiers"** column showing comprehensive coverage
- Less actionable insights (unclear what coverage gaps mean)

---

## Enhanced Coverage Reporting

### New Capabilities

The refactored coverage system (`scripts/coverage/report.sh`) now provides:

1. **Unit-Testable Coverage**: Pure business logic (config, validators, builders, formatters)
2. **Integration Coverage**: Integration code (handlers, DB adapters, K8s clients)
3. **E2E Coverage**: End-to-end workflow coverage
4. **All Tiers**: Merged coverage showing any line covered by any tier

### New PR Comment Format

```markdown
## üìä Kubernaut Coverage Report (By Test Tier)

| Service | Unit-Testable | Integration-Testable | E2E | All Tiers |
|---------|---------------|----------------------|-----|-----------|
| holmesgpt-api | 68.0% | 45.2% | 32.1% | 82.3% |
| aianalysis | 85.3% | 42.1% | 0.0% | 87.5% |
| datastorage | 41.9% | 52.7% | 0.0% | 72.8% |
| ...

### üìù Column Definitions

- **Unit-Testable**: Pure logic code (config, validators, builders, formatters, classifiers)
- **Integration-Testable**: Integration-only code (handlers, servers, DB adapters, K8s clients)
- **E2E**: End-to-end test coverage (full workflows)
- **All Tiers**: Merged coverage (any tier covering a line counts)

### üéØ Quality Targets

- Unit-Testable: ‚â•70%
- Integration-Testable: ‚â•60%
- All Tiers: ‚â•80%

---

_Generated by `make coverage-report-markdown` | See [Testing Coverage Methodology](docs/testing/TESTING_COVERAGE_METHODOLOGY.md) for details_
```

**Benefits**:
- ‚úÖ Clear categorization by code type (unit-testable vs integration)
- ‚úÖ Merged "All Tiers" shows comprehensive coverage
- ‚úÖ Quality targets provide actionable thresholds
- ‚úÖ Excludes generated code for accurate metrics
- ‚úÖ Link to detailed analysis document

---

## CI Integration Strategy

### Option A: Replace Existing Coverage Collection (Recommended)

**Pros**:
- Single source of truth
- Consistent with local development
- Uses proven AWK scripts with unit tests
- Easier maintenance

**Cons**:
- Slightly longer CI runtime (merges coverage files)

**Implementation**:

```yaml
# .github/workflows/ci-pipeline.yml

# In the final coverage summary job (currently "coverage-summary")
- name: Generate comprehensive coverage report
  if: always()
  run: |
    echo "üìä Generating comprehensive coverage report..."
    
    # Ensure all coverage files are present from artifact downloads
    ls -la coverage_*.out coverage_*.txt || true
    
    # Generate markdown report for PR comment
    make coverage-report-markdown > coverage-summary.md
    
    echo "‚úÖ Coverage report generated"

- name: Post coverage report to PR
  if: github.event_name == 'pull_request'
  uses: marocchino/sticky-pull-request-comment@v2
  with:
    header: coverage-report
    path: coverage-summary.md
```

**Changes Required**:
1. Replace the embedded bash/awk script in "Collect and analyze coverage" step (~80 lines)
2. Remove manual coverage file parsing logic
3. Add `make coverage-report-markdown` call
4. Keep existing artifact download logic (already downloads all coverage files)

---

### Option B: Parallel Collection (Keep Both)

**Pros**:
- Non-breaking change
- Can A/B test formats
- Gradual migration

**Cons**:
- Duplicate coverage logic
- More maintenance burden
- Confusing to have two coverage reports

**Implementation**:

```yaml
# Add new step AFTER existing coverage summary
- name: Generate enhanced coverage report
  if: always()
  run: make coverage-report-markdown > coverage-summary-enhanced.md

- name: Post enhanced coverage report to PR
  if: github.event_name == 'pull_request'
  uses: marocchino/sticky-pull-request-comment@v2
  with:
    header: coverage-report-enhanced  # Different header
    path: coverage-summary-enhanced.md
```

**Not recommended** unless there's a strong need for backward compatibility.

---

## Detailed Implementation (Option A)

### Step 1: Update CI Workflow

**File**: `.github/workflows/ci-pipeline.yml`

**Location**: Replace lines ~980-1090 (the "Collect and analyze coverage" step)

**Before** (embedded bash/awk):
```yaml
- name: Collect and analyze coverage
  if: always()
  run: |
    # ... 80+ lines of bash/awk coverage parsing ...
    
    # Write summary to file for PR comment
    if [ -f "$GITHUB_STEP_SUMMARY" ] && [ -s "$GITHUB_STEP_SUMMARY" ]; then
      cp "$GITHUB_STEP_SUMMARY" coverage-summary.md
    fi
```

**After** (use scripts/coverage/report.sh):
```yaml
- name: Generate comprehensive coverage report
  if: always()
  run: |
    echo "üìä Generating comprehensive coverage report..."
    
    # Debug: Show available coverage files
    echo "üîç Available coverage files:"
    ls -la coverage_*.out coverage_*.txt 2>/dev/null || echo "  No coverage files found"
    echo ""
    
    # Generate markdown report (excludes generated code, merges tiers)
    if make coverage-report-markdown > coverage-summary.md 2>&1; then
      echo "‚úÖ Coverage report generated successfully"
      echo ""
      echo "üìã Preview (first 30 lines):"
      head -n 30 coverage-summary.md | sed 's/^/  /'
    else
      echo "‚ö†Ô∏è Coverage report generation failed, creating fallback..."
      cat > coverage-summary.md <<'EOF'
## üìä Kubernaut Coverage Report

Coverage data could not be generated for this run.

**Possible causes**:
- Coverage files not uploaded from previous jobs
- AWK script errors (check job logs)
- Missing `.coverage-patterns.yaml` config

**Troubleshooting**:
1. Check unit/integration/E2E test job artifacts
2. Verify `make coverage-report-markdown` runs locally
3. See [Testing Coverage Methodology](docs/testing/TESTING_COVERAGE_METHODOLOGY.md)
EOF
    fi
    
    # Always create file (required for PR comment action)
    if [ ! -f coverage-summary.md ]; then
      echo "‚ùå ERROR: coverage-summary.md was not created"
      echo "## ‚ùå Coverage Report Unavailable" > coverage-summary.md
      exit 1
    fi
```

**Key Changes**:
- ‚úÖ Replaces ~80 lines with `make coverage-report-markdown`
- ‚úÖ Adds debug output for troubleshooting
- ‚úÖ Includes fallback error handling
- ‚úÖ Preview output shows first 30 lines

---

### Step 2: Verify Coverage File Artifacts

**Current Artifact Upload** (from unit/integration/E2E jobs):

Each test job already uploads coverage files:

```yaml
# Unit test jobs
- name: Upload unit test coverage
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: coverage-unit-${{ matrix.service }}
    path: coverage_unit_*.out
    retention-days: 7

# Integration test jobs  
- name: Upload integration coverage
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: coverage-integration-${{ matrix.service }}
    path: coverage_integration_*.out
    retention-days: 7

# E2E test jobs
- name: Upload E2E coverage
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: coverage-e2e-${{ matrix.service }}
    path: coverage_e2e_*.out
    retention-days: 7
```

**Current Artifact Download** (in coverage-summary job):

```yaml
coverage-summary:
  needs: [unit-tests, integration-tests, e2e-tests]
  if: always()
  runs-on: ubuntu-latest
  steps:
    # ... checkout, setup-go ...
    
    - name: Download all coverage artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: coverage-*
        merge-multiple: true
```

**No changes needed** - artifacts are already collected correctly.

---

### Step 3: Test Locally

Before deploying to CI:

```bash
# 1. Generate all coverage files locally
make test-tier-unit
make test-tier-integration
make test-tier-e2e  # Optional (creates Kind cluster)

# 2. Test markdown generation
make coverage-report-markdown > test-coverage.md

# 3. Verify output format
cat test-coverage.md

# Expected output:
## üìä Kubernaut Coverage Report (By Test Tier)

| Service | Unit-Testable | Integration-Testable | E2E | All Tiers |
|---------|---------------|----------------------|-----|-----------|
| holmesgpt-api | 68.0% | 45.2% | 32.1% | 82.3% |
...
```

**If issues occur**:
- Check `.coverage-patterns.yaml` exists
- Verify AWK scripts are executable: `chmod +x scripts/coverage/*.awk`
- Run `scripts/coverage/test/test_awk_scripts.sh` for unit tests
- See [Troubleshooting](#troubleshooting) section below

---

### Step 4: Deploy to CI

**Deployment Strategy**:

1. **Create feature branch**: `feature/ci-comprehensive-coverage-integration`
2. **Update workflow file**: Apply changes from Step 1
3. **Open PR**: Test on actual PR (GitHub Actions runs automatically)
4. **Verify PR comment**: Check sticky comment is updated with new format
5. **Merge**: Deploy to main after validation

**Testing Checklist**:
- [ ] Coverage files downloaded successfully (check job logs)
- [ ] `make coverage-report-markdown` runs without errors
- [ ] PR comment shows new format with 5 columns
- [ ] All services appear in table (9 services + holmesgpt-api)
- [ ] Quality targets and definitions are displayed
- [ ] Link to documentation works

---

## Troubleshooting

### Issue: "No coverage files found"

**Symptom**: CI job shows `No coverage files found` in debug output

**Cause**: Artifact download failed or coverage files not uploaded

**Fix**:
1. Check unit/integration/E2E test jobs completed successfully
2. Verify artifact upload step ran (`if: always()` ensures this)
3. Check artifact retention (7 days default)
4. Ensure `actions/download-artifact@v4` uses `pattern: coverage-*`

---

### Issue: "AWK script errors" or "Syntax error"

**Symptom**: `make coverage-report-markdown` fails with AWK errors

**Cause**: AWK scripts not found or not executable

**Fix**:
```yaml
# Add to workflow BEFORE make coverage-report-markdown
- name: Prepare coverage scripts
  run: |
    chmod +x scripts/coverage/*.awk scripts/coverage/report.sh
    ls -la scripts/coverage/
```

---

### Issue: "Coverage report shows 0.0% for all services"

**Symptom**: Report generates but all values are 0.0%

**Cause**: Coverage files empty or malformed

**Fix**:
1. Check coverage files are non-empty: `ls -lh coverage_*.out`
2. Verify `go tool cover -func` works on files
3. Check `--coverpkg` flags in Makefile test targets
4. See BR-HAPI-197 for `--coverpkg` requirements

---

### Issue: "All Tiers coverage lower than Unit-Testable"

**Symptom**: All Tiers shows 85.0%, Unit-Testable shows 90.0% (logically impossible)

**Cause**: Integration/E2E coverage files tracking test code instead of business code

**Fix**:
1. Check integration coverage file with `go tool cover -func=coverage_integration_{service}.out`
2. Look for `test/integration/{service}/` paths (should show `pkg/` and `internal/controller/` instead)
3. Update test Makefile target to use correct `--coverpkg` flag:
   ```makefile
   test-integration-aianalysis:
       go test ./test/integration/aianalysis/... \
           --coverpkg=github.com/jordigilh/kubernaut/pkg/aianalysis/...,github.com/jordigilh/kubernaut/internal/controller/aianalysis/... \
           -coverprofile=coverage_integration_aianalysis.out
   ```

---

## Rollback Plan

If issues occur in production:

### Quick Rollback (Revert to Old Format)

**File**: `.github/workflows/ci-pipeline.yml`

```yaml
# Replace new step with old embedded logic
- name: Collect and analyze coverage (LEGACY FALLBACK)
  if: always()
  run: |
    # ... restore lines from git history before this change ...
    # See: git show <previous-commit>:.github/workflows/ci-pipeline.yml
```

### Restore from Git

```bash
# Find last working commit
git log --oneline .github/workflows/ci-pipeline.yml

# Restore specific section
git show <commit-hash>:.github/workflows/ci-pipeline.yml > workflow-backup.yml

# Extract old coverage collection logic and apply
```

---

## Validation Tests

### Manual Validation

After deploying to CI, validate:

```bash
# 1. Check PR comment format
gh pr view <PR-NUMBER> --comments | grep "üìä Kubernaut Coverage Report"

# 2. Verify markdown table structure
gh api repos/jordigilh/kubernaut/pulls/<PR-NUMBER>/comments \
  | jq -r '.[] | select(.body | contains("Kubernaut Coverage Report")) | .body'

# 3. Check for all services
# Should show: holmesgpt-api, aianalysis, authwebhook, datastorage, gateway, 
#              notification, remediationorchestrator, signalprocessing, workflowexecution
```

### Automated Validation

Add CI validation step:

```yaml
- name: Validate coverage report format
  if: always()
  run: |
    # Check file exists
    test -f coverage-summary.md || { echo "‚ùå coverage-summary.md not found"; exit 1; }
    
    # Check for required sections
    grep -q "Kubernaut Coverage Report" coverage-summary.md || exit 1
    grep -q "Unit-Testable" coverage-summary.md || exit 1
    grep -q "All Tiers" coverage-summary.md || exit 1
    grep -q "Quality Targets" coverage-summary.md || exit 1
    
    # Check for all 9 services (10 rows: header + 9 services + holmesgpt-api)
    TABLE_ROWS=$(grep -c "^|" coverage-summary.md)
    if [ "$TABLE_ROWS" -lt 11 ]; then
      echo "‚ö†Ô∏è Expected 11+ table rows, found $TABLE_ROWS"
      exit 1
    fi
    
    echo "‚úÖ Coverage report format validated"
```

---

## Future Enhancements

### Diff Coverage (Show Coverage Delta)

Compare PR coverage against `main` branch:

```yaml
- name: Compare coverage with main branch
  run: |
    # Checkout main branch coverage
    git fetch origin main
    git show origin/main:coverage-summary.md > coverage-main.md
    
    # Generate diff report
    ./scripts/coverage/compare.sh coverage-main.md coverage-summary.md > coverage-diff.md
    
    # Append to PR comment
    cat coverage-diff.md >> coverage-summary.md
```

**Output**:
```markdown
### üìà Coverage Changes vs. `main`

| Service | Unit-Testable | All Tiers |
|---------|---------------|-----------|
| aianalysis | +2.3% ‚úÖ | +1.8% ‚úÖ |
| datastorage | -0.5% ‚ö†Ô∏è | +0.2% ‚úÖ |
```

---

### Coverage Thresholds (Fail on Regression)

Enforce minimum coverage in CI:

```yaml
- name: Enforce coverage thresholds
  run: |
    # Parse JSON coverage report
    make coverage-report-json > coverage.json
    
    # Check thresholds
    ./scripts/coverage/check-thresholds.sh coverage.json \
      --min-unit-testable 70 \
      --min-all-tiers 80 \
      --fail-on-regression
```

---

### Historical Coverage Trends

Store coverage in database for trend analysis:

```yaml
- name: Upload coverage to monitoring
  if: github.ref == 'refs/heads/main'
  run: |
    make coverage-report-json | \
      curl -X POST https://metrics.kubernaut.io/coverage \
        -H "Authorization: Bearer ${{ secrets.METRICS_TOKEN }}" \
        -d @-
```

**Dashboard**: Show coverage trends over time (e.g., Grafana, Datadog)

---

## References

- **PR #37**: CI Coverage Reporting Issue Fix
- **BR-HAPI-197**: Enhanced coverage reporting with test tier categorization
- **[Testing Coverage Methodology](../testing/TESTING_COVERAGE_METHODOLOGY.md)**: Detailed coverage analysis and methodology
- **[Makefile Refactoring Complete](MAKEFILE_REFACTORING_COMPLETE.md)**: Phase 1-3 refactoring documentation
- **[scripts/coverage/README.md](../../scripts/coverage/README.md)**: AWK scripts and usage guide

---

## Summary

**Integration Steps**:
1. ‚úÖ **Markdown output added**: `make coverage-report-markdown` generates PR-ready format
2. ‚è≥ **CI workflow update**: Replace embedded bash/awk with `make` call
3. ‚è≥ **Testing**: Validate on feature branch PR
4. ‚è≥ **Deployment**: Merge to main after validation

**Expected Impact**:
- **Clearer Coverage Insights**: Developers understand what code is tested vs. untested
- **Actionable Targets**: Quality thresholds provide clear goals
- **Accurate Metrics**: Excludes generated code for realistic percentages
- **Reduced Maintenance**: Single source of truth (local + CI use same scripts)

**Time Estimate**: 1-2 hours (CI update + testing + documentation)

---

**Status**: ‚úÖ Markdown generation ready | ‚è≥ CI integration pending user approval

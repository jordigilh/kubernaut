# Gas Town Formula: Integration Test Development with Full Validation
# Version: 2.1
# Purpose: APDC + TDD workflow with human checkpoints, 100% test validation, and compliance triage

formula = "integration-test-full-validation"
description = "Integration test with checkpoints, TDD, 100% test pass requirement, and comprehensive compliance triage"
version = "2.1"
author = "kubernaut-dev"
tags = ["integration-test", "apdc", "tdd", "soc2", "validation"]

# APDC ANALYSIS PHASE
[[steps]]
id = "analysis"
description = "Review test requirements from authoritative docs"
duration_estimate = "15m"
phase = "analysis"
inputs = [
    "docs/development/SOC2/*.md",
    "docs/architecture/decisions/DD-*.md",
    "test/integration/*/README.md",
    "docs/development/business-requirements/TESTING_GUIDELINES.md"
]
outputs = [
    "analysis_summary",
    "br_mapping",
    "test_scope_definition"
]

[[steps]]
id = "analysis-checkpoint"
needs = ["analysis"]
description = "üö® CHECKPOINT: Ask questions, share concerns"
requires_human_approval = true
blocking = true
timeout = "2h"
phase = "analysis"
approval_criteria = [
    "Business requirements clearly understood",
    "Test scope agreed upon",
    "No blocking questions or concerns"
]

# APDC PLAN PHASE
[[steps]]
id = "plan"
needs = ["analysis-checkpoint"]
description = "Define test structure, mock strategy, TDD approach"
duration_estimate = "20m"
phase = "plan"
outputs = [
    "test_plan",
    "mock_strategy",
    "tdd_sequence",
    "integration_points"
]

[[steps]]
id = "plan-checkpoint"
needs = ["plan"]
description = "üö® CHECKPOINT: Share plan, request approval"
requires_human_approval = true
blocking = true
timeout = "2h"
phase = "plan"
approval_criteria = [
    "Test plan is comprehensive",
    "Mock strategy follows TESTING_GUIDELINES.md",
    "TDD sequence is clear",
    "Integration points identified"
]

# APDC DO PHASE - Infrastructure Setup
[[steps]]
id = "infrastructure"
needs = ["plan-checkpoint"]
description = "Set up HAPI, verify dependencies, prepare test environment"
duration_estimate = "10m"
phase = "do"
validation_commands = [
    "make verify-holmesgpt-api",
    "docker ps | grep holmesgpt-api",
    "curl -s http://localhost:8080/health"
]

# APDC DO PHASE - TDD RED
[[steps]]
id = "do-red"
needs = ["infrastructure"]
description = "TDD RED: Write failing test (define expected behavior)"
duration_estimate = "15m"
phase = "do"
tdd_phase = "red"
success_criteria = [
    "test_compiles = true",
    "test_fails_as_expected = true",
    "no_skip_calls = true"
]

# APDC DO PHASE - TDD GREEN
[[steps]]
id = "do-green"
needs = ["do-red"]
description = "TDD GREEN: Minimal implementation to pass tests"
duration_estimate = "20m"
phase = "do"
tdd_phase = "green"
success_criteria = [
    "tests_pass = true",
    "minimal_implementation = true",
    "no_over_engineering = true"
]

# APDC DO PHASE - TDD REFACTOR
[[steps]]
id = "do-refactor"
needs = ["do-green"]
description = "TDD REFACTOR: Add edge cases, error handling, logging"
duration_estimate = "15m"
phase = "do"
tdd_phase = "refactor"
outputs = [
    "edge_case_tests",
    "error_handling_tests",
    "logging_validation"
]

# MANDATORY TEST VALIDATION GATE - NEW STEP
[[steps]]
id = "test-validation"
needs = ["do-refactor"]
description = "üß™ TEST VALIDATION: Run all tests, verify 100% pass rate"
duration_estimate = "10m"
phase = "check"
blocking = true
mandatory = true
success_criteria = [
    "all_tests_pass = true",
    "test_pass_rate = 100%",
    "no_skipped_tests = true",
    "no_failing_tests = true",
    "no_time_sleep_before_assertions = true",
    "eventually_used_correctly = true"
]
validation_commands = [
    "make test-unit",
    "make test-integration",
    "go test -v ./test/integration/... -timeout 15m",
    "grep -r 'time\\.Sleep' test/integration/ --include='*.go' && exit 1 || exit 0",
    "grep -r '\\.Skip(' test/ --include='*.go' && exit 1 || exit 0"
]
failure_handling = "block_progression"
remediation_steps = [
    "Review failing test output",
    "Fix implementation or test logic",
    "Re-run test validation",
    "Do NOT proceed until 100% pass rate achieved"
]

[[steps]]
id = "test-validation-checkpoint"
needs = ["test-validation"]
description = "üö® CHECKPOINT: Confirm all tests pass at 100% before proceeding to next day"
requires_human_approval = true
blocking = true
timeout = "2h"
phase = "check"
approval_criteria = [
    "All tests passing (no failures, no skips)",
    "Test output reviewed and validated",
    "No anti-patterns detected (time.Sleep, Skip, etc.)",
    "Ready to proceed to compliance triage"
]
rejection_actions = [
    "Return to do-refactor phase",
    "Fix failing tests",
    "Address anti-patterns",
    "Re-run test-validation"
]

# APDC CHECK PHASE - Compliance Triage
[[steps]]
id = "compliance-triage"
needs = ["test-validation-checkpoint"]
description = "üîç COMPLIANCE TRIAGE: Zero-assumptions audit vs authoritative V1.0 docs + TESTING_GUIDELINES.md"
duration_estimate = "30-45m"
phase = "check"
authoritative_sources = [
    "docs/requirements/*.md",
    "docs/architecture/decisions/DD-*.md",
    "docs/development/SOC2/*.md",
    "docs/development/business-requirements/TESTING_GUIDELINES.md",
    ".cursor/rules/*.mdc",
    "test/integration/*/README.md"
]
validation_categories = [
    "business_requirement_mapping",
    "testing_standards_compliance",
    "testing_anti_patterns_detection",
    "api_contract_alignment",
    "apdc_methodology_adherence",
    "soc2_requirements",
    "project_rules_compliance",
    "defense_in_depth_coverage"
]
anti_pattern_checks = [
    "time_sleep_before_assertions",
    "skip_calls_anywhere",
    "direct_audit_store_calls",
    "direct_metrics_method_calls",
    "podman_compose_race_conditions",
    "eventually_misuse",
    "kubeconfig_isolation_violations"
]
report_template = ".beads/templates/compliance-triage-report-v2.md"
outputs = [
    "compliance_report",
    "gap_analysis",
    "anti_pattern_findings",
    "recommendations"
]

[[steps]]
id = "compliance-checkpoint"
needs = ["compliance-triage"]
description = "üö® CHECKPOINT: Review triage report, approve or request anti-pattern fixes"
requires_human_approval = true
blocking = true
timeout = "2h"
phase = "check"
approval_criteria = [
    "No critical compliance violations",
    "Anti-patterns resolved or documented",
    "Gaps addressed or tracked",
    "SOC2 requirements met"
]
rejection_actions = [
    "Address critical violations",
    "Fix anti-patterns",
    "Close identified gaps",
    "Re-run compliance-triage"
]

# Documentation and Day Completion
[[steps]]
id = "document"
needs = ["compliance-checkpoint"]
description = "Update test plan, commit compliance report, document anti-pattern resolutions"
duration_estimate = "10m"
phase = "check"
outputs = [
    "updated_test_plan",
    "committed_compliance_report",
    "anti_pattern_resolution_docs",
    "day_summary"
]

# Formula Metadata
[metadata]
total_duration_estimate = "2.5-3.5h"
human_interaction_points = 4
blocking_checkpoints = 4
required_approvals = 4
tdd_phases = 3
quality_gates = 2

[quality_requirements]
test_pass_rate = "100%"
no_skipped_tests = true
no_anti_patterns = true
compliance_validated = true
soc2_requirements_met = true

[progression_rules]
day_completion_criteria = [
    "All tests pass at 100%",
    "Test validation checkpoint approved",
    "Compliance triage completed",
    "Compliance checkpoint approved",
    "Documentation committed"
]
block_next_day_if = [
    "test_pass_rate < 100%",
    "test_validation_checkpoint_rejected",
    "compliance_checkpoint_rejected",
    "critical_anti_patterns_detected"
]


apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Authority: DD-AUTH-008 (Secret Management Strategy)
# Purpose: Generate OAuth2-proxy cookie secrets for DataStorage and HolmesGPT API

namespace: kubernaut-system

secretGenerator:
  # DataStorage OAuth2-Proxy Cookie Secret
  # Authority: DD-AUTH-007 (OAuth2-Proxy Migration), DD-AUTH-004 (DataStorage OAuth)
  - name: data-storage-oauth-proxy-secret
    literals:
      # Generated at deployment time using openssl
      # SECURITY: This value is NOT stored in Git
      # SECURITY: kubectl executes $(openssl) on deployment machine
      - cookie-secret=$(openssl rand -base64 32)
    options:
      # Disable name suffix hash to keep stable name for Helm reference
      disableNameSuffixHash: true
    type: Opaque

  # HolmesGPT API OAuth2-Proxy Cookie Secret
  # Authority: DD-AUTH-007 (OAuth2-Proxy Migration), DD-AUTH-006 (HAPI OAuth)
  - name: holmesgpt-api-oauth-proxy-secret
    literals:
      - cookie-secret=$(openssl rand -base64 32)
    options:
      disableNameSuffixHash: true
    type: Opaque

# ========================================
# USAGE
# ========================================
#
# Deploy secrets:
#   kubectl apply -k deploy/secrets/
#
# Verify secrets:
#   kubectl get secrets -n kubernaut-system | grep oauth-proxy
#
# View secret (base64 encoded):
#   kubectl get secret data-storage-oauth-proxy-secret -n kubernaut-system -o yaml
#
# Decode secret value:
#   kubectl get secret data-storage-oauth-proxy-secret -n kubernaut-system \
#     -o jsonpath='{.data.cookie-secret}' | base64 -d
#
# ========================================
# SECURITY NOTES
# ========================================
#
# 1. Cookie Secret Requirements:
#    - MUST be 32 bytes (base64 encoded = ~44 characters)
#    - MUST be randomly generated (NOT hardcoded)
#    - MUST be kept confidential
#
# 2. Secret Lifecycle:
#    - Generated: At deployment time (kubectl apply -k)
#    - Stored: Kubernetes Secret (etcd, base64 encoded)
#    - Accessed: Only by oauth-proxy sidecar containers
#    - Rotated: Manual deletion + redeployment
#
# 3. Production Considerations:
#    - Use deploy/secrets/production/ for file-based secrets
#    - Secrets should be generated once, stored securely
#    - Consider External Secrets Operator for advanced scenarios
#
# ========================================
# INTEGRATION WITH HELM
# ========================================
#
# Helm charts reference these secrets by name:
#
#   values.yaml:
#     dataStorage:
#       oauth:
#         secretName: data-storage-oauth-proxy-secret
#
#   deployment.yaml:
#     volumes:
#       - name: oauth-proxy-cookie-secret
#         secret:
#           secretName: {{ .Values.dataStorage.oauth.secretName }}
#
# Deployment Order:
#   1. kubectl apply -k deploy/secrets/     # Create secrets
#   2. helm upgrade --install kubernaut ... # Deploy app (references secrets)
#
# Authority: DD-AUTH-008 (Separation of Concerns)
# ========================================

# ========================================
# DD-AUTH-014: DataStorage Service with Middleware-Based Auth
# No oauth-proxy sidecar - auth handled in DataStorage middleware
# ========================================
#
# Service routes external requests directly to DataStorage:
# - External clients → Service:8081 → DataStorage:8081
#
# Port Routing:
# - Service port 8081 → Pod data-storage container port 8081 (direct)
# - Metrics port 9090 → Pod data-storage container port 9090 (direct, no auth)
#
# Authentication Flow (in DataStorage middleware):
# 1. Services send requests to data-storage-service:8081 with Bearer token
# 2. Service routes directly to DataStorage container (port 8081)
# 3. DataStorage middleware validates token (TokenReview API)
# 4. DataStorage middleware checks permissions (SubjectAccessReview API)
# 5. User identity injected into request context for audit logging
# ========================================
apiVersion: v1
kind: Service
metadata:
  name: data-storage-service
  namespace: kubernaut-system
  labels:
    app: data-storage-service
    component: stateless
    tier: backend
spec:
  type: ClusterIP
  ports:
    # DD-AUTH-014: HTTP traffic routes directly to DataStorage (no proxy)
    - name: http
      port: 8081
      targetPort: http  # Routes directly to data-storage container 'http' port (8081)
      protocol: TCP
    # Metrics port routes directly to DataStorage (no authentication)
    - name: metrics
      port: 9090
      targetPort: metrics  # Routes directly to data-storage container 'metrics' port (9090)
      protocol: TCP
  selector:
    app: data-storage-service


# generated by datamodel-codegen:
#   filename:  v3.yaml
#   timestamp: 2025-11-28T23:36:13+00:00

from __future__ import annotations

from enum import StrEnum
from typing import Annotated, Any, Optional

from pydantic import AnyUrl, AwareDatetime, BaseModel, Field


class CreateWorkflowRequest(BaseModel):
    workflow_id: Annotated[str, Field(description="Unique workflow identifier")]
    version: Annotated[str, Field(description='Semantic version (e.g., "1.0.0")')]
    name: Annotated[str, Field(description="Human-readable name")]
    description: Annotated[
        str, Field(description="Description (used for embedding generation)")
    ]
    content: Annotated[
        str, Field(description="Full workflow-schema.yaml content per ADR-043")
    ]
    labels: Annotated[
        dict[str, str],
        Field(description="Workflow labels (must include signal_type and severity)"),
    ]
    container_image: Annotated[
        str,
        Field(
            description='DD-WORKFLOW-002 v2.4: OCI image pullspec with digest (MANDATORY for V1.0).\nFormat: <registry>/<repo>:<tag>@sha256:<digest> or <registry>/<repo>@sha256:<digest>\nExample: "quay.io/kubernaut/workflow-oomkill:v1.0.0@sha256:abc123..."\nThe digest portion is extracted and stored separately in container_digest.\n'
        ),
    ]
    owner: Annotated[
        Optional[str], Field(description="Team or user who owns this workflow")
    ] = None
    maintainer: Annotated[
        Optional[str], Field(description="Contact email for maintenance")
    ] = None


class DisableWorkflowRequest(BaseModel):
    reason: Annotated[
        str,
        Field(
            description="Reason for disabling the workflow (required for audit trail)"
        ),
    ]
    updated_by: Annotated[
        Optional[str], Field(description="User or service that disabled the workflow")
    ] = None


class Status(StrEnum):
    active = "active"
    disabled = "disabled"


class RemediationWorkflow(BaseModel):
    workflow_id: str
    version: str
    name: str
    description: str
    content: Annotated[str, Field(description="Full workflow-schema.yaml content")]
    content_hash: Annotated[
        Optional[str],
        Field(description="SHA-256 hash of content for integrity verification"),
    ] = None
    labels: dict[str, str]
    container_image: Annotated[
        str,
        Field(
            description='DD-WORKFLOW-002 v2.4: OCI image reference (base + optional tag).\nExample: "quay.io/kubernaut/workflow-oomkill:v1.0.0"\nFull pullspec = container_image + "@" + container_digest\n'
        ),
    ]
    container_digest: Annotated[
        str,
        Field(
            description='DD-WORKFLOW-002 v2.4: SHA256 digest for audit trail and immutability.\nExample: "sha256:abc123def456..."\n'
        ),
    ]
    owner: Optional[str] = None
    maintainer: Optional[str] = None
    status: Status
    is_latest_version: Optional[bool] = None
    parameters: Annotated[
        Optional[dict[str, Any]],
        Field(description="Extracted parameters from workflow-schema.yaml (ADR-043)"),
    ] = None
    created_at: AwareDatetime
    updated_at: Optional[AwareDatetime] = None
    disabled_at: Optional[AwareDatetime] = None
    disabled_by: Optional[str] = None
    disabled_reason: Optional[str] = None


class WorkflowVersionSummary(BaseModel):
    version: str
    status: Status
    is_latest_version: bool
    created_at: AwareDatetime


class WorkflowSearchFilters(BaseModel):
    signal_type: Annotated[
        Optional[str], Field(description="Filter by signal type (mandatory label)")
    ] = None
    severity: Annotated[
        Optional[str], Field(description="Filter by severity (mandatory label)")
    ] = None
    environment: Annotated[
        Optional[str], Field(description="Filter by environment")
    ] = None


class WorkflowSearchResult(BaseModel):
    workflow_id: str
    version: str
    name: str
    description: str
    container_image: Annotated[
        str,
        Field(
            description='DD-WORKFLOW-002 v2.4: OCI image reference (base + optional tag).\nExample: "quay.io/kubernaut/workflow-oomkill:v1.0.0"\n'
        ),
    ]
    container_digest: Annotated[
        str,
        Field(
            description='DD-WORKFLOW-002 v2.4: SHA256 digest for audit trail.\nExample: "sha256:abc123def456..."\n'
        ),
    ]
    labels: Optional[dict[str, str]] = None
    parameters: Annotated[
        Optional[dict[str, Any]],
        Field(description="Workflow parameters from ADR-043 schema"),
    ] = None
    confidence: Annotated[
        float,
        Field(description="Confidence score (V1.0 = base_similarity)", ge=0.0, le=1.0),
    ]
    rank: Annotated[int, Field(description="Rank in search results (1-based)")]


class Confidence(StrEnum):
    high = "high"
    medium = "medium"
    low = "low"
    insufficient_data = "insufficient_data"


class AIExecutionModeStats(BaseModel):
    catalog_selected: Annotated[
        int,
        Field(
            description="Number of times AI selected a single workflow from the catalog (90-95% expected per ADR-033 Hybrid Model)\n",
            examples=[135],
            ge=0,
        ),
    ]
    chained: Annotated[
        int,
        Field(
            description="Number of times AI chained multiple workflows together (4-9% expected per ADR-033 Hybrid Model)\n",
            examples=[12],
            ge=0,
        ),
    ]
    manual_escalation: Annotated[
        int,
        Field(
            description="Number of times AI escalated to human operator (<1% expected per ADR-033 Hybrid Model)\n",
            examples=[3],
            ge=0,
        ),
    ]


class WorkflowBreakdownItem(BaseModel):
    workflow_id: Annotated[
        str, Field(description="Workflow identifier", examples=["pod-oom-recovery"])
    ]
    workflow_version: Annotated[
        str, Field(description="Workflow version", examples=["v1.2"])
    ]
    executions: Annotated[
        int,
        Field(
            description="Number of times this workflow was used", examples=[120], ge=0
        ),
    ]
    success_rate: Annotated[
        float,
        Field(
            description="Success rate for this specific workflow",
            examples=[92.5],
            ge=0.0,
            le=100.0,
        ),
    ]


class QueryDimensions(BaseModel):
    incident_type: Annotated[
        Optional[str],
        Field(
            description="Incident type filter (empty if not specified)",
            examples=["pod-oom-killer"],
        ),
    ] = None
    workflow_id: Annotated[
        Optional[str],
        Field(
            description="Workflow ID filter (empty if not specified)",
            examples=["pod-oom-recovery"],
        ),
    ] = None
    workflow_version: Annotated[
        Optional[str],
        Field(
            description="Workflow version filter (empty if not specified)",
            examples=["v1.2"],
        ),
    ] = None
    action_type: Annotated[
        Optional[str],
        Field(
            description="Action type filter (empty if not specified)",
            examples=["increase_memory"],
        ),
    ] = None


class IncidentTypeBreakdownItem(BaseModel):
    incident_type: Annotated[
        str, Field(description="Incident type identifier", examples=["pod-oom-killer"])
    ]
    executions: Annotated[
        int,
        Field(
            description="Number of times this workflow was used for this incident type",
            examples=[150],
            ge=0,
        ),
    ]
    success_rate: Annotated[
        float,
        Field(
            description="Success rate for this specific incident type",
            examples=[94.0],
            ge=0.0,
            le=100.0,
        ),
    ]


class AlertSeverity(StrEnum):
    low = "low"
    medium = "medium"
    high = "high"
    critical = "critical"


class ExecutionStatus(StrEnum):
    pending = "pending"
    in_progress = "in_progress"
    completed = "completed"
    failed = "failed"
    cancelled = "cancelled"


class Incident(BaseModel):
    id: Annotated[
        int,
        Field(
            description="Unique incident identifier (from resource_action_traces table)",
            examples=[12345],
        ),
    ]
    alert_name: Annotated[
        str,
        Field(
            description="Name of the Prometheus alert or Kubernetes event",
            examples=["prod-cpu-high"],
        ),
    ]
    alert_fingerprint: Annotated[
        Optional[str],
        Field(
            description="Unique alert fingerprint from Prometheus",
            examples=["abc123def456"],
        ),
    ] = None
    alert_severity: Annotated[
        AlertSeverity,
        Field(description="Severity level of the alert", examples=["critical"]),
    ]
    action_type: Annotated[
        str,
        Field(
            description="Type of remediation action taken (e.g., scale, restart, check)",
            examples=["scale"],
        ),
    ]
    action_timestamp: Annotated[
        AwareDatetime,
        Field(
            description="Timestamp when the action was executed (ISO 8601)",
            examples=["2025-11-02T10:30:00Z"],
        ),
    ]
    namespace: Annotated[
        Optional[str],
        Field(
            description="Kubernetes namespace where the action was taken",
            examples=["production"],
        ),
    ] = None
    cluster_name: Annotated[
        Optional[str],
        Field(description="Kubernetes cluster identifier", examples=["prod-us-west-2"]),
    ] = None
    environment: Annotated[
        Optional[str],
        Field(
            description="Environment (e.g., production, staging, development)",
            examples=["production"],
        ),
    ] = None
    target_resource: Annotated[
        Optional[str],
        Field(
            description="Target Kubernetes resource (e.g., deployment/my-app)",
            examples=["deployment/nginx"],
        ),
    ] = None
    remediation_request_id: Annotated[
        Optional[str],
        Field(
            description="Unique remediation request identifier",
            examples=["req-abc-123"],
        ),
    ] = None
    model_used: Annotated[
        str,
        Field(
            description="AI model used for analysis (e.g., gpt-4, claude-3)",
            examples=["gpt-4"],
        ),
    ]
    model_confidence: Annotated[
        float,
        Field(
            description="Confidence score from the AI model (0.0 to 1.0)",
            examples=[0.95],
            ge=0.0,
            le=1.0,
        ),
    ]
    execution_status: Annotated[
        ExecutionStatus,
        Field(
            description="Current status of the remediation action",
            examples=["completed"],
        ),
    ]
    start_time: Annotated[
        Optional[AwareDatetime],
        Field(
            description="When the remediation started (ISO 8601)",
            examples=["2025-11-02T10:30:00Z"],
        ),
    ] = None
    end_time: Annotated[
        Optional[AwareDatetime],
        Field(
            description="When the remediation completed (ISO 8601)",
            examples=["2025-11-02T10:35:00Z"],
        ),
    ] = None
    duration: Annotated[
        Optional[int],
        Field(
            description="Duration of the remediation in milliseconds", examples=[300000]
        ),
    ] = None
    error_message: Annotated[
        Optional[str],
        Field(
            description="Error message if the remediation failed",
            examples=["Failed to scale deployment: insufficient resources"],
        ),
    ] = None
    metadata: Annotated[
        Optional[str],
        Field(
            description="Additional metadata as JSON string",
            examples=['{"replicas_before":2,"replicas_after":5}'],
        ),
    ] = None


class Pagination(BaseModel):
    total: Annotated[
        int,
        Field(
            description="Total number of incidents matching the filter criteria",
            examples=[1523],
        ),
    ]
    limit: Annotated[
        int,
        Field(
            description="Maximum number of results returned in this response",
            examples=[100],
        ),
    ]
    offset: Annotated[
        int,
        Field(
            description="Number of results skipped (pagination offset)", examples=[0]
        ),
    ]
    has_more: Annotated[
        bool,
        Field(
            description="Whether there are more results available (for next page)",
            examples=[True],
        ),
    ]


class RFC7807Error(BaseModel):
    type: Annotated[
        AnyUrl,
        Field(
            description="URI reference identifying the problem type",
            examples=["https://api.kubernaut.io/problems/invalid-filter"],
        ),
    ]
    title: Annotated[
        str,
        Field(
            description="Short, human-readable summary of the problem",
            examples=["Invalid Filter Parameter"],
        ),
    ]
    status: Annotated[int, Field(description="HTTP status code", examples=[400])]
    detail: Annotated[
        Optional[str],
        Field(
            description="Human-readable explanation specific to this occurrence",
            examples=[
                "The 'severity' filter value must be one of: low, medium, high, critical"
            ],
        ),
    ] = None
    instance: Annotated[
        Optional[AnyUrl],
        Field(
            description="URI reference identifying the specific occurrence of the problem",
            examples=["/api/v1/incidents"],
        ),
    ] = None


class WorkflowSearchRequest(BaseModel):
    query: Annotated[str, Field(description="Natural language search query")]
    remediation_id: Annotated[
        Optional[str], Field(description="Remediation ID for audit trail correlation")
    ] = None
    filters: Optional[WorkflowSearchFilters] = None
    top_k: Annotated[
        Optional[int],
        Field(description="Maximum number of results to return", ge=1, le=100),
    ] = 10
    min_similarity: Annotated[
        Optional[float],
        Field(description="Minimum similarity threshold", ge=0.0, le=1.0),
    ] = 0.5


class WorkflowSearchResponse(BaseModel):
    results: list[WorkflowSearchResult]
    total_found: Annotated[int, Field(description="Total number of matching workflows")]


class IncidentTypeSuccessRateResponse(BaseModel):
    incident_type: Annotated[
        str,
        Field(
            description='The incident type being analyzed (e.g., "pod-oom-killer")',
            examples=["pod-oom-killer"],
        ),
    ]
    time_range: Annotated[
        str,
        Field(
            description='Time window for this analysis (e.g., "7d")', examples=["7d"]
        ),
    ]
    total_executions: Annotated[
        int,
        Field(
            description="Total number of remediation attempts for this incident type",
            examples=[150],
            ge=0,
        ),
    ]
    successful_executions: Annotated[
        int,
        Field(
            description="Number of successful remediation attempts",
            examples=[135],
            ge=0,
        ),
    ]
    failed_executions: Annotated[
        int,
        Field(description="Number of failed remediation attempts", examples=[15], ge=0),
    ]
    success_rate: Annotated[
        float,
        Field(
            description="Success rate percentage (0-100%)",
            examples=[90.0],
            ge=0.0,
            le=100.0,
        ),
    ]
    confidence: Annotated[
        Confidence,
        Field(
            description="Confidence level based on sample size:\n- high: >=100 samples\n- medium: 20-99 samples\n- low: 5-19 samples\n- insufficient_data: <5 samples (or below min_samples threshold)\n",
            examples=["high"],
        ),
    ]
    min_samples_met: Annotated[
        bool,
        Field(
            description="Whether the minimum sample size threshold was met",
            examples=[True],
        ),
    ]
    ai_execution_mode: Annotated[
        Optional[AIExecutionModeStats],
        Field(description="Distribution of AI execution modes (ADR-033 Hybrid Model)"),
    ] = None
    workflow_breakdown: Annotated[
        Optional[list[WorkflowBreakdownItem]],
        Field(
            description="Breakdown by workflow showing which workflows were tried for this incident type"
        ),
    ] = None


class WorkflowSuccessRateResponse(BaseModel):
    workflow_id: Annotated[
        str,
        Field(
            description='The workflow identifier being analyzed (e.g., "pod-oom-recovery")',
            examples=["pod-oom-recovery"],
        ),
    ]
    workflow_version: Annotated[
        Optional[str],
        Field(
            description="Specific workflow version (null if aggregated across all versions)",
            examples=["v1.2"],
        ),
    ] = None
    time_range: Annotated[
        str,
        Field(
            description='Time window for this analysis (e.g., "7d")', examples=["7d"]
        ),
    ]
    total_executions: Annotated[
        int,
        Field(
            description="Total number of times this workflow was executed",
            examples=[200],
            ge=0,
        ),
    ]
    successful_executions: Annotated[
        int,
        Field(
            description="Number of successful workflow executions", examples=[185], ge=0
        ),
    ]
    failed_executions: Annotated[
        int,
        Field(description="Number of failed workflow executions", examples=[15], ge=0),
    ]
    success_rate: Annotated[
        float,
        Field(
            description="Success rate percentage (0-100%)",
            examples=[92.5],
            ge=0.0,
            le=100.0,
        ),
    ]
    confidence: Annotated[
        Confidence,
        Field(description="Confidence level based on sample size", examples=["high"]),
    ]
    min_samples_met: Annotated[
        bool,
        Field(
            description="Whether the minimum sample size threshold was met",
            examples=[True],
        ),
    ]
    ai_execution_mode: Annotated[
        Optional[AIExecutionModeStats],
        Field(description="Distribution of AI execution modes for this workflow"),
    ] = None
    incident_type_breakdown: Annotated[
        Optional[list[IncidentTypeBreakdownItem]],
        Field(
            description="Breakdown by incident type showing which problems this workflow solves"
        ),
    ] = None


class MultiDimensionalSuccessRateResponse(BaseModel):
    dimensions: QueryDimensions
    time_range: Annotated[
        str, Field(description="Time window for this analysis", examples=["7d"])
    ]
    total_executions: Annotated[
        int,
        Field(
            description="Total number of action executions matching the dimension filters",
            examples=[50],
            ge=0,
        ),
    ]
    successful_executions: Annotated[
        int, Field(description="Number of successful executions", examples=[45], ge=0)
    ]
    failed_executions: Annotated[
        int, Field(description="Number of failed executions", examples=[5], ge=0)
    ]
    success_rate: Annotated[
        float,
        Field(
            description="Success rate percentage (successful / total * 100)",
            examples=[90.0],
            ge=0.0,
            le=100.0,
        ),
    ]
    confidence: Annotated[
        Confidence,
        Field(
            description="Statistical confidence level based on sample size",
            examples=["medium"],
        ),
    ]
    min_samples_met: Annotated[
        bool,
        Field(
            description="Whether minimum sample size threshold was met", examples=[True]
        ),
    ]


class IncidentListResponse(BaseModel):
    data: Annotated[
        list[Incident],
        Field(description="Array of incidents matching the filter criteria"),
    ]
    pagination: Annotated[Pagination, Field(description="Pagination metadata")]

# Docker Compose for Workflow Catalog Integration Tests
# DD-TEST-001: HolmesGPT-API uses DIFFERENT ports than Data Storage's own tests
# This allows both test suites to run in parallel without port conflicts
version: '3.8'

services:
  postgres-integration:
    image: postgres:16-alpine
    container_name: kubernaut-hapi-postgres-integration
    environment:
      POSTGRES_DB: kubernaut_test
      POSTGRES_USER: kubernaut
      POSTGRES_PASSWORD: kubernaut_test_password
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "15435:5432"  # DD-TEST-001: HolmesGPT-API uses 15435 (not 15433)
    volumes:
      - hapi-postgres-integration-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kubernaut -d kubernaut_test"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - kubernaut-hapi-integration

  redis-integration:
    image: redis:7-alpine
    container_name: kubernaut-hapi-redis-integration
    ports:
      - "16381:6379"  # DD-TEST-001: HolmesGPT-API uses 16381 (not 16379)
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - kubernaut-hapi-integration

  embedding-service:
    build:
      context: ../../../embedding-service
      dockerfile: Dockerfile
    container_name: kubernaut-hapi-embedding-service-integration
    environment:
      - EMBEDDING_SERVICE_PORT=8086
      - EMBEDDING_DEVICE=cpu
      - LOG_LEVEL=INFO
    ports:
      - "18001:8086"  # DD-TEST-001: HolmesGPT-API uses 18001 (not 18000)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - kubernaut-hapi-integration

  data-storage-service:
    image: localhost/data-storage:integration
    container_name: kubernaut-hapi-data-storage-integration
    environment:
      - CONFIG_PATH=/app/config/data-storage-integration.yaml
      - EMBEDDING_SERVICE_URL=http://embedding-service:8086
    ports:
      - "18094:8080"  # DD-TEST-001: HolmesGPT-API uses 18094 (not 18090)
    volumes:
      - ./data-storage-integration.yaml:/app/config/data-storage-integration.yaml:ro
      - ./secrets/database-credentials.yaml:/app/secrets/database-credentials.yaml:ro
      - ./secrets/redis-credentials.yaml:/app/secrets/redis-credentials.yaml:ro
    depends_on:
      postgres-integration:
        condition: service_healthy
      redis-integration:
        condition: service_healthy
      embedding-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - kubernaut-hapi-integration

networks:
  kubernaut-hapi-integration:
    driver: bridge

volumes:
  hapi-postgres-integration-data:
  hapi-embedding-model-cache:

# datastorage
Data Storage Service provides REST API access to audit trail persistence.

**Business Requirements**:
- BR-STORAGE-001 to BR-STORAGE-020: Audit write API
- BR-STORAGE-021: Incident query API (READ)
- BR-STORAGE-024: RFC 7807 error responses
- BR-AUDIT-006: Legal hold capability (SOC2 Gap #8)

**Design Decisions**:
- ADR-031: OpenAPI 3.0+ specification for all stateless REST APIs
- ADR-032: Data Access Layer Isolation (only Data Storage connects to PostgreSQL)
- DD-009: Dead Letter Queue fallback on database errors
- DD-AUTH-004: OAuth-proxy sidecar for authentication/authorization
- DD-AUTH-005: Client authentication pattern (ServiceAccount tokens)

**Architecture**:
This service is the **ONLY** service that directly accesses PostgreSQL.
All other services (Context API, Effectiveness Monitor, etc.) access data
through this REST API Gateway.

**Authentication & Authorization (Production/E2E)**:
All requests to DataStorage are protected by an OAuth-proxy sidecar:

1. **Client Authentication**: Services authenticate with Kubernetes ServiceAccount tokens
   - Token mounted at: `/var/run/secrets/kubernetes.io/serviceaccount/token`
   - Clients inject: `Authorization: Bearer <token>` header
   - See DD-AUTH-005 for client implementation patterns

2. **OAuth-Proxy Validation**: The sidecar validates requests
   - Validates JWT token signature and expiration
   - Performs Subject Access Review (SAR) to check RBAC permissions
   - Injects `X-Auth-Request-User` header with authenticated user identity
   - Returns HTTP 401 if token invalid, HTTP 403 if SAR fails

3. **Handler Enforcement**: DataStorage handlers extract user identity
   - Legal hold operations REQUIRE `X-Auth-Request-User` header
   - HTTP 401 returned if header missing (authentication failed)
   - User identity stored in audit events for SOC2 compliance

**Routing Flow**:
```
Client → data-storage-service:8080 (Service)
       ↓
     oauth-proxy:8080 (validates token + SAR)
       ↓
     DataStorage:8081 (X-Auth-Request-User header)
```

**Integration Tests**:
Integration tests run without oauth-proxy. Use `testutil.NewMockUserTransport()`
to inject mock `X-Auth-Request-User` headers directly.

**SOC2 Compliance**:
- All legal hold operations attributed to authenticated users
- Audit trail captures placed_by/released_by from X-Auth-Request-User
- Unauthorized access blocked at oauth-proxy layer (defense-in-depth)


This Python package is automatically generated by the [OpenAPI Generator](https://openapi-generator.tech) project:

- API version: 1.0.0
- Package version: 1.0.0
- Build package: org.openapitools.codegen.languages.PythonClientCodegen
For more information, please visit [https://github.com/jordigilh/kubernaut](https://github.com/jordigilh/kubernaut)

## Requirements.

Python 3.7+

## Installation & Usage
### pip install

If the python package is hosted on a repository, you can install directly using:

```sh
pip install git+https://github.com/GIT_USER_ID/GIT_REPO_ID.git
```
(you may need to run `pip` with root permission: `sudo pip install git+https://github.com/GIT_USER_ID/GIT_REPO_ID.git`)

Then import the package:
```python
import datastorage
```

### Setuptools

Install via [Setuptools](http://pypi.python.org/pypi/setuptools).

```sh
python setup.py install --user
```
(or `sudo python setup.py install` to install the package for all users)

Then import the package:
```python
import datastorage
```

### Tests

Execute `pytest` to run the tests.

## Getting Started

Please follow the [installation procedure](#installation--usage) and then run the following:

```python

import time
import datastorage
from datastorage.rest import ApiException
from pprint import pprint

# Defining the host is optional and defaults to http://localhost:8080
# See configuration.py for a list of all supported configuration parameters.
configuration = datastorage.Configuration(
    host = "http://localhost:8080"
)



# Enter a context with an instance of the API client
with datastorage.ApiClient(configuration) as api_client:
    # Create an instance of the API class
    api_instance = datastorage.AuditReconstructionAPIApi(api_client)
    correlation_id = 'rr-prometheus-alert-highcpu-abc123' # str | Unique correlation ID for the remediation lifecycle

    try:
        # Reconstruct RemediationRequest from audit trail
        api_response = api_instance.reconstruct_remediation_request(correlation_id)
        print("The response of AuditReconstructionAPIApi->reconstruct_remediation_request:\n")
        pprint(api_response)
    except ApiException as e:
        print("Exception when calling AuditReconstructionAPIApi->reconstruct_remediation_request: %s\n" % e)

```

## Documentation for API Endpoints

All URIs are relative to *http://localhost:8080*

Class | Method | HTTP request | Description
------------ | ------------- | ------------- | -------------
*AuditReconstructionAPIApi* | [**reconstruct_remediation_request**](docs/AuditReconstructionAPIApi.md#reconstruct_remediation_request) | **POST** /api/v1/audit/remediation-requests/{correlation_id}/reconstruct | Reconstruct RemediationRequest from audit trail
*AuditWriteAPIApi* | [**create_audit_event**](docs/AuditWriteAPIApi.md#create_audit_event) | **POST** /api/v1/audit/events | Create unified audit event
*AuditWriteAPIApi* | [**create_audit_events_batch**](docs/AuditWriteAPIApi.md#create_audit_events_batch) | **POST** /api/v1/audit/events/batch | Create audit events batch
*AuditWriteAPIApi* | [**create_notification_audit**](docs/AuditWriteAPIApi.md#create_notification_audit) | **POST** /api/v1/audit/notifications | Create notification audit record
*AuditWriteAPIApi* | [**export_audit_events**](docs/AuditWriteAPIApi.md#export_audit_events) | **GET** /api/v1/audit/export | Export audit events with digital signature
*AuditWriteAPIApi* | [**list_legal_holds**](docs/AuditWriteAPIApi.md#list_legal_holds) | **GET** /api/v1/audit/legal-hold | List all active legal holds
*AuditWriteAPIApi* | [**place_legal_hold**](docs/AuditWriteAPIApi.md#place_legal_hold) | **POST** /api/v1/audit/legal-hold | Place legal hold on audit events
*AuditWriteAPIApi* | [**query_audit_events**](docs/AuditWriteAPIApi.md#query_audit_events) | **GET** /api/v1/audit/events | Query audit events
*AuditWriteAPIApi* | [**release_legal_hold**](docs/AuditWriteAPIApi.md#release_legal_hold) | **DELETE** /api/v1/audit/legal-hold/{correlation_id} | Release legal hold on audit events
*HealthApi* | [**health_check**](docs/HealthApi.md#health_check) | **GET** /health | Overall health check
*HealthApi* | [**liveness_check**](docs/HealthApi.md#liveness_check) | **GET** /health/live | Liveness check
*HealthApi* | [**readiness_check**](docs/HealthApi.md#readiness_check) | **GET** /health/ready | Readiness check
*MetricsApi* | [**get_metrics**](docs/MetricsApi.md#get_metrics) | **GET** /metrics | Prometheus metrics
*WorkflowCatalogAPIApi* | [**create_workflow**](docs/WorkflowCatalogAPIApi.md#create_workflow) | **POST** /api/v1/workflows | Create workflow
*WorkflowCatalogAPIApi* | [**disable_workflow**](docs/WorkflowCatalogAPIApi.md#disable_workflow) | **PATCH** /api/v1/workflows/{workflow_id}/disable | Disable workflow
*WorkflowCatalogAPIApi* | [**get_workflow_by_id**](docs/WorkflowCatalogAPIApi.md#get_workflow_by_id) | **GET** /api/v1/workflows/{workflow_id} | Get workflow by UUID
*WorkflowCatalogAPIApi* | [**list_workflows**](docs/WorkflowCatalogAPIApi.md#list_workflows) | **GET** /api/v1/workflows | List workflows
*WorkflowCatalogAPIApi* | [**search_workflows**](docs/WorkflowCatalogAPIApi.md#search_workflows) | **POST** /api/v1/workflows/search | Label-based workflow search
*WorkflowCatalogAPIApi* | [**update_workflow**](docs/WorkflowCatalogAPIApi.md#update_workflow) | **PATCH** /api/v1/workflows/{workflow_id} | Update workflow mutable fields


## Documentation For Models

 - [AIAnalysisApprovalDecisionPayload](docs/AIAnalysisApprovalDecisionPayload.md)
 - [AIAnalysisAuditPayload](docs/AIAnalysisAuditPayload.md)
 - [AIAnalysisErrorPayload](docs/AIAnalysisErrorPayload.md)
 - [AIAnalysisHolmesGPTCallPayload](docs/AIAnalysisHolmesGPTCallPayload.md)
 - [AIAnalysisPhaseTransitionPayload](docs/AIAnalysisPhaseTransitionPayload.md)
 - [AIAnalysisRegoEvaluationPayload](docs/AIAnalysisRegoEvaluationPayload.md)
 - [AsyncAcceptanceResponse](docs/AsyncAcceptanceResponse.md)
 - [AuditEvent](docs/AuditEvent.md)
 - [AuditEventRequest](docs/AuditEventRequest.md)
 - [AuditEventRequestEventData](docs/AuditEventRequestEventData.md)
 - [AuditEventResponse](docs/AuditEventResponse.md)
 - [AuditEventsQueryResponse](docs/AuditEventsQueryResponse.md)
 - [AuditEventsQueryResponsePagination](docs/AuditEventsQueryResponsePagination.md)
 - [AuditExportResponse](docs/AuditExportResponse.md)
 - [AuditExportResponseEventsInner](docs/AuditExportResponseEventsInner.md)
 - [AuditExportResponseExportMetadata](docs/AuditExportResponseExportMetadata.md)
 - [AuditExportResponseExportMetadataQueryFilters](docs/AuditExportResponseExportMetadataQueryFilters.md)
 - [AuditExportResponseHashChainVerification](docs/AuditExportResponseHashChainVerification.md)
 - [BatchAuditEventResponse](docs/BatchAuditEventResponse.md)
 - [CreateNotificationAudit202Response](docs/CreateNotificationAudit202Response.md)
 - [DetectedLabels](docs/DetectedLabels.md)
 - [ErrorDetails](docs/ErrorDetails.md)
 - [GatewayAuditPayload](docs/GatewayAuditPayload.md)
 - [HealthCheck200Response](docs/HealthCheck200Response.md)
 - [HealthCheck503Response](docs/HealthCheck503Response.md)
 - [HolmesGPTResponsePayload](docs/HolmesGPTResponsePayload.md)
 - [IncidentResponseData](docs/IncidentResponseData.md)
 - [IncidentResponseDataAlternativeWorkflowsInner](docs/IncidentResponseDataAlternativeWorkflowsInner.md)
 - [IncidentResponseDataRootCauseAnalysis](docs/IncidentResponseDataRootCauseAnalysis.md)
 - [IncidentResponseDataSelectedWorkflow](docs/IncidentResponseDataSelectedWorkflow.md)
 - [LLMRequestPayload](docs/LLMRequestPayload.md)
 - [LLMResponsePayload](docs/LLMResponsePayload.md)
 - [LLMToolCallPayload](docs/LLMToolCallPayload.md)
 - [ListLegalHolds200Response](docs/ListLegalHolds200Response.md)
 - [ListLegalHolds200ResponseHoldsInner](docs/ListLegalHolds200ResponseHoldsInner.md)
 - [MandatoryLabels](docs/MandatoryLabels.md)
 - [NotificationAudit](docs/NotificationAudit.md)
 - [NotificationAuditPayload](docs/NotificationAuditPayload.md)
 - [NotificationAuditPayloadRecipientsInner](docs/NotificationAuditPayloadRecipientsInner.md)
 - [NotificationAuditResponse](docs/NotificationAuditResponse.md)
 - [NotificationMessageAcknowledgedPayload](docs/NotificationMessageAcknowledgedPayload.md)
 - [NotificationMessageEscalatedPayload](docs/NotificationMessageEscalatedPayload.md)
 - [NotificationMessageFailedPayload](docs/NotificationMessageFailedPayload.md)
 - [NotificationMessageSentPayload](docs/NotificationMessageSentPayload.md)
 - [PlaceLegalHoldRequest](docs/PlaceLegalHoldRequest.md)
 - [ProviderResponseSummary](docs/ProviderResponseSummary.md)
 - [QueryMetadata](docs/QueryMetadata.md)
 - [RFC7807Problem](docs/RFC7807Problem.md)
 - [ReconstructionResponse](docs/ReconstructionResponse.md)
 - [ReleaseLegalHold200Response](docs/ReleaseLegalHold200Response.md)
 - [ReleaseLegalHoldRequest](docs/ReleaseLegalHoldRequest.md)
 - [RemediationApprovalAuditPayload](docs/RemediationApprovalAuditPayload.md)
 - [RemediationOrchestratorAuditPayload](docs/RemediationOrchestratorAuditPayload.md)
 - [RemediationRequestWebhookAuditPayload](docs/RemediationRequestWebhookAuditPayload.md)
 - [RemediationWorkflow](docs/RemediationWorkflow.md)
 - [ResultsMetadata](docs/ResultsMetadata.md)
 - [ScoringV1Audit](docs/ScoringV1Audit.md)
 - [SearchExecutionMetadata](docs/SearchExecutionMetadata.md)
 - [SignalProcessingAuditPayload](docs/SignalProcessingAuditPayload.md)
 - [TimeoutConfig](docs/TimeoutConfig.md)
 - [ValidationResult](docs/ValidationResult.md)
 - [WorkflowCatalogCreatedPayload](docs/WorkflowCatalogCreatedPayload.md)
 - [WorkflowCatalogUpdatedFields](docs/WorkflowCatalogUpdatedFields.md)
 - [WorkflowCatalogUpdatedPayload](docs/WorkflowCatalogUpdatedPayload.md)
 - [WorkflowDisableRequest](docs/WorkflowDisableRequest.md)
 - [WorkflowExecutionAuditPayload](docs/WorkflowExecutionAuditPayload.md)
 - [WorkflowExecutionWebhookAuditPayload](docs/WorkflowExecutionWebhookAuditPayload.md)
 - [WorkflowListResponse](docs/WorkflowListResponse.md)
 - [WorkflowResultAudit](docs/WorkflowResultAudit.md)
 - [WorkflowSearchAuditPayload](docs/WorkflowSearchAuditPayload.md)
 - [WorkflowSearchFilters](docs/WorkflowSearchFilters.md)
 - [WorkflowSearchRequest](docs/WorkflowSearchRequest.md)
 - [WorkflowSearchResponse](docs/WorkflowSearchResponse.md)
 - [WorkflowSearchResult](docs/WorkflowSearchResult.md)
 - [WorkflowUpdateRequest](docs/WorkflowUpdateRequest.md)
 - [WorkflowValidationPayload](docs/WorkflowValidationPayload.md)


<a id="documentation-for-authorization"></a>
## Documentation For Authorization

Endpoints do not require authorization.


## Author




